{"version":3,"file":"cross-frame-api.js","sources":["../src/constants/error_codes.ts","../src/CrossFrameAPI.ts"],"sourcesContent":["export type ErrorCode = {\n  [key: string]: number;\n};\n\nexport const global_errors: ErrorCode = {\n  GENERAL: 101,\n  INITIALIZATION_FAILED: 101,\n  INITIALIZED: 101,\n  TERMINATED: 101,\n  TERMINATION_FAILURE: 101,\n  TERMINATION_BEFORE_INIT: 101,\n  MULTIPLE_TERMINATION: 101,\n  RETRIEVE_BEFORE_INIT: 101,\n  RETRIEVE_AFTER_TERM: 101,\n  STORE_BEFORE_INIT: 101,\n  STORE_AFTER_TERM: 101,\n  COMMIT_BEFORE_INIT: 101,\n  COMMIT_AFTER_TERM: 101,\n  ARGUMENT_ERROR: 101,\n  CHILDREN_ERROR: 101,\n  COUNT_ERROR: 101,\n  GENERAL_GET_FAILURE: 101,\n  GENERAL_SET_FAILURE: 101,\n  GENERAL_COMMIT_FAILURE: 101,\n  UNDEFINED_DATA_MODEL: 101,\n  UNIMPLEMENTED_ELEMENT: 101,\n  VALUE_NOT_INITIALIZED: 101,\n  INVALID_SET_VALUE: 101,\n  READ_ONLY_ELEMENT: 101,\n  WRITE_ONLY_ELEMENT: 101,\n  TYPE_MISMATCH: 101,\n  VALUE_OUT_OF_RANGE: 101,\n  DEPENDENCY_NOT_ESTABLISHED: 101,\n};\n\nexport const scorm12_errors: ErrorCode = {\n  ...global_errors,\n  RETRIEVE_BEFORE_INIT: 301,\n  STORE_BEFORE_INIT: 301,\n  COMMIT_BEFORE_INIT: 301,\n  ARGUMENT_ERROR: 201,\n  CHILDREN_ERROR: 202,\n  COUNT_ERROR: 203,\n  UNDEFINED_DATA_MODEL: 401,\n  UNIMPLEMENTED_ELEMENT: 401,\n  VALUE_NOT_INITIALIZED: 301,\n  INVALID_SET_VALUE: 402,\n  READ_ONLY_ELEMENT: 403,\n  WRITE_ONLY_ELEMENT: 404,\n  TYPE_MISMATCH: 405,\n  VALUE_OUT_OF_RANGE: 407,\n  DEPENDENCY_NOT_ESTABLISHED: 408,\n};\n\nexport const scorm2004_errors: ErrorCode = {\n  ...global_errors,\n  INITIALIZATION_FAILED: 102,\n  INITIALIZED: 103,\n  TERMINATED: 104,\n  TERMINATION_FAILURE: 111,\n  TERMINATION_BEFORE_INIT: 112,\n  MULTIPLE_TERMINATION: 113,\n  MULTIPLE_TERMINATIONS: 113,\n  RETRIEVE_BEFORE_INIT: 122,\n  RETRIEVE_AFTER_TERM: 123,\n  STORE_BEFORE_INIT: 132,\n  STORE_AFTER_TERM: 133,\n  COMMIT_BEFORE_INIT: 142,\n  COMMIT_AFTER_TERM: 143,\n  ARGUMENT_ERROR: 201,\n  GENERAL_GET_FAILURE: 301,\n  GENERAL_SET_FAILURE: 351,\n  GENERAL_COMMIT_FAILURE: 391,\n  UNDEFINED_DATA_MODEL: 401,\n  UNIMPLEMENTED_ELEMENT: 402,\n  VALUE_NOT_INITIALIZED: 403,\n  READ_ONLY_ELEMENT: 404,\n  WRITE_ONLY_ELEMENT: 405,\n  TYPE_MISMATCH: 406,\n  VALUE_OUT_OF_RANGE: 407,\n  DEPENDENCY_NOT_ESTABLISHED: 408,\n};\n","// src/CrossFrameAPI.ts\nimport {\n  CrossFrameAPIOptions,\n  CrossFrameEvent,\n  CrossFrameEventCallback,\n  MessageData,\n  MessageResponse,\n} from \"./types/CrossFrame\";\nimport { global_errors } from \"./constants/error_codes\";\n\n/**\n * Pending request tracking with timestamp for cache merge protection\n */\ninterface PendingRequest {\n  resolve: (v: unknown) => void;\n  reject: (e: unknown) => void;\n  timer: ReturnType<typeof setTimeout>;\n  /**\n   * Timestamp when the request was sent, used for cache merge protection.\n   * Ensures local modifications made after the request was sent aren't overwritten\n   * by stale server responses that arrive later.\n   */\n  requestTime: number;\n  method: string; // CF-API-02: Track method name for better error reporting\n}\n\n/**\n * Client-side SCORM facade running in your content frame.\n * Returns cached values synchronously, then fires off an async\n * postMessage to the LMS frame to refresh cache and error state.\n */\nexport default class CrossFrameAPI {\n  private _cache = new Map<string, string>();\n  private _cacheTimestamps = new Map<string, number>();\n  private _lastError = \"0\";\n  private _pending = new Map<string, PendingRequest>();\n  private _counter = 0;\n  private readonly _origin: string;\n  private readonly _targetWindow: Window;\n  private readonly _timeout: number;\n  private readonly _heartbeatInterval: number;\n  private readonly _heartbeatTimeout: number;\n\n  private _destroyed = false;\n  private _connected = true;\n  private _lastHeartbeatResponse = Date.now();\n  private _heartbeatTimer: ReturnType<typeof setInterval> | undefined;\n  private _eventListeners = new Map<string, Set<CrossFrameEventCallback>>();\n  private readonly _boundOnMessage: (ev: MessageEvent) => void;\n\n  /**\n   * Type guard to validate MessageResponse structure\n   */\n  private static _isValidMessageResponse(data: unknown): data is MessageResponse {\n    if (typeof data !== \"object\" || data === null) return false;\n\n    const resp = data as Partial<MessageResponse>;\n\n    // messageId is required\n    if (typeof resp.messageId !== \"string\" || resp.messageId.length === 0) return false;\n\n    // error must have correct shape if present\n    if (resp.error !== undefined) {\n      if (typeof resp.error !== \"object\" || resp.error === null) return false;\n      const err = resp.error as Record<string, unknown>;\n      if (typeof err.message !== \"string\") return false;\n      if (err.code !== undefined && typeof err.code !== \"string\") return false;\n    }\n\n    // isHeartbeat must be boolean if present\n    if (resp.isHeartbeat !== undefined && typeof resp.isHeartbeat !== \"boolean\") return false;\n\n    return true;\n  }\n\n  /**\n   * Validates that args is an array and sanitizes it for safe use\n   */\n  private static _validateArgs(args: unknown[]): args is unknown[] {\n    if (!Array.isArray(args)) return false;\n    // Additional validation could check for specific types based on method\n    return true;\n  }\n\n  private _handler: ProxyHandler<CrossFrameAPI> = {\n    get: (target, prop, receiver) => {\n      // If it's an existing property/method, return it\n      if (typeof prop !== \"string\" || prop in target) {\n        const v = Reflect.get(target, prop, receiver);\n        return typeof v === \"function\" ? v.bind(target) : v;\n      }\n\n      // Otherwise treat prop as a SCORM call\n      const methodName = prop;\n      const isGet = methodName.endsWith(\"GetValue\");\n      const isSet = methodName.startsWith(\"LMSSet\") || methodName.endsWith(\"SetValue\");\n      const isInit = methodName === \"Initialize\" || methodName === \"LMSInitialize\";\n      const isFinish = methodName === \"Terminate\" || methodName === \"LMSFinish\";\n      const isCommit = methodName === \"Commit\" || methodName === \"LMSCommit\";\n      const isErrorString = methodName === \"GetErrorString\" || methodName === \"LMSGetErrorString\";\n      const isDiagnostic = methodName === \"GetDiagnostic\" || methodName === \"LMSGetDiagnostic\";\n\n      return (...args: unknown[]): string => {\n        // CF-API-03: Validate args is an array (TypeScript guarantees this, but runtime safety)\n        if (!CrossFrameAPI._validateArgs(args)) {\n          console.error(`CrossFrameAPI: Invalid arguments for ${methodName}`);\n          return \"\";\n        }\n\n        // Synchronous cache update for setter calls\n        if (isSet && args.length >= 2) {\n          const key = args[0] as string;\n          target._cache.set(key, String(args[1]));\n          target._cacheTimestamps.set(key, Date.now());\n          target._lastError = \"0\";\n        }\n\n        // Capture request time for cache merge protection\n        const requestTime = Date.now();\n\n        // Fire off async postMessage to refresh cache and error\n        target\n          ._post(methodName, args)\n          .then((res) => {\n            if (isGet && args.length >= 1) {\n              const key = args[0] as string;\n              // Only update if not locally modified after request was sent\n              const localModTime = target._cacheTimestamps.get(key) ?? 0;\n              if (localModTime < requestTime) {\n                target._cache.set(key, String(res));\n                target._cacheTimestamps.delete(key);\n              }\n              target._lastError = \"0\";\n            }\n            if (isErrorString && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`error_${code}`, String(res));\n            }\n            if (isDiagnostic && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`diag_${code}`, String(res));\n            }\n            if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n              target._lastError = String(res);\n            }\n          })\n          .catch((err) => target._capture(methodName, err));\n\n        // Return synchronously\n        if (isGet && args.length >= 1) {\n          return target._cache.get(args[0] as string) ?? \"\";\n        }\n        if (isErrorString && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`error_${code}`) ?? \"\";\n        }\n        if (isDiagnostic && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`diag_${code}`) ?? \"\";\n        }\n        if (isInit || isFinish || isCommit || isSet) {\n          // Immediately return \"true\"\n          const result = \"true\";\n          // Then warm cache with timestamp protection:\n          target\n            ._post(\"getFlattenedCMI\", [])\n            .then((all: unknown) => {\n              if (all && typeof all === \"object\") {\n                const entries = Object.entries(all as Record<string, string>);\n                entries.forEach(([key, val]) => {\n                  // Only update if not locally modified after request was sent\n                  const localModTime = target._cacheTimestamps.get(key) ?? 0;\n                  if (localModTime < requestTime) {\n                    target._cache.set(key, val);\n                    target._cacheTimestamps.delete(key);\n                  }\n                });\n              }\n              // reset error\n              target._lastError = \"0\";\n            })\n            .catch((err) => target._capture(\"getFlattenedCMI\", err));\n          return result;\n        }\n        if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n          return target._lastError;\n        }\n        return \"\";\n      };\n    },\n  };\n\n  /**\n   * Creates a new CrossFrameAPI instance.\n   * @param targetOrigin - Origin to send messages to. Default \"*\" sends to any origin.\n   * @param targetWindow - Window to send messages to. Default is window.parent.\n   * @param options - Configuration options\n   */\n  constructor(\n    targetOrigin: string = \"*\",\n    targetWindow: Window = window.parent,\n    options: CrossFrameAPIOptions = {},\n  ) {\n    this._origin = targetOrigin;\n    this._targetWindow = targetWindow;\n    this._timeout = options.timeout ?? 5000;\n    this._heartbeatInterval = options.heartbeatInterval ?? 30000;\n    this._heartbeatTimeout = options.heartbeatTimeout ?? 60000;\n\n    // Warn about wildcard origin security implications\n    if (targetOrigin === \"*\") {\n      console.warn(\n        \"CrossFrameAPI: Using wildcard origin ('*') allows any origin to receive messages. \" +\n          \"This is insecure for production use. \" +\n          \"Specify an explicit origin (e.g., 'https://lms.example.com') to restrict message recipients.\",\n      );\n    }\n\n    this._boundOnMessage = this._onMessage.bind(this);\n    window.addEventListener(\"message\", this._boundOnMessage);\n    this._startHeartbeat();\n\n    return new Proxy(this, this._handler);\n  }\n\n  /**\n   * Destroys this instance, removing event listeners and preventing further message processing.\n   * Once destroyed, the instance cannot be reused.\n   */\n  destroy(): void {\n    if (this._destroyed) return;\n    this._destroyed = true;\n    window.removeEventListener(\"message\", this._boundOnMessage);\n    if (this._heartbeatTimer) {\n      clearInterval(this._heartbeatTimer);\n      this._heartbeatTimer = undefined;\n    }\n    // Reject all pending requests\n    for (const pending of Array.from(this._pending.values())) {\n      clearTimeout(pending.timer);\n      pending.reject(new Error(\"CrossFrameAPI destroyed\"));\n    }\n    this._pending.clear();\n    this._cache.clear();\n    this._cacheTimestamps.clear();\n    this._eventListeners.clear();\n  }\n\n  /**\n   * Subscribes to a CrossFrame event.\n   * @param event - Event type to listen for\n   * @param callback - Function to call when event occurs\n   */\n  on(event: string, callback: CrossFrameEventCallback): void {\n    if (!this._eventListeners.has(event)) {\n      this._eventListeners.set(event, new Set());\n    }\n    this._eventListeners.get(event)?.add(callback);\n  }\n\n  /**\n   * Unsubscribes from a CrossFrame event.\n   * @param event - Event type to stop listening for\n   * @param callback - Function to remove\n   */\n  off(event: string, callback: CrossFrameEventCallback): void {\n    this._eventListeners.get(event)?.delete(callback);\n  }\n\n  /**\n   * Returns whether the connection to the LMS frame is currently active.\n   */\n  get connected(): boolean {\n    return this._connected;\n  }\n\n  /**\n   * Emits an event to all registered listeners.\n   */\n  private _emit(event: CrossFrameEvent): void {\n    this._eventListeners.get(event.type)?.forEach((cb) => cb(event));\n  }\n\n  /**\n   * Starts the heartbeat mechanism for connection detection.\n   */\n  private _startHeartbeat(): void {\n    // CF-API-01: Clear any existing heartbeat timer before starting a new one\n    if (this._heartbeatTimer) {\n      clearInterval(this._heartbeatTimer);\n    }\n\n    this._heartbeatTimer = setInterval(() => {\n      if (this._destroyed) return;\n\n      // Check if we've missed heartbeats\n      const timeSinceLastResponse = Date.now() - this._lastHeartbeatResponse;\n      if (timeSinceLastResponse > this._heartbeatTimeout && this._connected) {\n        this._connected = false;\n        this._emit({ type: \"connectionLost\" });\n      }\n\n      // Send heartbeat ping\n      this._sendHeartbeat();\n    }, this._heartbeatInterval);\n  }\n\n  /**\n   * Sends a heartbeat ping to the LMS frame.\n   */\n  private _sendHeartbeat(): void {\n    const messageId = `hb-${Date.now()}-${this._counter++}`;\n    const msg: MessageData = {\n      messageId,\n      method: \"__heartbeat__\",\n      params: [],\n      isHeartbeat: true,\n    };\n    this._targetWindow.postMessage(msg, this._origin);\n  }\n\n  /**\n   * Send a message to the LMS frame and return a promise for its response.\n   */\n  private _post(method: string, params: unknown[]): Promise<unknown> {\n    if (this._destroyed) {\n      return Promise.reject(new Error(\"CrossFrameAPI destroyed\"));\n    }\n\n    const messageId = `cfapi-${Date.now()}-${this._counter++}`;\n    const requestTime = Date.now();\n\n    // Deep-clean params of non-cloneables (e.g. functions)\n    const safeParams = params.map((p) => {\n      if (typeof p === \"function\") {\n        // DEFENSIVE CODING: Warn about non-serializable function parameters.\n        // This console.warn is intentionally kept in production builds because:\n        // 1. Functions in SCORM API params indicate a programming error by content authors\n        // 2. The warning helps diagnose integration issues during content development\n        // 3. It alerts developers to potential data loss (function becomes undefined)\n        // 4. The frequency should be very low in production (only on misconfigured content)\n        //\n        // Alternative: Could be gated by a debug flag if production console noise is a concern\n        console.warn(\"Dropping function param when posting SCORM call:\", method);\n        return undefined;\n      }\n      return p;\n    });\n\n    return new Promise((resolve, reject) => {\n      const timer = setTimeout(() => {\n        if (this._pending.has(messageId)) {\n          this._pending.delete(messageId);\n          reject(new Error(`Timeout calling ${method}`));\n        }\n      }, this._timeout);\n\n      // CF-API-02: Store method name in pending request for better error reporting\n      this._pending.set(messageId, { resolve, reject, timer, requestTime, method });\n      const msg: MessageData = { messageId, method, params: safeParams };\n      this._targetWindow.postMessage(msg, this._origin);\n    });\n  }\n\n  /**\n   * Handle incoming postMessage responses from the LMS frame.\n   */\n  private _onMessage(ev: MessageEvent): void {\n    if (this._destroyed) return;\n\n    // Validate the message origin and source unless all origins are allowed\n    if (this._origin !== \"*\" && ev.origin !== this._origin) {\n      return;\n    }\n    if (ev.source && ev.source !== this._targetWindow) {\n      return;\n    }\n\n    // CF-API-04: Validate that ev.data has the expected MessageResponse structure\n    if (!CrossFrameAPI._isValidMessageResponse(ev.data)) return;\n\n    const data = ev.data;\n\n    // Handle heartbeat response\n    if (data.isHeartbeat) {\n      this._lastHeartbeatResponse = Date.now();\n      if (!this._connected) {\n        this._connected = true;\n        this._emit({ type: \"connectionRestored\" });\n      }\n      return;\n    }\n\n    // Handle regular response\n    const pending = this._pending.get(data.messageId);\n    if (!pending) return;\n\n    clearTimeout(pending.timer);\n    this._pending.delete(data.messageId);\n\n    if (data.error) {\n      // Check if rate limited and emit event\n      // CF-API-02: Use the actual method name from the pending request\n      if (data.error.message === \"Rate limit exceeded\") {\n        this._emit({ type: \"rateLimited\", method: pending.method });\n      }\n      pending.reject(data.error);\n    } else {\n      pending.resolve(data.result);\n    }\n  }\n\n  /**\n   * Capture and cache SCORM errors.\n   */\n  private _capture(method: string, err: unknown): void {\n    let errorMessage = \"Unknown error\";\n\n    if (err instanceof Error) {\n      errorMessage = err.message;\n    } else if (typeof err === \"object\" && err !== null && \"message\" in err) {\n      errorMessage = String((err as { message: unknown }).message);\n    }\n\n    console.error(`CrossFrameAPI ${method} error:`, err);\n    // Match SCORM error codes (3 digits) from error messages\n    const match = /(?:error code|code)?\\s*(\\d{3})\\b/i.exec(errorMessage);\n    const code = match?.[1] ?? String(global_errors.GENERAL);\n    this._lastError = code;\n    this._cache.set(`error_${code}`, errorMessage);\n  }\n}\n"],"names":["global_errors","GENERAL","CrossFrameAPI","constructor","targetOrigin","targetWindow","arguments","length","undefined","window","parent","options","_cache","Map","_cacheTimestamps","_lastError","_pending","_counter","_destroyed","_connected","_lastHeartbeatResponse","Date","now","_eventListeners","_handler","get","target","prop","receiver","v","Reflect","bind","methodName","isGet","endsWith","isSet","startsWith","isInit","isFinish","isCommit","isErrorString","isDiagnostic","_len","args","Array","_key","_validateArgs","console","error","key","set","String","requestTime","_post","then","res","localModTime","delete","code","catch","err","_capture","result","all","entries","Object","forEach","_ref","val","_origin","_targetWindow","_timeout","timeout","_heartbeatInterval","heartbeatInterval","_heartbeatTimeout","heartbeatTimeout","warn","_boundOnMessage","_onMessage","addEventListener","_startHeartbeat","Proxy","_isValidMessageResponse","data","resp","messageId","message","isHeartbeat","isArray","destroy","removeEventListener","_heartbeatTimer","clearInterval","pending","from","values","clearTimeout","timer","reject","Error","clear","on","event","callback","has","Set","add","off","connected","_emit","type","cb","setInterval","timeSinceLastResponse","_sendHeartbeat","msg","method","params","postMessage","Promise","safeParams","map","p","resolve","setTimeout","ev","origin","source","errorMessage","match","exec"],"mappings":"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"}