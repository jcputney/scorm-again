{"version":3,"file":"cross-frame-facade.js","sources":["../../src/facades/CrossFrameFacade.ts"],"sourcesContent":["/**\n * CrossFrameFacade.ts\n *\n * This file implements a cross-frame facade for the scorm-again API.\n * It allows communication between frames from different domains using the postMessage API.\n */\n\nimport BaseAPI from \"../BaseAPI\";\n\n/**\n * Type for the message data\n */\nexport type MessageData = {\n  messageId: string;\n  method: string;\n  params: unknown[];\n  sab?: SharedArrayBuffer;\n};\n\n/**\n * Type for the message response\n */\nexport type MessageResponse = {\n  messageId: string;\n  result?: unknown;\n  error?: {\n    message: string;\n    stack?: string;\n  };\n  sab?: SharedArrayBuffer;\n};\n\n/**\n * Interface for the CrossFrameFacade\n */\nexport interface ICrossFrameFacade {\n  /**\n   * Initialize the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if initialization was successful\n   */\n  initialize(): Promise<boolean>;\n\n  /**\n   * Initialize the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if initialization was successful, \"false\" otherwise\n   */\n  lmsInitialize(): string;\n\n  /**\n   * Initialize the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if initialization was successful\n   */\n  Initialize(): Promise<boolean>;\n\n  /**\n   * Initialize the SCORM API (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if initialization was successful, \"false\" otherwise\n   */\n  LMSInitialize(): string;\n\n  /**\n   * Terminate the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if termination was successful\n   */\n  terminate(): Promise<boolean>;\n\n  /**\n   * Terminate the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if termination was successful, \"false\" otherwise\n   */\n  lmsFinish(): string;\n\n  /**\n   * Terminate the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if termination was successful\n   */\n  Terminate(): Promise<boolean>;\n\n  /**\n   * Terminate the SCORM API (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if termination was successful, \"false\" otherwise\n   */\n  LMSFinish(): string;\n\n  /**\n   * Get a value from the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @param element The CMI element to get\n   * @returns Promise that resolves to the value of the CMI element\n   */\n  getValue(element: string): Promise<string>;\n\n  /**\n   * Get a value from the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @param element The CMI element to get\n   * @returns The value of the CMI element\n   */\n  lmsGetValue(element: string): string;\n\n  /**\n   * Get a value from the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @param element The CMI element to get\n   * @returns Promise that resolves to the value of the CMI element\n   */\n  GetValue(element: string): Promise<string>;\n\n  /**\n   * Get a value from the SCORM API (SCORM 2004 style) - Synchronous version\n   * @param element The CMI element to get\n   * @returns The value of the CMI element\n   */\n  LMSGetValue(element: string): string;\n\n  /**\n   * Set a value in the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns Promise that resolves to true if the value was set successfully\n   */\n  setValue(element: string, value: string | number | boolean): Promise<boolean>;\n\n  /**\n   * Set a value in the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns \"true\" if the value was set successfully, \"false\" otherwise\n   */\n  lmsSetValue(element: string, value: string | number | boolean): string;\n\n  /**\n   * Set a value in the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns Promise that resolves to true if the value was set successfully\n   */\n  SetValue(element: string, value: string | number | boolean): Promise<boolean>;\n\n  /**\n   * Set a value in the SCORM API (SCORM 2004 style) - Synchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns \"true\" if the value was set successfully, \"false\" otherwise\n   */\n  LMSSetValue(element: string, value: string | number | boolean): string;\n\n  /**\n   * Commit changes to the LMS (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if the commit was successful\n   */\n  commit(): Promise<boolean>;\n\n  /**\n   * Commit changes to the LMS (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if the commit was successful, \"false\" otherwise\n   */\n  lmsCommit(): string;\n\n  /**\n   * Commit changes to the LMS (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if the commit was successful\n   */\n  Commit(): Promise<boolean>;\n\n  /**\n   * Commit changes to the LMS (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if the commit was successful, \"false\" otherwise\n   */\n  LMSCommit(): string;\n\n  /**\n   * Get the last error code (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to the last error code as a string\n   */\n  getLastError(): Promise<string>;\n\n  /**\n   * Get the last error code (SCORM 1.2 style) - Synchronous version\n   * @returns The last error code as a string\n   */\n  lmsGetLastError(): string;\n\n  /**\n   * Get the last error code (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to the last error code as a string\n   */\n  GetLastError(): Promise<string>;\n\n  /**\n   * Get the last error code (SCORM 2004 style) - Synchronous version\n   * @returns The last error code as a string\n   */\n  LMSGetLastError(): string;\n\n  /**\n   * Get the error string for an error code (SCORM 1.2 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the error string\n   */\n  getErrorString(errorCode: string | number): Promise<string>;\n\n  /**\n   * Get the error string for an error code (SCORM 1.2 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The error string\n   */\n  lmsGetErrorString(errorCode: string | number): string;\n\n  /**\n   * Get the error string for an error code (SCORM 2004 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the error string\n   */\n  GetErrorString(errorCode: string | number): Promise<string>;\n\n  /**\n   * Get the error string for an error code (SCORM 2004 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The error string\n   */\n  LMSGetErrorString(errorCode: string | number): string;\n\n  /**\n   * Get diagnostic information for an error code (SCORM 1.2 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the diagnostic information\n   */\n  getDiagnostic(errorCode: string | number): Promise<string>;\n\n  /**\n   * Get diagnostic information for an error code (SCORM 1.2 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The diagnostic information\n   */\n  lmsGetDiagnostic(errorCode: string | number): string;\n\n  /**\n   * Get diagnostic information for an error code (SCORM 2004 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the diagnostic information\n   */\n  GetDiagnostic(errorCode: string | number): Promise<string>;\n\n  /**\n   * Get diagnostic information for an error code (SCORM 2004 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The diagnostic information\n   */\n  LMSGetDiagnostic(errorCode: string | number): string;\n\n  /**\n   * Check if the API is currently initialized - Asynchronous version\n   * @returns Promise that resolves to true if the API is initialized\n   */\n  isInitialized(): Promise<boolean>;\n\n  /**\n   * Check if the API is currently initialized - Synchronous version\n   * @returns True if the API is initialized, false otherwise\n   */\n  getIsInitialized(): boolean;\n\n  /**\n   * Register an event listener\n   * @param event The event name\n   * @param callback The callback function\n   */\n  on(event: string, callback: (...args: unknown[]) => void): void;\n\n  /**\n   * Remove an event listener\n   * @param event The event name\n   * @param callback The callback function\n   */\n  off(event: string, callback: (...args: unknown[]) => void): void;\n}\n\n/**\n * Server-side facade that runs in the parent frame where the API is initialized.\n * This facade listens for messages from the client-side facade and proxies them to the actual API.\n */\nexport class CrossFrameLMS {\n  private readonly _api: BaseAPI;\n  private readonly _targetOrigin: string = \"*\";\n\n  /**\n   * Constructor\n   * @param {BaseAPI} api The API instance to use\n   * @param targetOrigin The target origin for postMessage (default: \"*\")\n   */\n  constructor(api: BaseAPI, targetOrigin?: string) {\n    this._api = api;\n\n    // Set target origin if provided\n    if (targetOrigin) {\n      this._targetOrigin = targetOrigin;\n    }\n\n    // Listen for messages from the client-side facade\n    window.addEventListener(\"message\", this._handleMessage.bind(this));\n\n    // Set up event forwarding\n    this._setupEventForwarding();\n  }\n\n  /**\n   * Handle messages from the client-side facade\n   * @param event The message event\n   */\n  private _handleMessage(event: MessageEvent) {\n    const data = event.data as MessageData;\n\n    // Ignore messages that don't have the expected format\n    if (!data || !data.messageId || !data.method) {\n      return;\n    }\n\n    // Process the message\n    this._processMessage(data, event.source as Window, event.origin);\n  }\n\n  /**\n   * Process a message from the client-side facade\n   * @param data The message data\n   * @param source The source window\n   * @param origin The origin of the message\n   */\n  private _processMessage(data: MessageData, source: Window, origin: string) {\n    const { messageId, method, params, sab } = data;\n    let result: any;\n    let error: any;\n\n    try {\n      // Call the appropriate method on the API\n      if (typeof (this._api as unknown as Record<string, Function>)[method] === \"function\") {\n        result = (this._api as unknown as Record<string, Function>)[method](...params);\n      } else {\n        throw new Error(`Method ${method} not found on API`);\n      }\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        error = {\n          message: e.message,\n          stack: e.stack,\n        };\n      } else {\n        error = {\n          message: String(e),\n        };\n      }\n    }\n\n    // Send the response back to the client-side facade\n    const response = {\n      messageId,\n      result,\n      error,\n      sab,\n    } as MessageResponse;\n\n    source.postMessage(response, this._targetOrigin, sab ? [sab] : undefined);\n  }\n\n  /**\n   * Set up event forwarding from the API to the client-side facade\n   */\n  private _setupEventForwarding() {\n    // Forward all events from the API to the client-side facades\n    this._api.on(\"*\", (event: string, ...args: any[]) => {\n      // Get all frames that might contain client-side facades\n      // We get the frames each time an event is triggered to ensure we have the latest frames\n      const frames = Array.from(document.querySelectorAll(\"iframe\"));\n\n      // Send the event to all frames\n      frames.forEach((frame) => {\n        if (frame.contentWindow) {\n          frame.contentWindow.postMessage(\n            {\n              event,\n              args,\n            },\n            this._targetOrigin,\n          );\n        }\n      });\n    });\n  }\n}\n\n/**\n * Client-side facade that runs in the child frame where the module is loaded.\n * This facade sends messages to the server-side facade and provides the same interface as the actual API.\n */\nexport class CrossFrameAPI implements ICrossFrameFacade {\n  private _targetOrigin: string = \"*\";\n  private _pendingRequests: Map<\n    string,\n    {\n      resolve: (value: unknown) => void;\n      reject: (reason?: unknown) => void;\n      source?: Window; // Source window for forwarding responses\n    }\n  > = new Map();\n  private _eventListeners: Map<string, Set<(...args: unknown[]) => void>> = new Map();\n  private _messageIdCounter: number = 0;\n  private _childFrames: Set<Window> = new Set(); // Track child frames that have sent messages\n  private _isInitialized: boolean = false;\n  private _lastError: string = \"0\";\n  private _cache: Map<string, string> = new Map(); // Cache for synchronous operations\n  private _sabBuffers: Map<string, SharedArrayBuffer> = new Map();\n\n  private _syncCall(method: string, params: any[], timeoutMs = 5000): any {\n    // In a test environment, this method might be mocked\n    // so we need to ensure it's testable\n    try {\n      const sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT);\n      const int32 = new Int32Array(sab);\n      const messageId = `${Date.now()}-sync-${this._messageIdCounter++}`;\n      // store sab for matching responses\n      this._sabBuffers.set(messageId, sab);\n      // send the call, transferring sab\n      window.parent.postMessage({ messageId, method, params, sab }, this._targetOrigin, [sab]);\n      // block until notified\n      const status = Atomics.wait(int32, 0, 0, timeoutMs);\n      // cleanup\n      this._sabBuffers.delete(messageId);\n      const pending = this._pendingRequests.get(messageId) || {};\n      this._pendingRequests.delete(messageId);\n      if (status === \"timed-out\") {\n        throw new Error(`SCORM ${method} timeout after ${timeoutMs}ms`);\n      }\n      if ((pending as any).error) throw (pending as any).error;\n      return (pending as any).result;\n    } catch (e) {\n      // If SharedArrayBuffer or Atomics are not available (e.g., in test environment)\n      // or if there's any other error, rethrow it to be handled by the caller\n      if (e instanceof Error) {\n        console.error(`Error in synchronous call to ${method}:`, e);\n        this._lastError = \"101\"; // General exception\n      } else {\n        console.error(`Unknown error in synchronous call to ${method}:`, e);\n        this._lastError = \"101\"; // General exception\n      }\n      throw e;\n    }\n  }\n\n  /**\n   * Constructor\n   * @param targetOrigin The target origin for postMessage (default: \"*\")\n   */\n  constructor(targetOrigin?: string) {\n    // Set target origin if provided\n    if (targetOrigin) {\n      this._targetOrigin = targetOrigin;\n    }\n\n    // Listen for messages from the server-side facade and child frames\n    window.addEventListener(\"message\", this._handleMessage.bind(this));\n  }\n\n  /**\n   * Handle messages from the server-side facade and child frames\n   * @param event The message event\n   */\n  private _handleMessage(event: MessageEvent) {\n    const data = event.data;\n    const source = event.source as Window;\n\n    // Check if the message is from a child frame\n    const isFromChildFrame = source !== window.parent && source !== window;\n\n    // Handle method responses from parent frame\n    if (\n      data.messageId &&\n      (data.result !== undefined || data.error !== undefined) &&\n      !isFromChildFrame\n    ) {\n      this._handleMethodResponse(data);\n    }\n\n    // Handle method requests from child frames\n    if (data.messageId && data.method && isFromChildFrame) {\n      // Add the child frame to our set of known frames\n      this._childFrames.add(source);\n\n      // Forward the message to the parent frame, but keep track of the source\n      const { messageId, method, params } = data;\n      const forwardedMessageId = `forwarded-${messageId}`;\n\n      // Store the promise callbacks with the source window\n      this._pendingRequests.set(forwardedMessageId, {\n        resolve: (result) => {\n          // Forward the result back to the child frame\n          source.postMessage(\n            {\n              messageId,\n              result,\n            },\n            this._targetOrigin,\n          );\n        },\n        reject: (error) => {\n          // Forward the error back to the child frame\n          source.postMessage(\n            {\n              messageId,\n              error,\n            },\n            this._targetOrigin,\n          );\n        },\n        source,\n      });\n\n      // Forward the message to the parent frame\n      window.parent.postMessage(\n        {\n          messageId: forwardedMessageId,\n          method,\n          params,\n        },\n        this._targetOrigin,\n      );\n\n      // Set a timeout to clean up if no response is received\n      setTimeout(() => {\n        if (this._pendingRequests.has(forwardedMessageId)) {\n          const request = this._pendingRequests.get(forwardedMessageId);\n          this._pendingRequests.delete(forwardedMessageId);\n          if (request?.source) {\n            request.source.postMessage(\n              {\n                messageId,\n                error: {\n                  message: `Timeout waiting for response to method ${method}`,\n                },\n              },\n              this._targetOrigin,\n            );\n          }\n        }\n      }, 5000);\n    }\n\n    // Handle events from parent frame\n    if (data.event && !isFromChildFrame) {\n      this._handleEvent(data.event, ...(data.args || []));\n\n      // Forward events to child frames\n      this._forwardEventToChildFrames(data.event, data.args || []);\n    }\n  }\n\n  /**\n   * Handle a method response from the server-side facade\n   * @param data The response data\n   */\n  private _handleMethodResponse(data: MessageResponse) {\n    const { messageId, result, error } = data;\n    if (data.sab) {\n      const int32 = new Int32Array(data.sab);\n      Atomics.store(int32, 0, 1);\n      Atomics.notify(int32, 0);\n    }\n    const pendingRequest = this._pendingRequests.get(messageId);\n    if (pendingRequest) {\n      const { resolve, reject } = pendingRequest;\n      if (error) {\n        reject(error);\n      } else {\n        resolve(result);\n      }\n      this._pendingRequests.delete(messageId);\n    }\n  }\n\n  /**\n   * Handle an event from the server-side facade\n   * @param event The event name\n   * @param args The event arguments\n   */\n  private _handleEvent(event: string, ...args: any[]) {\n    const listeners = this._eventListeners.get(event);\n\n    if (listeners) {\n      listeners.forEach((listener) => {\n        try {\n          listener(...args);\n        } catch (e: unknown) {\n          console.error(\"Error in event listener for %s:\", String(event), e);\n        }\n      });\n    }\n\n    // Also trigger listeners for the \"*\" event\n    const allListeners = this._eventListeners.get(\"*\");\n\n    if (allListeners) {\n      allListeners.forEach((listener) => {\n        try {\n          listener(event, ...args);\n        } catch (e: unknown) {\n          console.error('Error in \"*\" event listener for %s:', event, e);\n        }\n      });\n    }\n  }\n\n  /**\n   * Forward an event to all child frames\n   * @param event The event name\n   * @param args The event arguments\n   */\n  private _forwardEventToChildFrames(event: string, args: unknown[]) {\n    // Send the event to all child frames\n    this._childFrames.forEach((frame) => {\n      try {\n        frame.postMessage(\n          {\n            event,\n            args,\n          },\n          this._targetOrigin,\n        );\n      } catch (e: unknown) {\n        console.error(`Error forwarding event to child frame:`, e);\n      }\n    });\n  }\n\n  /**\n   * Send a message to the server-side facade\n   * @param method The method to call\n   * @param params The parameters to pass to the method\n   * @returns A promise that resolves with the result of the method call\n   */\n  private _sendMessage(\n    method: string,\n    params: (string | number | boolean)[] = [],\n  ): Promise<unknown> {\n    // In test environments, we need to handle the case where window.parent.postMessage\n    // might not be properly mocked, which can lead to unhandled promise rejections\n    if (\n      typeof window === \"undefined\" ||\n      typeof window.parent === \"undefined\" ||\n      typeof window.parent.postMessage !== \"function\"\n    ) {\n      // Return a resolved promise with an empty string in test environments\n      return Promise.resolve(\"\");\n    }\n\n    return new Promise((resolve, reject) => {\n      const messageId = `${Date.now()}-${this._messageIdCounter++}`;\n\n      // Store the promise callbacks\n      this._pendingRequests.set(messageId, { resolve, reject });\n\n      try {\n        // Send the message to the parent frame\n        window.parent.postMessage(\n          {\n            messageId,\n            method,\n            params,\n          },\n          this._targetOrigin,\n        );\n\n        // Set a timeout to reject the promise if no response is received\n        setTimeout(() => {\n          if (this._pendingRequests.has(messageId)) {\n            this._pendingRequests.delete(messageId);\n            reject(new Error(`Timeout waiting for response to method ${method}`));\n          }\n        }, 5000);\n      } catch (e) {\n        // If there's an error sending the message, clean up and reject the promise\n        this._pendingRequests.delete(messageId);\n        reject(e);\n      }\n    });\n  }\n\n  /**\n   * Initialize the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if initialization was successful\n   */\n  async initialize(): Promise<boolean> {\n    const result = await this._sendMessage(\"lmsInitialize\");\n    this._isInitialized = result === \"true\";\n    return this._isInitialized;\n  }\n\n  /**\n   * Initialize the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if initialization was successful, \"false\" otherwise\n   */\n  lmsInitialize(): string {\n    try {\n      return String(this._syncCall(\"lmsInitialize\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Initialize the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if initialization was successful\n   */\n  async Initialize(): Promise<boolean> {\n    return this.initialize();\n  }\n\n  /**\n   * Initialize the SCORM API (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if initialization was successful, \"false\" otherwise\n   */\n  LMSInitialize(): string {\n    try {\n      return String(this._syncCall(\"LMSInitialize\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Terminate the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if termination was successful\n   */\n  async terminate(): Promise<boolean> {\n    const result = await this._sendMessage(\"lmsFinish\");\n    const success = result === \"true\";\n    if (success) {\n      this._isInitialized = false;\n    }\n    return success;\n  }\n\n  /**\n   * Terminate the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if termination was successful, \"false\" otherwise\n   */\n  lmsFinish(): string {\n    try {\n      return String(this._syncCall(\"lmsFinish\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Terminate the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if termination was successful\n   */\n  async Terminate(): Promise<boolean> {\n    return this.terminate();\n  }\n\n  /**\n   * Terminate the SCORM API (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if termination was successful, \"false\" otherwise\n   */\n  LMSFinish(): string {\n    try {\n      return String(this._syncCall(\"LMSFinish\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Get a value from the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @param element The CMI element to get\n   * @returns Promise that resolves to the value of the CMI element\n   */\n  async getValue(element: string): Promise<string> {\n    try {\n      const result = await this._sendMessage(\"lmsGetValue\", [element]);\n      const value = String(result);\n      // Cache the result for synchronous operations\n      this._cache.set(element, value);\n      return value;\n    } catch (e) {\n      this._lastError = \"101\"; // General exception\n      console.error(`Error in getValue(${element}):`, e);\n      return \"\";\n    }\n  }\n\n  /**\n   * Get a value from the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @param element The CMI element to get\n   * @returns The value of the CMI element\n   */\n  lmsGetValue(element: string): string {\n    try {\n      return String(this._syncCall(\"lmsGetValue\", [element]));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"\";\n    }\n  }\n\n  /**\n   * Get a value from the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @param element The CMI element to get\n   * @returns Promise that resolves to the value of the CMI element\n   */\n  async GetValue(element: string): Promise<string> {\n    return this.getValue(element);\n  }\n\n  /**\n   * Get a value from the SCORM API (SCORM 2004 style) - Synchronous version\n   * @param element The CMI element to get\n   * @returns The value of the CMI element\n   */\n  LMSGetValue(element: string): string {\n    try {\n      return String(this._syncCall(\"LMSGetValue\", [element]));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"\";\n    }\n  }\n\n  /**\n   * Set a value in the SCORM API (SCORM 1.2 style) - Asynchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns Promise that resolves to true if the value was set successfully\n   */\n  async setValue(element: string, value: string | number | boolean): Promise<boolean> {\n    try {\n      const result = await this._sendMessage(\"lmsSetValue\", [element, value]);\n      const success = result === \"true\";\n      if (success) {\n        // Update the cache with the new value\n        this._cache.set(element, String(value));\n      }\n      return success;\n    } catch (e) {\n      this._lastError = \"101\"; // General exception\n      console.error(`Error in setValue(${element}, ${value}):`, e);\n      return false;\n    }\n  }\n\n  /**\n   * Set a value in the SCORM API (SCORM 1.2 style) - Synchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns \"true\" if the value was set successfully, \"false\" otherwise\n   */\n  lmsSetValue(element: string, value: string | number | boolean): string {\n    try {\n      return String(this._syncCall(\"lmsSetValue\", [element, value]));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Set a value in the SCORM API (SCORM 2004 style) - Asynchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns Promise that resolves to true if the value was set successfully\n   */\n  async SetValue(element: string, value: string | number | boolean): Promise<boolean> {\n    return this.setValue(element, value);\n  }\n\n  /**\n   * Set a value in the SCORM API (SCORM 2004 style) - Synchronous version\n   * @param element The CMI element to set\n   * @param value The value to set\n   * @returns \"true\" if the value was set successfully, \"false\" otherwise\n   */\n  LMSSetValue(element: string, value: string | number | boolean): string {\n    try {\n      return String(this._syncCall(\"LMSSetValue\", [element, value]));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Commit changes to the LMS (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to true if the commit was successful\n   */\n  async commit(): Promise<boolean> {\n    try {\n      const result = await this._sendMessage(\"lmsCommit\");\n      return result === \"true\";\n    } catch (e) {\n      this._lastError = \"101\"; // General exception\n      console.error(\"Error in commit:\", e);\n      return false;\n    }\n  }\n\n  /**\n   * Commit changes to the LMS (SCORM 1.2 style) - Synchronous version\n   * @returns \"true\" if the commit was successful, \"false\" otherwise\n   */\n  lmsCommit(): string {\n    try {\n      return String(this._syncCall(\"lmsCommit\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Commit changes to the LMS (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to true if the commit was successful\n   */\n  async Commit(): Promise<boolean> {\n    return this.commit();\n  }\n\n  /**\n   * Commit changes to the LMS (SCORM 2004 style) - Synchronous version\n   * @returns \"true\" if the commit was successful, \"false\" otherwise\n   */\n  LMSCommit(): string {\n    try {\n      return String(this._syncCall(\"LMSCommit\", []));\n    } catch (e) {\n      this._lastError = \"101\";\n      return \"false\";\n    }\n  }\n\n  /**\n   * Get the last error code (SCORM 1.2 style) - Asynchronous version\n   * @returns Promise that resolves to the last error code as a string\n   */\n  async getLastError(): Promise<string> {\n    try {\n      const result = await this._sendMessage(\"lmsGetLastError\");\n      this._lastError = String(result);\n      return this._lastError;\n    } catch (e) {\n      console.error(\"Error in getLastError:\", e);\n      return \"101\"; // General exception\n    }\n  }\n\n  /**\n   * Get the last error code (SCORM 1.2 style) - Synchronous version\n   * @returns The last error code as a string\n   */\n  lmsGetLastError(): string {\n    try {\n      return String(this._syncCall(\"lmsGetLastError\", []));\n    } catch (e) {\n      return \"101\";\n    }\n  }\n\n  /**\n   * Get the last error code (SCORM 2004 style) - Asynchronous version\n   * @returns Promise that resolves to the last error code as a string\n   */\n  async GetLastError(): Promise<string> {\n    return this.getLastError();\n  }\n\n  /**\n   * Get the last error code (SCORM 2004 style) - Synchronous version\n   * @returns The last error code as a string\n   */\n  LMSGetLastError(): string {\n    try {\n      return String(this._syncCall(\"LMSGetLastError\", []));\n    } catch (e) {\n      return \"101\";\n    }\n  }\n\n  /**\n   * Get the error string for an error code (SCORM 1.2 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the error string\n   */\n  async getErrorString(errorCode: string | number): Promise<string> {\n    try {\n      const result = await this._sendMessage(\"lmsGetErrorString\", [errorCode]);\n      const errorString = String(result);\n      // Cache the result for synchronous operations\n      this._cache.set(`error_${errorCode}`, errorString);\n      return errorString;\n    } catch (e) {\n      console.error(`Error in getErrorString(${errorCode}):`, e);\n      return \"\";\n    }\n  }\n\n  /**\n   * Get the error string for an error code (SCORM 1.2 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The error string\n   */\n  lmsGetErrorString(errorCode: string | number): string {\n    try {\n      return String(this._syncCall(\"lmsGetErrorString\", [errorCode]));\n    } catch (e) {\n      return \"No error\";\n    }\n  }\n\n  /**\n   * Get the error string for an error code (SCORM 2004 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the error string\n   */\n  async GetErrorString(errorCode: string | number): Promise<string> {\n    return this.getErrorString(errorCode);\n  }\n\n  /**\n   * Get the error string for an error code (SCORM 2004 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The error string\n   */\n  LMSGetErrorString(errorCode: string | number): string {\n    try {\n      return String(this._syncCall(\"LMSGetErrorString\", [errorCode]));\n    } catch (e) {\n      return \"No error\";\n    }\n  }\n\n  /**\n   * Get diagnostic information for an error code (SCORM 1.2 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the diagnostic information\n   */\n  async getDiagnostic(errorCode: string | number): Promise<string> {\n    try {\n      const result = await this._sendMessage(\"lmsGetDiagnostic\", [errorCode]);\n      const diagnostic = String(result);\n      // Cache the result for synchronous operations\n      this._cache.set(`diagnostic_${errorCode}`, diagnostic);\n      return diagnostic;\n    } catch (e) {\n      console.error(`Error in getDiagnostic(${errorCode}):`, e);\n      return \"\";\n    }\n  }\n\n  /**\n   * Get diagnostic information for an error code (SCORM 1.2 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The diagnostic information\n   */\n  lmsGetDiagnostic(errorCode: string | number): string {\n    try {\n      return String(this._syncCall(\"lmsGetDiagnostic\", [errorCode]));\n    } catch (e) {\n      return \"No diagnostic information available\";\n    }\n  }\n\n  /**\n   * Get diagnostic information for an error code (SCORM 2004 style) - Asynchronous version\n   * @param errorCode The error code\n   * @returns Promise that resolves to the diagnostic information\n   */\n  async GetDiagnostic(errorCode: string | number): Promise<string> {\n    return this.getDiagnostic(errorCode);\n  }\n\n  /**\n   * Get diagnostic information for an error code (SCORM 2004 style) - Synchronous version\n   * @param errorCode The error code\n   * @returns The diagnostic information\n   */\n  LMSGetDiagnostic(errorCode: string | number): string {\n    try {\n      return String(this._syncCall(\"LMSGetDiagnostic\", [errorCode]));\n    } catch (e) {\n      return \"No diagnostic information available\";\n    }\n  }\n\n  /**\n   * Check if the API is currently initialized - Asynchronous version\n   * @returns Promise that resolves to true if the API is initialized\n   */\n  async isInitialized(): Promise<boolean> {\n    try {\n      const result = await this._sendMessage(\"isInitialized\");\n      this._isInitialized = Boolean(result);\n      return this._isInitialized;\n    } catch (e) {\n      console.error(\"Error in isInitialized:\", e);\n      return this._isInitialized;\n    }\n  }\n\n  /**\n   * Check if the API is currently initialized - Synchronous version\n   * @returns True if the API is initialized, false otherwise\n   */\n  getIsInitialized(): boolean {\n    // In test environments, starting an async operation can cause issues\n    // with unhandled promise rejections, so we'll just return the current value\n    return this._isInitialized;\n  }\n\n  /**\n   * Register an event listener\n   * @param event The event name\n   * @param callback The callback function\n   */\n  on(event: string, callback: (...args: unknown[]) => void): void {\n    if (!this._eventListeners.has(event)) {\n      this._eventListeners.set(event, new Set());\n    }\n\n    const listeners = this._eventListeners.get(event);\n    if (listeners) {\n      listeners.add(callback);\n    }\n  }\n\n  /**\n   * Remove an event listener\n   * @param event The event name\n   * @param callback The callback function\n   */\n  off(event: string, callback: (...args: unknown[]) => void): void {\n    const listeners = this._eventListeners.get(event);\n\n    if (listeners) {\n      listeners.delete(callback);\n\n      if (listeners.size === 0) {\n        this._eventListeners.delete(event);\n      }\n    }\n  }\n}\n\n/**\n * Factory function to create a CrossFrameServer instance\n * @param {BaseAPI} api The API instance to use\n * @param targetOrigin The target origin for postMessage\n * @returns A CrossFrameServer instance\n */\nexport function createCrossFrameServer(api: BaseAPI, targetOrigin?: string): CrossFrameLMS {\n  return new CrossFrameLMS(api, targetOrigin);\n}\n\n/**\n * Factory function to create a CrossFrameClient instance\n * @param targetOrigin The target origin for postMessage\n * @returns A CrossFrameClient instance\n */\nexport function createCrossFrameClient(targetOrigin?: string): CrossFrameAPI {\n  return new CrossFrameAPI(targetOrigin);\n}\n"],"names":[],"mappings":"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"}