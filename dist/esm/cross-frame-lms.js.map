{"version":3,"file":"cross-frame-lms.js","sources":["../../src/CrossFrameLMS.ts"],"sourcesContent":["// src/CrossFrameLMS.ts\nimport { CrossFrameLMSOptions, MessageData, MessageResponse } from \"./types/CrossFrame\";\nimport { IBaseAPI } from \"./interfaces/IBaseAPI\";\n\n/**\n * Server-side SCORM adapter running in your LMS frame (lms.example.com).\n * Listens for postMessage from child (content) frames, invokes real API,\n * and posts back { messageId, result, error }.\n */\nexport default class CrossFrameLMS {\n  private readonly _api: IBaseAPI;\n  private readonly _origin: string;\n  private readonly _rateLimit: number;\n  private _requestTimes: number[] = [];\n  private _destroyed = false;\n  private readonly _boundOnMessage: (ev: MessageEvent) => void;\n\n  /**\n   * Strict allowlist of methods that can be invoked via cross-frame messages.\n   * Only SCORM API methods and internal helpers are permitted.\n   */\n  private static readonly ALLOWED_METHODS = new Set([\n    // SCORM 1.2 methods\n    \"LMSInitialize\",\n    \"LMSFinish\",\n    \"LMSGetValue\",\n    \"LMSSetValue\",\n    \"LMSCommit\",\n    \"LMSGetLastError\",\n    \"LMSGetErrorString\",\n    \"LMSGetDiagnostic\",\n    // SCORM 2004 methods\n    \"Initialize\",\n    \"Terminate\",\n    \"GetValue\",\n    \"SetValue\",\n    \"Commit\",\n    \"GetLastError\",\n    \"GetErrorString\",\n    \"GetDiagnostic\",\n    // Internal method for cache warming\n    \"getFlattenedCMI\",\n  ]);\n\n  /**\n   * Creates a new CrossFrameLMS instance.\n   * @param api - The SCORM API instance to delegate calls to\n   * @param targetOrigin - Origin to accept messages from. Default \"*\" accepts all origins.\n   * @param options - Configuration options\n   */\n  constructor(api: IBaseAPI, targetOrigin: string = \"*\", options: CrossFrameLMSOptions = {}) {\n    this._api = api;\n    this._origin = targetOrigin;\n    this._rateLimit = options.rateLimit ?? 100;\n\n    // Warn about wildcard origin security implications\n    if (targetOrigin === \"*\") {\n      console.warn(\n        \"CrossFrameLMS: Using wildcard origin ('*') allows any origin to send messages. \" +\n          \"This is insecure for production use. \" +\n          \"Specify an explicit origin (e.g., 'https://content.example.com') to restrict message sources.\",\n      );\n    }\n\n    this._boundOnMessage = this._onMessage.bind(this);\n    window.addEventListener(\"message\", this._boundOnMessage);\n  }\n\n  /**\n   * Destroys this instance, removing event listeners and preventing further message processing.\n   * Once destroyed, the instance cannot be reused.\n   */\n  destroy(): void {\n    if (this._destroyed) return;\n    this._destroyed = true;\n    window.removeEventListener(\"message\", this._boundOnMessage);\n    this._requestTimes.length = 0;\n  }\n\n  /**\n   * Checks if the rate limit has been exceeded.\n   * Uses a sliding window of 1 second.\n   * @returns true if rate limit exceeded, false otherwise\n   */\n  private _isRateLimited(): boolean {\n    const now = Date.now();\n    // Remove requests older than 1 second\n    this._requestTimes = this._requestTimes.filter((t) => now - t < 1000);\n    if (this._requestTimes.length >= this._rateLimit) {\n      return true;\n    }\n    this._requestTimes.push(now);\n    return false;\n  }\n\n  /**\n   * Type guard to validate MessageData structure\n   */\n  private static _isValidMessageData(data: unknown): data is MessageData {\n    if (typeof data !== \"object\" || data === null) return false;\n\n    const msg = data as Partial<MessageData>;\n\n    // Required fields\n    if (typeof msg.messageId !== \"string\" || msg.messageId.length === 0) return false;\n    if (typeof msg.method !== \"string\" || msg.method.length === 0) return false;\n\n    // params must be an array if present (required for apply())\n    if (msg.params !== undefined && !Array.isArray(msg.params)) return false;\n\n    // isHeartbeat must be boolean if present\n    if (msg.isHeartbeat !== undefined && typeof msg.isHeartbeat !== \"boolean\") return false;\n\n    return true;\n  }\n\n  /**\n   * Handles incoming postMessage events from child frames.\n   */\n  private _onMessage(ev: MessageEvent): void {\n    // Ignore messages if destroyed\n    if (this._destroyed) return;\n\n    // Validate the message origin unless all origins are allowed\n    if (this._origin !== \"*\" && ev.origin !== this._origin) {\n      return;\n    }\n\n    // CF-LMS-02: Validate that ev.data has the expected MessageData structure\n    if (!CrossFrameLMS._isValidMessageData(ev.data)) return;\n\n    const msg = ev.data;\n    if (!ev.source) return;\n\n    // Validate that ev.source is a Window with postMessage capability\n    // ev.source can be Window, MessagePort, ServiceWorker, or null\n    // We only handle Window sources for iframe communication\n    if (!(\"postMessage\" in ev.source)) return;\n\n    const source = ev.source as Window;\n\n    // Handle heartbeat separately (bypass rate limit and allowlist)\n    if (msg.isHeartbeat) {\n      const resp: MessageResponse = {\n        messageId: msg.messageId,\n        isHeartbeat: true,\n      };\n      source.postMessage(resp, this._origin);\n      return;\n    }\n\n    // Check rate limit\n    if (this._isRateLimited()) {\n      // SCORM ERROR CODE USAGE: Using error code \"101\" for rate limiting\n      //\n      // While not a standard SCORM error code, \"101\" is used here to signal rate limiting\n      // in cross-frame communication. Standard SCORM error codes are:\n      // - SCORM 1.2: 0, 101, 201, 202, 203, 301, 401, 402, 403, 404, 405\n      // - SCORM 2004: 0, 101, 102, 103, 201, 301, 351, 391, 401-408\n      //\n      // Using \"101\" (General Exception) is appropriate here because:\n      // 1. It indicates a general error condition without exposing security details\n      // 2. It's recognized by SCORM content as a non-zero error code\n      // 3. It doesn't conflict with specific SCORM error semantics\n      // 4. The actual error message \"Rate limit exceeded\" provides debug context\n      //\n      // The CrossFrameAPI detects this specific message to emit a \"rateLimited\" event,\n      // allowing content to react appropriately (e.g., back off, show user message).\n      const resp: MessageResponse = {\n        messageId: msg.messageId,\n        error: { message: \"Rate limit exceeded\", code: \"101\" },\n      };\n      source.postMessage(resp, this._origin);\n      return;\n    }\n\n    // Check method allowlist\n    if (!CrossFrameLMS.ALLOWED_METHODS.has(msg.method)) {\n      const resp: MessageResponse = {\n        messageId: msg.messageId,\n        error: { message: `Method not allowed: ${msg.method}`, code: \"101\" },\n      };\n      source.postMessage(resp, this._origin);\n      return;\n    }\n\n    this._process(msg, source);\n  }\n\n  /**\n   * Processes a validated message by invoking the requested API method.\n   */\n  private _process(msg: MessageData, source: Window): void {\n    const sendResponse = (result?: unknown, error?: { message: string; code?: string }) => {\n      const resp: MessageResponse = { messageId: msg.messageId };\n      if (result !== undefined) resp.result = result;\n      if (error !== undefined) resp.error = error;\n      source.postMessage(resp, this._origin);\n    };\n\n    try {\n      const fn = (this._api as unknown as Record<string, unknown>)[msg.method];\n      if (typeof fn !== \"function\") {\n        sendResponse(undefined, { message: `Method ${msg.method} not found` });\n        return;\n      }\n\n      // CF-LMS-01: Validate params is an array before apply()\n      // This should never fail due to _isValidMessageData check, but defense in depth\n      const params = Array.isArray(msg.params) ? msg.params : [];\n\n      const result = fn.apply(this._api, params);\n\n      if (result && typeof (result as Promise<unknown>).then === \"function\") {\n        (result as Promise<unknown>)\n          .then((r) => sendResponse(r))\n          .catch((e: unknown) => {\n            // ERROR CODE PRESERVATION: Extract error code from Error objects\n            // SCORM API errors may include a numeric code property for specific error conditions.\n            // We preserve this code to maintain proper error semantics across the cross-frame boundary.\n            const message = e instanceof Error ? e.message : \"Unknown error\";\n            const code =\n              e && typeof e === \"object\" && \"code\" in e && typeof e.code === \"string\"\n                ? e.code\n                : undefined;\n            const errorObj: { message: string; code?: string } = { message };\n            if (code !== undefined) {\n              errorObj.code = code;\n            }\n            sendResponse(undefined, errorObj);\n          });\n      } else {\n        sendResponse(result);\n      }\n    } catch (e: unknown) {\n      // ERROR CODE PRESERVATION: Extract error code from Error objects\n      // SCORM API errors may include a numeric code property for specific error conditions.\n      // We preserve this code to maintain proper error semantics across the cross-frame boundary.\n      const message = e instanceof Error ? e.message : \"Unknown error\";\n      const code =\n        e && typeof e === \"object\" && \"code\" in e && typeof e.code === \"string\"\n          ? e.code\n          : undefined;\n      const errorObj: { message: string; code?: string } = { message };\n      if (code !== undefined) {\n        errorObj.code = code;\n      }\n      sendResponse(undefined, errorObj);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}