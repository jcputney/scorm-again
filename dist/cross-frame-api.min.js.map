{"version":3,"file":"cross-frame-api.min.js","sources":["../src/CrossFrameAPI.ts"],"sourcesContent":["// src/CrossFrameAPI.ts\nimport { MessageData, MessageResponse } from \"./types/CrossFrame\";\nimport { global_errors } from \"./constants/error_codes\";\n\n/**\n * Client-side SCORM façade running in your content frame.\n * Returns cached/default values synchronously, then fires off an async\n * postMessage to the LMS frame to refresh cache and error state.\n */\nexport default class CrossFrameAPI {\n  private _cache = new Map<string, string>();\n  private _lastError = \"0\";\n  private _pending = new Map<\n    string,\n    {\n      resolve: (v: any) => void;\n      reject: (e: any) => void;\n      timer: ReturnType<typeof setTimeout>;\n    }\n  >();\n  private _counter = 0;\n  private readonly _origin: string;\n  private readonly _targetWindow: Window;\n\n  private _handler: ProxyHandler<CrossFrameAPI> = {\n    get: (target, prop, receiver) => {\n      // If it's an existing property/method, return it\n      if (typeof prop !== \"string\" || prop in target) {\n        const v = Reflect.get(target, prop, receiver);\n        return typeof v === \"function\" ? v.bind(target) : v;\n      }\n\n      // Otherwise treat prop as a SCORM call\n      const methodName = prop;\n      const isGet = methodName.endsWith(\"GetValue\");\n      const isSet = methodName.startsWith(\"LMSSet\") || methodName.endsWith(\"SetValue\");\n      const isInit = methodName === \"Initialize\" || methodName === \"LMSInitialize\";\n      const isFinish = methodName === \"Terminate\" || methodName === \"LMSFinish\";\n      const isCommit = methodName === \"Commit\" || methodName === \"LMSCommit\";\n      const isErrorString = methodName === \"GetErrorString\" || methodName === \"LMSGetErrorString\";\n      const isDiagnostic = methodName === \"GetDiagnostic\" || methodName === \"LMSGetDiagnostic\";\n\n      return (...args: any[]): string => {\n        // Synchronous cache update for setter calls\n        if (isSet && args.length >= 2) {\n          target._cache.set(args[0], String(args[1]));\n          target._lastError = \"0\";\n        }\n\n        // Fire off async postMessage to refresh cache and error\n        target\n          ._post(methodName, args)\n          .then((res) => {\n            if (isGet && args.length >= 1) {\n              target._cache.set(args[0], String(res));\n              target._lastError = \"0\";\n            }\n            if (isErrorString && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`error_${code}`, String(res));\n            }\n            if (isDiagnostic && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`diag_${code}`, String(res));\n            }\n            if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n              target._lastError = String(res);\n            }\n          })\n          .catch((err) => target._capture(methodName, err));\n\n        // Return synchronously\n        if (isGet && args.length >= 1) {\n          return target._cache.get(args[0]) ?? \"\";\n        }\n        if (isErrorString && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`error_${code}`) ?? \"\";\n        }\n        if (isDiagnostic && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`diag_${code}`) ?? \"\";\n        }\n        if (isInit || isFinish || isCommit || isSet) {\n          // Immediately return “true”\n          const result = \"true\";\n          // Then warm cache:\n          target\n            ._post(\"getFlattenedCMI\", [])\n            .then((all: Record<string, string>) => {\n              Object.entries(all).forEach(([key, val]) => {\n                target._cache.set(key, val);\n              });\n              // reset error\n              target._lastError = \"0\";\n            })\n            .catch((err) => target._capture(\"getFlattenedCMI\", err));\n          return result;\n        }\n        if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n          return target._lastError;\n        }\n        return \"\";\n      };\n    },\n  };\n\n  constructor(targetOrigin: string = \"*\", targetWindow: Window = window.parent) {\n    this._origin = targetOrigin;\n    this._targetWindow = targetWindow;\n    window.addEventListener(\"message\", this._onMessage.bind(this));\n    return new Proxy(this, this._handler);\n  }\n\n  /** Send a message to the LMS frame and return a promise for its response */\n  private _post(method: string, params: any[]): Promise<any> {\n    const messageId = `cfapi-${Date.now()}-${this._counter++}`;\n\n    // Deep‐clean params of non-cloneables (e.g. functions)\n    const safeParams = params.map((p) => {\n      if (typeof p === \"function\") {\n        console.warn(\"Dropping function param when posting SCORM call:\", method);\n        return undefined;\n      }\n      return p;\n    });\n\n    return new Promise((resolve, reject) => {\n      const timer = setTimeout(() => {\n        if (this._pending.has(messageId)) {\n          this._pending.delete(messageId);\n          reject(new Error(`Timeout calling ${method}`));\n        }\n      }, 5000);\n\n      this._pending.set(messageId, { resolve, reject, timer });\n      const msg: MessageData = { messageId, method, params: safeParams };\n      this._targetWindow.postMessage(msg, this._origin);\n    });\n  }\n\n  /** Handle incoming postMessage responses from the LMS frame */\n  private _onMessage(ev: MessageEvent) {\n    // Validate the message origin and source unless all origins are allowed\n    if (this._origin !== \"*\" && ev.origin !== this._origin) {\n      return;\n    }\n    if (ev.source && ev.source !== this._targetWindow) {\n      return;\n    }\n    const data = ev.data as MessageResponse;\n    if (!data?.messageId) return;\n    const pending = this._pending.get(data.messageId);\n    if (!pending) return;\n    clearTimeout(pending.timer);\n    this._pending.delete(data.messageId);\n    if (data.error) pending.reject(data.error);\n    else pending.resolve(data.result);\n  }\n\n  /** Capture and cache SCORM errors */\n  private _capture(method: string, err: any) {\n    console.error(`CrossFrameAPI ${method} error:`, err);\n    const match = /\\b(\\d{3})\\b/.exec(err.message);\n    const code = match ? match[1] : String(global_errors.GENERAL);\n    this._lastError = code as string;\n    this._cache.set(`error_${code}`, err.message);\n  }\n}\n"],"names":["constructor","targetOrigin","arguments","length","undefined","targetWindow","window","parent","this","_cache","Map","_lastError","_pending","_counter","_handler","get","target","prop","receiver","v","Reflect","bind","methodName","isGet","endsWith","isSet","startsWith","isInit","isFinish","isCommit","isErrorString","isDiagnostic","_len","args","Array","_key","set","String","_post","then","res","catch","err","_capture","result","all","Object","entries","forEach","_ref","key","val","_origin","_targetWindow","addEventListener","_onMessage","Proxy","method","params","messageId","Date","now","safeParams","map","p","console","warn","Promise","resolve","reject","timer","setTimeout","has","delete","Error","postMessage","ev","origin","source","data","pending","clearTimeout","error","match","exec","message","code"],"mappings":"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"}