{"version":3,"file":"cross-frame-api.min.js","sources":["../src/CrossFrameAPI.ts"],"sourcesContent":["// src/CrossFrameAPI.ts\nimport {\n  CrossFrameAPIOptions,\n  CrossFrameEvent,\n  CrossFrameEventCallback,\n  MessageData,\n  MessageResponse,\n} from \"./types/CrossFrame\";\nimport { global_errors } from \"./constants/error_codes\";\n\n/**\n * Pending request tracking with timestamp for cache merge protection\n */\ninterface PendingRequest {\n  resolve: (v: unknown) => void;\n  reject: (e: unknown) => void;\n  timer: ReturnType<typeof setTimeout>;\n  /**\n   * Timestamp when the request was sent, used for cache merge protection.\n   * Ensures local modifications made after the request was sent aren't overwritten\n   * by stale server responses that arrive later.\n   */\n  requestTime: number;\n  method: string; // CF-API-02: Track method name for better error reporting\n}\n\n/**\n * Client-side SCORM facade running in your content frame.\n * Returns cached values synchronously, then fires off an async\n * postMessage to the LMS frame to refresh cache and error state.\n */\nexport default class CrossFrameAPI {\n  private _cache = new Map<string, string>();\n  private _cacheTimestamps = new Map<string, number>();\n  private _lastError = \"0\";\n  private _pending = new Map<string, PendingRequest>();\n  private _counter = 0;\n  private readonly _origin: string;\n  private readonly _targetWindow: Window;\n  private readonly _timeout: number;\n  private readonly _heartbeatInterval: number;\n  private readonly _heartbeatTimeout: number;\n\n  private _destroyed = false;\n  private _connected = true;\n  private _lastHeartbeatResponse = Date.now();\n  private _heartbeatTimer: ReturnType<typeof setInterval> | undefined;\n  private _eventListeners = new Map<string, Set<CrossFrameEventCallback>>();\n  private readonly _boundOnMessage: (ev: MessageEvent) => void;\n\n  /**\n   * Type guard to validate MessageResponse structure\n   */\n  private static _isValidMessageResponse(data: unknown): data is MessageResponse {\n    if (typeof data !== \"object\" || data === null) return false;\n\n    const resp = data as Partial<MessageResponse>;\n\n    // messageId is required\n    if (typeof resp.messageId !== \"string\" || resp.messageId.length === 0) return false;\n\n    // error must have correct shape if present\n    if (resp.error !== undefined) {\n      if (typeof resp.error !== \"object\" || resp.error === null) return false;\n      const err = resp.error as Record<string, unknown>;\n      if (typeof err.message !== \"string\") return false;\n      if (err.code !== undefined && typeof err.code !== \"string\") return false;\n    }\n\n    // isHeartbeat must be boolean if present\n    if (resp.isHeartbeat !== undefined && typeof resp.isHeartbeat !== \"boolean\") return false;\n\n    return true;\n  }\n\n  /**\n   * Validates that args is an array and sanitizes it for safe use\n   */\n  private static _validateArgs(args: unknown[]): args is unknown[] {\n    if (!Array.isArray(args)) return false;\n    // Additional validation could check for specific types based on method\n    return true;\n  }\n\n  private _handler: ProxyHandler<CrossFrameAPI> = {\n    get: (target, prop, receiver) => {\n      // If it's an existing property/method, return it\n      if (typeof prop !== \"string\" || prop in target) {\n        const v = Reflect.get(target, prop, receiver);\n        return typeof v === \"function\" ? v.bind(target) : v;\n      }\n\n      // Otherwise treat prop as a SCORM call\n      const methodName = prop;\n      const isGet = methodName.endsWith(\"GetValue\");\n      const isSet = methodName.startsWith(\"LMSSet\") || methodName.endsWith(\"SetValue\");\n      const isInit = methodName === \"Initialize\" || methodName === \"LMSInitialize\";\n      const isFinish = methodName === \"Terminate\" || methodName === \"LMSFinish\";\n      const isCommit = methodName === \"Commit\" || methodName === \"LMSCommit\";\n      const isErrorString = methodName === \"GetErrorString\" || methodName === \"LMSGetErrorString\";\n      const isDiagnostic = methodName === \"GetDiagnostic\" || methodName === \"LMSGetDiagnostic\";\n\n      return (...args: unknown[]): string => {\n        // CF-API-03: Validate args is an array (TypeScript guarantees this, but runtime safety)\n        if (!CrossFrameAPI._validateArgs(args)) {\n          console.error(`CrossFrameAPI: Invalid arguments for ${methodName}`);\n          return \"\";\n        }\n\n        // Synchronous cache update for setter calls\n        if (isSet && args.length >= 2) {\n          const key = args[0] as string;\n          target._cache.set(key, String(args[1]));\n          target._cacheTimestamps.set(key, Date.now());\n          target._lastError = \"0\";\n        }\n\n        // Capture request time for cache merge protection\n        const requestTime = Date.now();\n\n        // Fire off async postMessage to refresh cache and error\n        target\n          ._post(methodName, args)\n          .then((res) => {\n            if (isGet && args.length >= 1) {\n              const key = args[0] as string;\n              // Only update if not locally modified after request was sent\n              const localModTime = target._cacheTimestamps.get(key) ?? 0;\n              if (localModTime < requestTime) {\n                target._cache.set(key, String(res));\n                target._cacheTimestamps.delete(key);\n              }\n              target._lastError = \"0\";\n            }\n            if (isErrorString && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`error_${code}`, String(res));\n            }\n            if (isDiagnostic && args.length >= 1) {\n              const code = String(args[0]);\n              target._cache.set(`diag_${code}`, String(res));\n            }\n            if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n              target._lastError = String(res);\n            }\n          })\n          .catch((err) => target._capture(methodName, err));\n\n        // Return synchronously\n        if (isGet && args.length >= 1) {\n          return target._cache.get(args[0] as string) ?? \"\";\n        }\n        if (isErrorString && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`error_${code}`) ?? \"\";\n        }\n        if (isDiagnostic && args.length >= 1) {\n          const code = String(args[0]);\n          return target._cache.get(`diag_${code}`) ?? \"\";\n        }\n        if (isInit || isFinish || isCommit || isSet) {\n          // Immediately return \"true\"\n          const result = \"true\";\n          // Then warm cache with timestamp protection:\n          target\n            ._post(\"getFlattenedCMI\", [])\n            .then((all: unknown) => {\n              if (all && typeof all === \"object\") {\n                const entries = Object.entries(all as Record<string, string>);\n                entries.forEach(([key, val]) => {\n                  // Only update if not locally modified after request was sent\n                  const localModTime = target._cacheTimestamps.get(key) ?? 0;\n                  if (localModTime < requestTime) {\n                    target._cache.set(key, val);\n                    target._cacheTimestamps.delete(key);\n                  }\n                });\n              }\n              // reset error\n              target._lastError = \"0\";\n            })\n            .catch((err) => target._capture(\"getFlattenedCMI\", err));\n          return result;\n        }\n        if (methodName === \"GetLastError\" || methodName === \"LMSGetLastError\") {\n          return target._lastError;\n        }\n        return \"\";\n      };\n    },\n  };\n\n  /**\n   * Creates a new CrossFrameAPI instance.\n   * @param targetOrigin - Origin to send messages to. Default \"*\" sends to any origin.\n   * @param targetWindow - Window to send messages to. Default is window.parent.\n   * @param options - Configuration options\n   */\n  constructor(\n    targetOrigin: string = \"*\",\n    targetWindow: Window = window.parent,\n    options: CrossFrameAPIOptions = {},\n  ) {\n    this._origin = targetOrigin;\n    this._targetWindow = targetWindow;\n    this._timeout = options.timeout ?? 5000;\n    this._heartbeatInterval = options.heartbeatInterval ?? 30000;\n    this._heartbeatTimeout = options.heartbeatTimeout ?? 60000;\n\n    // Warn about wildcard origin security implications\n    if (targetOrigin === \"*\") {\n      console.warn(\n        \"CrossFrameAPI: Using wildcard origin ('*') allows any origin to receive messages. \" +\n          \"This is insecure for production use. \" +\n          \"Specify an explicit origin (e.g., 'https://lms.example.com') to restrict message recipients.\",\n      );\n    }\n\n    this._boundOnMessage = this._onMessage.bind(this);\n    window.addEventListener(\"message\", this._boundOnMessage);\n    this._startHeartbeat();\n\n    return new Proxy(this, this._handler);\n  }\n\n  /**\n   * Destroys this instance, removing event listeners and preventing further message processing.\n   * Once destroyed, the instance cannot be reused.\n   */\n  destroy(): void {\n    if (this._destroyed) return;\n    this._destroyed = true;\n    window.removeEventListener(\"message\", this._boundOnMessage);\n    if (this._heartbeatTimer) {\n      clearInterval(this._heartbeatTimer);\n      this._heartbeatTimer = undefined;\n    }\n    // Reject all pending requests\n    for (const pending of Array.from(this._pending.values())) {\n      clearTimeout(pending.timer);\n      pending.reject(new Error(\"CrossFrameAPI destroyed\"));\n    }\n    this._pending.clear();\n    this._cache.clear();\n    this._cacheTimestamps.clear();\n    this._eventListeners.clear();\n  }\n\n  /**\n   * Subscribes to a CrossFrame event.\n   * @param event - Event type to listen for\n   * @param callback - Function to call when event occurs\n   */\n  on(event: string, callback: CrossFrameEventCallback): void {\n    if (!this._eventListeners.has(event)) {\n      this._eventListeners.set(event, new Set());\n    }\n    this._eventListeners.get(event)?.add(callback);\n  }\n\n  /**\n   * Unsubscribes from a CrossFrame event.\n   * @param event - Event type to stop listening for\n   * @param callback - Function to remove\n   */\n  off(event: string, callback: CrossFrameEventCallback): void {\n    this._eventListeners.get(event)?.delete(callback);\n  }\n\n  /**\n   * Returns whether the connection to the LMS frame is currently active.\n   */\n  get connected(): boolean {\n    return this._connected;\n  }\n\n  /**\n   * Emits an event to all registered listeners.\n   */\n  private _emit(event: CrossFrameEvent): void {\n    this._eventListeners.get(event.type)?.forEach((cb) => cb(event));\n  }\n\n  /**\n   * Starts the heartbeat mechanism for connection detection.\n   */\n  private _startHeartbeat(): void {\n    // CF-API-01: Clear any existing heartbeat timer before starting a new one\n    if (this._heartbeatTimer) {\n      clearInterval(this._heartbeatTimer);\n    }\n\n    this._heartbeatTimer = setInterval(() => {\n      if (this._destroyed) return;\n\n      // Check if we've missed heartbeats\n      const timeSinceLastResponse = Date.now() - this._lastHeartbeatResponse;\n      if (timeSinceLastResponse > this._heartbeatTimeout && this._connected) {\n        this._connected = false;\n        this._emit({ type: \"connectionLost\" });\n      }\n\n      // Send heartbeat ping\n      this._sendHeartbeat();\n    }, this._heartbeatInterval);\n  }\n\n  /**\n   * Sends a heartbeat ping to the LMS frame.\n   */\n  private _sendHeartbeat(): void {\n    const messageId = `hb-${Date.now()}-${this._counter++}`;\n    const msg: MessageData = {\n      messageId,\n      method: \"__heartbeat__\",\n      params: [],\n      isHeartbeat: true,\n    };\n    this._targetWindow.postMessage(msg, this._origin);\n  }\n\n  /**\n   * Send a message to the LMS frame and return a promise for its response.\n   */\n  private _post(method: string, params: unknown[]): Promise<unknown> {\n    if (this._destroyed) {\n      return Promise.reject(new Error(\"CrossFrameAPI destroyed\"));\n    }\n\n    const messageId = `cfapi-${Date.now()}-${this._counter++}`;\n    const requestTime = Date.now();\n\n    // Deep-clean params of non-cloneables (e.g. functions)\n    const safeParams = params.map((p) => {\n      if (typeof p === \"function\") {\n        // DEFENSIVE CODING: Warn about non-serializable function parameters.\n        // This console.warn is intentionally kept in production builds because:\n        // 1. Functions in SCORM API params indicate a programming error by content authors\n        // 2. The warning helps diagnose integration issues during content development\n        // 3. It alerts developers to potential data loss (function becomes undefined)\n        // 4. The frequency should be very low in production (only on misconfigured content)\n        //\n        // Alternative: Could be gated by a debug flag if production console noise is a concern\n        console.warn(\"Dropping function param when posting SCORM call:\", method);\n        return undefined;\n      }\n      return p;\n    });\n\n    return new Promise((resolve, reject) => {\n      const timer = setTimeout(() => {\n        if (this._pending.has(messageId)) {\n          this._pending.delete(messageId);\n          reject(new Error(`Timeout calling ${method}`));\n        }\n      }, this._timeout);\n\n      // CF-API-02: Store method name in pending request for better error reporting\n      this._pending.set(messageId, { resolve, reject, timer, requestTime, method });\n      const msg: MessageData = { messageId, method, params: safeParams };\n      this._targetWindow.postMessage(msg, this._origin);\n    });\n  }\n\n  /**\n   * Handle incoming postMessage responses from the LMS frame.\n   */\n  private _onMessage(ev: MessageEvent): void {\n    if (this._destroyed) return;\n\n    // Validate the message origin and source unless all origins are allowed\n    if (this._origin !== \"*\" && ev.origin !== this._origin) {\n      return;\n    }\n    if (ev.source && ev.source !== this._targetWindow) {\n      return;\n    }\n\n    // CF-API-04: Validate that ev.data has the expected MessageResponse structure\n    if (!CrossFrameAPI._isValidMessageResponse(ev.data)) return;\n\n    const data = ev.data;\n\n    // Handle heartbeat response\n    if (data.isHeartbeat) {\n      this._lastHeartbeatResponse = Date.now();\n      if (!this._connected) {\n        this._connected = true;\n        this._emit({ type: \"connectionRestored\" });\n      }\n      return;\n    }\n\n    // Handle regular response\n    const pending = this._pending.get(data.messageId);\n    if (!pending) return;\n\n    clearTimeout(pending.timer);\n    this._pending.delete(data.messageId);\n\n    if (data.error) {\n      // Check if rate limited and emit event\n      // CF-API-02: Use the actual method name from the pending request\n      if (data.error.message === \"Rate limit exceeded\") {\n        this._emit({ type: \"rateLimited\", method: pending.method });\n      }\n      pending.reject(data.error);\n    } else {\n      pending.resolve(data.result);\n    }\n  }\n\n  /**\n   * Capture and cache SCORM errors.\n   */\n  private _capture(method: string, err: unknown): void {\n    let errorMessage = \"Unknown error\";\n\n    if (err instanceof Error) {\n      errorMessage = err.message;\n    } else if (typeof err === \"object\" && err !== null && \"message\" in err) {\n      errorMessage = String((err as { message: unknown }).message);\n    }\n\n    console.error(`CrossFrameAPI ${method} error:`, err);\n    // Match SCORM error codes (3 digits) from error messages\n    const match = /(?:error code|code)?\\s*(\\d{3})\\b/i.exec(errorMessage);\n    const code = match?.[1] ?? String(global_errors.GENERAL);\n    this._lastError = code;\n    this._cache.set(`error_${code}`, errorMessage);\n  }\n}\n"],"names":["CrossFrameAPI","constructor","targetOrigin","targetWindow","arguments","length","undefined","window","parent","options","this","_cache","Map","_cacheTimestamps","_lastError","_pending","_counter","_destroyed","_connected","_lastHeartbeatResponse","Date","now","_eventListeners","_handler","get","target","prop","receiver","v","Reflect","bind","methodName","isGet","endsWith","isSet","startsWith","isInit","isFinish","isCommit","isErrorString","isDiagnostic","_len","args","Array","_key","_validateArgs","console","error","key","set","String","requestTime","_post","then","res","localModTime","delete","catch","err","_capture","result","all","Object","entries","forEach","_ref","val","_origin","_targetWindow","_timeout","timeout","_heartbeatInterval","heartbeatInterval","_heartbeatTimeout","heartbeatTimeout","warn","_boundOnMessage","_onMessage","addEventListener","_startHeartbeat","Proxy","_isValidMessageResponse","data","messageId","message","code","isHeartbeat","isArray","destroy","removeEventListener","_heartbeatTimer","clearInterval","pending","from","values","clearTimeout","timer","reject","Error","clear","on","event","callback","has","Set","add","off","connected","_emit","type","cb","setInterval","_sendHeartbeat","postMessage","method","params","Promise","safeParams","map","p","resolve","setTimeout","ev","origin","source","errorMessage","match","exec"],"mappings":"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"}