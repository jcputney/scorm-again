this.Scorm2004API=function(){"use strict";const e="true",t="false",i={cmi_children:"_version,comments_from_learner,comments_from_lms,completion_status,credit,entry,exit,interactions,launch_data,learner_id,learner_name,learner_preference,location,max_time_allowed,mode,objectives,progress_measure,scaled_passing_score,score,session_time,success_status,suspend_data,time_limit_action,total_time",comments_children:"comment,timestamp,location",score_children:"max,raw,scaled,min",objectives_children:"progress_measure,completion_status,success_status,description,score,id",correct_responses_children:"pattern",student_preference_children:"audio_level,audio_captioning,delivery_speed,language",interactions_children:"id,type,objectives,timestamp,correct_responses,weighting,learner_response,result,latency,description",adl_data_children:"id,store",error_descriptions:{0:{basicMessage:"No Error",detailMessage:"No error occurred, the previous API call was successful."},101:{basicMessage:"General Exception",detailMessage:"No specific error code exists to describe the error."},102:{basicMessage:"General Initialization Failure",detailMessage:"Call to Initialize failed for an unknown reason."},103:{basicMessage:"Already Initialized",detailMessage:"Call to Initialize failed because Initialize was already called."},104:{basicMessage:"Content Instance Terminated",detailMessage:"Call to Initialize failed because Terminate was already called."},111:{basicMessage:"General Termination Failure",detailMessage:"Call to Terminate failed for an unknown reason."},112:{basicMessage:"Termination Before Initialization",detailMessage:"Call to Terminate failed because it was made before the call to Initialize."},113:{basicMessage:"Termination After Termination",detailMessage:"Call to Terminate failed because Terminate was already called."},122:{basicMessage:"Retrieve Data Before Initialization",detailMessage:"Call to GetValue failed because it was made before the call to Initialize."},123:{basicMessage:"Retrieve Data After Termination",detailMessage:"Call to GetValue failed because it was made after the call to Terminate."},132:{basicMessage:"Store Data Before Initialization",detailMessage:"Call to SetValue failed because it was made before the call to Initialize."},133:{basicMessage:"Store Data After Termination",detailMessage:"Call to SetValue failed because it was made after the call to Terminate."},142:{basicMessage:"Commit Before Initialization",detailMessage:"Call to Commit failed because it was made before the call to Initialize."},143:{basicMessage:"Commit After Termination",detailMessage:"Call to Commit failed because it was made after the call to Terminate."},201:{basicMessage:"General Argument Error",detailMessage:"An invalid argument was passed to an API method (usually indicates that Initialize, Commit or Terminate did not receive the expected empty string argument."},301:{basicMessage:"General Get Failure",detailMessage:"Indicates a failed GetValue call where no other specific error code is applicable. Use GetDiagnostic for more information."},351:{basicMessage:"General Set Failure",detailMessage:"Indicates a failed SetValue call where no other specific error code is applicable. Use GetDiagnostic for more information."},391:{basicMessage:"General Commit Failure",detailMessage:"Indicates a failed Commit call where no other specific error code is applicable. Use GetDiagnostic for more information."},401:{basicMessage:"Undefined Data Model Element",detailMessage:"The data model element name passed to GetValue or SetValue is not a valid SCORM data model element."},402:{basicMessage:"Unimplemented Data Model Element",detailMessage:"The data model element indicated in a call to GetValue or SetValue is valid, but was not implemented by this LMS. In SCORM 2004, this error would indicate an LMS that is not fully SCORM conformant."},403:{basicMessage:"Data Model Element Value Not Initialized",detailMessage:"Attempt to read a data model element that has not been initialized by the LMS or through a SetValue call. This error condition is often reached during normal execution of a SCO."},404:{basicMessage:"Data Model Element Is Read Only",detailMessage:"SetValue was called with a data model element that can only be read."},405:{basicMessage:"Data Model Element Is Write Only",detailMessage:"GetValue was called on a data model element that can only be written to."},406:{basicMessage:"Data Model Element Type Mismatch",detailMessage:"SetValue was called with a value that is not consistent with the data format of the supplied data model element."},407:{basicMessage:"Data Model Element Value Out Of Range",detailMessage:"The numeric value supplied to a SetValue call is outside of the numeric range allowed for the supplied data model element."},408:{basicMessage:"Data Model Dependency Not Established",detailMessage:"Some data model elements cannot be set until another data model element was set. This error condition indicates that the prerequisite element was not set before the dependent element."}}},s={D:86400,H:3600,M:60,S:1},n=l(e=>{if(!e||0>=e)return"PT0S";let t="P",i=e;return Object.entries(s).forEach(e=>{let[s,n]=e,r=Math.floor(i/n);i%=n,function(e){if(Math.floor(e)===e||0>(e+"")?.indexOf?.("."))return 0;const t=(""+e).split(".")?.[1];return t?.length??0}(i)>2&&(i=+(+i).toFixed(2)),"S"===s&&i>0&&(r+=i),r&&((t.indexOf("D")>0||["H","M","S"].includes(s))&&-1===t.indexOf("T")&&(t+="T"),t+=`${r}${s}`)}),t}),r=l((e,t)=>{if("string"==typeof t&&(t=RegExp(t)),!e||!e?.match?.(t))return 0;const[,i,s,,n,r,o,a]=RegExp(t).exec?.(e)??[];let result=0;return result+=+a||0,result+=60*+o||0,result+=3600*+r||0,result+=86400*+n||0,result+=31536e3*+i||0,result},(e,t)=>`${e??""}:${"string"==typeof t?t:t?.toString()??""}`),o=l((e,t)=>("string"==typeof t&&(t=RegExp(t)),!(!e||!e?.match?.(t))));function a(e){const result={};return function e(t,i){if(Object(t)!==t)result[i]=t;else if(Array.isArray(t))t.forEach((t,s)=>{e(t,`${i}[${s}]`)}),0===t.length&&(result[i]=[]);else{const s=Object.keys(t).filter(e=>({}.hasOwnProperty.call(t,e))),n=0===s.length;s.forEach(s=>{e(t[s],i?`${i}.${s}`:s)}),n&&i&&(result[i]={})}}(e,""),result}function c(e,t){return"string"==typeof e&&RegExp(t).test(e)}function l(e,t){const i=new Map;return function(){for(var s=arguments.length,n=Array(s),r=0;s>r;r++)n[r]=arguments[r];const o=t?t(...n):JSON.stringify(n);return i.has(o)?i.get(o):(()=>{const result=e(...n);return i.set(o,result),result})()}}const u="unknown",h="true",d="false",m="passed",g="failed",_="unknown",p="completed",v="incomplete",f="unknown",S={_:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},A={autocommit:!1,autocommitSeconds:10,asyncCommit:!1,sendFullCommit:!0,lmsCommitUrl:!1,dataCommitFormat:"json",commitRequestDataType:"application/json;charset=UTF-8",autoProgress:!1,logLevel:S.ERROR,selfReportSessionTime:!1,alwaysSendTotalTime:!1,renderCommonCommitFields:!1,strict_errors:!0,xhrHeaders:{},xhrWithCredentials:!1,fetchMode:"cors",useBeaconInsteadOfFetch:"never",responseHandler:async function(i){if(void 0!==i){let s=null;try{if("function"==typeof i.json)s=await i.json();else if("function"==typeof i.text){const e=await i.text();e&&(s=JSON.parse(e))}}catch(e){}return null!==s&&{}.hasOwnProperty.call(s,"result")?{result:s.result,errorCode:s.errorCode?s.errorCode:s.result===e?0:101}:200===i.status?{result:e,errorCode:0}:{result:t,errorCode:101}}return{result:t,errorCode:101}},requestHandler:function(e){return e},onLogMessage:E,scoItemIds:[],scoItemIdValidator:!1,globalObjectiveIds:[],enableOfflineSupport:!1,courseId:"",syncOnInitialize:!0,syncOnTerminate:!0,maxSyncAttempts:5};function E(e,t){switch(e){case"4":case 4:case"ERROR":case S.ERROR:console.error(t);break;case"3":case 3:case"WARN":case S.WARN:console.warn(t);break;case"2":case 2:case"INFO":case S.INFO:console.info(t);break;case"1":case 1:case"DEBUG":case S.DEBUG:console.debug?console.debug(t):console.log(t)}}class C{constructor(e,t,i){this._cancelled=!1,this._API=e,this._timeout=setTimeout(this.wrapper.bind(this),t),this._callback=i}cancel(){this._cancelled=!0,this._timeout&&clearTimeout(this._timeout)}wrapper(){this._cancelled||this._API.isInitialized()&&(async()=>{await this._API.commit(this._callback)})()}}class y{constructor(e,t){this.settings=e,this.error_codes=t}async processHttpRequest(e,i){let s=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;const r={result:t,errorCode:this.error_codes.GENERAL||101};if(arguments.length>2&&void 0!==arguments[2]&&arguments[2])return this._handleImmediateRequest(e,i,s,n);try{const t=this.settings.requestHandler(i),s=await this.performFetch(e,t);return this.transformResponse(s,n)}catch(t){const i=t instanceof Error?t.message:t+"";s("processHttpRequest",`HTTP request failed to ${e}: ${i}`,S.ERROR),t instanceof Error&&t.stack&&s("processHttpRequest","Stack trace: "+t.stack,S.DEBUG);const o={...r,errorMessage:i,errorDetails:JSON.stringify({url:e,errorType:t instanceof Error?t.constructor.name:typeof t,originalError:i})};return n("CommitError"),o}}_handleImmediateRequest(t,i,s,n){if("never"!==this.settings.useBeaconInsteadOfFetch){const{body:e,contentType:s}=this._prepareRequestBody(i);navigator.sendBeacon(t,new Blob([e],{type:s}))}else this.performFetch(t,i).then(async e=>{await this.transformResponse(e,n)}).catch(e=>{s("processHttpRequest",e instanceof Error?e.message:e+"",S.ERROR),n("CommitError")});return{result:e,errorCode:0}}_prepareRequestBody(e){return{body:e instanceof Array?e.join("&"):JSON.stringify(e),contentType:e instanceof Array?"application/x-www-form-urlencoded":this.settings.commitRequestDataType}}async performFetch(e,t){if("always"===this.settings.useBeaconInsteadOfFetch)return this.performBeacon(e,t);const{body:i,contentType:s}=this._prepareRequestBody(t),n={method:"POST",mode:this.settings.fetchMode,body:i,headers:{...this.settings.xhrHeaders,"Content-Type":s},keepalive:!0};return this.settings.xhrWithCredentials&&(n.credentials="include"),fetch(e,n)}async performBeacon(e,t){const{body:i,contentType:s}=this._prepareRequestBody(t),n=navigator.sendBeacon(e,new Blob([i],{type:s}));return Promise.resolve({status:n?200:0,ok:n,json:async()=>({result:n?"true":"false",errorCode:n?0:this.error_codes.GENERAL}),text:async()=>JSON.stringify({result:n?"true":"false",errorCode:n?0:this.error_codes.GENERAL})})}async transformResponse(e,i){let result;try{result="function"==typeof this.settings.responseHandler?await this.settings.responseHandler(e):await e.json()}catch(i){const s=await e.text().catch(()=>"Unable to read response text");return{result:t,errorCode:this.error_codes.GENERAL||101,errorMessage:"Failed to parse LMS response: "+(i instanceof Error?i.message:i+""),errorDetails:JSON.stringify({status:e.status,statusText:e.statusText,url:e.url,responseText:s.substring(0,500),parseError:i instanceof Error?i.message:i+""})}}return Object.hasOwnProperty.call(result,"errorCode")||(result.errorCode=this._isSuccessResponse(e,result)?0:this.error_codes.GENERAL),this._isSuccessResponse(e,result)||(result.errorDetails={status:e.status,statusText:e.statusText,url:e.url,...result.errorDetails}),this._isSuccessResponse(e,result)?i("CommitSuccess"):i("CommitError",void 0,result.errorCode),result}_isSuccessResponse(t,result){const i=result.result;return!(200>t.status||t.status>299||!0!==i&&"true"!==i&&i!==e)}updateSettings(e){this.settings=e}}class b{constructor(e){this.listenerMap=new Map,this.listenerCount=0,this.apiLog=e}parseListenerName(e){const t=e.split(".");if(0===t.length)return null;const i=t[0];let s=null;return t.length>1&&(s=e.replace(i+".","")),{functionName:i??e,CMIElement:s}}on(e,t){if(!t)return;const i=e.split(" ");for(const e of i){const i=this.parseListenerName(e);if(!i)continue;const{functionName:s,CMIElement:n}=i,r=this.listenerMap.get(s)??[];r.push({functionName:s,CMIElement:n,callback:t}),this.listenerMap.set(s,r),this.listenerCount++,this.apiLog("on","Added event listener: "+this.listenerCount,S.INFO,s)}}off(e,t){if(!t)return;const i=e.split(" ");for(const e of i){const i=this.parseListenerName(e);if(!i)continue;const{functionName:s,CMIElement:n}=i,r=this.listenerMap.get(s);if(!r)continue;const o=r.findIndex(e=>e.CMIElement===n&&e.callback===t);-1!==o&&(r.splice(o,1),this.listenerCount--,0===r.length?this.listenerMap.delete(s):this.listenerMap.set(s,r),this.apiLog("off","Removed event listener: "+this.listenerCount,S.INFO,s))}}clear(e){const t=e.split(" ");for(const e of t){const t=this.parseListenerName(e);if(!t)continue;const{functionName:i,CMIElement:s}=t;if(this.listenerMap.has(i)){const e=this.listenerMap.get(i),t=e.filter(e=>e.CMIElement!==s);this.listenerCount-=e.length-t.length,0===t.length?this.listenerMap.delete(i):this.listenerMap.set(i,t)}}}processListeners(e,t,i){this.apiLog(e,i,S.INFO,t);const s=this.listenerMap.get(e);if(s)for(const n of s){const s=!!n.CMIElement;let r=!1;if(t&&n.CMIElement)if(n.CMIElement.endsWith("*")){const e=n.CMIElement.slice(0,-1);r=t.startsWith(e)}else r=n.CMIElement===t;s&&!r||(this.apiLog("processListeners","Processing listener: "+n.functionName,S.DEBUG,t),e.startsWith("Sequence")||"CommitError"===e?n.callback(i):"CommitSuccess"===e?n.callback():n.callback(t,i))}}reset(){this.listenerMap.clear(),this.listenerCount=0}}class R{loadFromFlattenedJSON(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;if(!s())return void console.error("loadFromFlattenedJSON can only be called before the call to lmsInitialize.");const r=/^(cmi\.interactions\.)(\d+)\.(.*)$/,o=/^(cmi\.objectives\.)(\d+)\.(.*)$/,interactions=[],objectives=[],a=[];for(const t in e)if({}.hasOwnProperty.call(e,t)){const i=t.match(r);if(i){interactions.push({key:t,value:e[t],index:+i[2],field:i[3]||""});continue}const s=t.match(o);if(s){objectives.push({key:t,value:e[t],index:+s[2],field:s[3]||""});continue}a.push({key:t,value:e[t]})}interactions.sort((e,t)=>e.index!==t.index?e.index-t.index:"id"===e.field?-1:"id"===t.field?1:"type"===e.field?-1:"type"===t.field?1:e.field.localeCompare(t.field)),objectives.sort((e,t)=>e.index!==t.index?e.index-t.index:"id"===e.field?-1:"id"===t.field?1:e.field.localeCompare(t.field)),a.sort((e,t)=>e.key.localeCompare(t.key));const c=e=>{e.forEach(e=>{const r={};r[e.key]=e.value,this.loadFromJSON(function(e){if(Object(e)!==e||Array.isArray(e))return e;const result={},pattern=/\.?([^.[\]]+)|\[(\d+)]/g;return Object.keys(e).filter(t=>({}.hasOwnProperty.call(e,t))).forEach(t=>{let i=result,s="";const n=RegExp(pattern);Array.from({length:t.match(RegExp(pattern,"g"))?.length??0},()=>n.exec(t)).forEach(e=>{e&&(i=i[s]??(i[s]=e[2]?[]:{}),s=e[2]||e[1]||"")}),i[s]=e[t]}),result[""]??result}(r),t,i,s,n)})};c(interactions),c(objectives),c(a)}loadFromJSON(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;if(s()){t=void 0!==t?t:"cmi",n(e);for(const r in e)if({}.hasOwnProperty.call(e,r)&&e[r]){const o=(t?t+".":"")+r,a=e[r];if(a.constructor===Array){for(let e=0;a.length>e;e++)if(a[e]){const t=a[e],r=`${o}.${e}`;t.constructor===Object?this.loadFromJSON(t,r,i,s,n):i(r,t)}}else a.constructor===Object?this.loadFromJSON(a,o,i,s,n):i(o,a)}}else console.error("loadFromJSON can only be called before the call to lmsInitialize.")}renderCMIToJSONString(cmi,e){return e?JSON.stringify({cmi:cmi}):JSON.stringify({cmi:cmi},(e,t)=>void 0===t?null:t,2)}renderCMIToJSONObject(cmi,e){return JSON.parse(this.renderCMIToJSONString(cmi,e))}getCommitObject(e,t,i,s,n,r){const o=t||e,a=i?s(e,o):n(e,o);return[S.DEBUG,"1",1,"DEBUG"].includes(r)&&(console.debug("Commit (terminated: "+(e?"yes":"no")+"): "),console.debug(a)),a}}class w extends Error{constructor(e,t){super(`${e} : ${""+t}`),this._errorCode=t,Object.setPrototypeOf(this,w.prototype)}get errorCode(){return this._errorCode}}class T extends w{constructor(e,t,i,s){super(e,t),this._detailedMessage="",this.message=`${e} : ${i}`,this._errorMessage=i,s&&(this._detailedMessage=s),Object.setPrototypeOf(this,T.prototype)}get errorMessage(){return this._errorMessage}get detailedMessage(){return this._detailedMessage}}class M{constructor(){this._logLevel=S.ERROR,this._logHandler=E}static getInstance(){return M._instance||(M._instance=new M),M._instance}setLogLevel(e){this._logLevel=e}getLogLevel(){return this._logLevel}setLogHandler(e){this._logHandler=e}log(e,t){this.shouldLog(e)&&this._logHandler(e,t)}error(e){this.log(S.ERROR,e)}warn(e){this.log(S.WARN,e)}info(e){this.log(S.INFO,e)}debug(e){this.log(S.DEBUG,e)}shouldLog(e){return this.getNumericLevel(e)>=this.getNumericLevel(this._logLevel)}getNumericLevel(e){if(void 0===e)return S.NONE;if("number"==typeof e)return e;switch(e){case"1":case"DEBUG":return S.DEBUG;case"2":case"INFO":return S.INFO;case"3":case"WARN":return S.WARN;case"4":case"ERROR":default:return S.ERROR;case"5":case"NONE":return S.NONE}}}function O(){return M.getInstance()}class N{constructor(e,t,i,s){this._lastErrorCode="0",this._errorCodes=e,this._apiLog=t,this._getLmsErrorMessageDetails=i,this._loggingService=s||O()}get lastErrorCode(){return this._lastErrorCode}set lastErrorCode(e){this._lastErrorCode=e}throwSCORMError(e,t,i){i||(i=this._getLmsErrorMessageDetails(t,!0));const s=`SCORM Error ${t}: ${i}${e?` [Element: ${e}]`:""}`;this._apiLog("throwSCORMError",t+": "+i,S.ERROR,e),this._loggingService.error(s),this._lastErrorCode=t+""}clearSCORMError(e){void 0!==e&&e!==t&&(this._lastErrorCode="0")}handleValueAccessException(e,i,s){if(i instanceof T){const n=i;this._lastErrorCode=n.errorCode+"",this._loggingService.warn(`Validation Error ${n.errorCode}: ${n.message} [Element: ${e}]`),s=t}else if(i instanceof Error){const t=i.constructor.name;this._loggingService.error(`${t}: ${i.message} [Element: ${e}]\n${i.stack||""}`),this.throwSCORMError(e,this._errorCodes.GENERAL,`${t}: ${i.message}`)}else{this._loggingService.error(`Unknown error occurred while accessing [Element: ${e}]`);try{const e=JSON.stringify(i);this._loggingService.error("Error details: "+e)}catch(e){this._loggingService.error("Could not stringify error object for details")}this.throwSCORMError(e,this._errorCodes.GENERAL,"Unknown error")}return s}get errorCodes(){return this._errorCodes}}class q{constructor(e,t,i){this.apiLog=i,this.storeName="scorm_again_offline_data",this.syncQueue="scorm_again_sync_queue",this.isOnline=navigator.onLine,this.syncInProgress=!1,this.settings=e,this.error_codes=t,window.addEventListener("online",this.handleOnlineStatusChange.bind(this)),window.addEventListener("offline",this.handleOnlineStatusChange.bind(this))}handleOnlineStatusChange(){const e=this.isOnline;this.isOnline=navigator.onLine,!e&&this.isOnline?(this.apiLog("OfflineStorageService","Device is back online, attempting to sync...",S.INFO),this.syncOfflineData().then(e=>{e?this.apiLog("OfflineStorageService","Sync completed successfully",S.INFO):this.apiLog("OfflineStorageService","Sync failed",S.ERROR)},e=>{this.apiLog("OfflineStorageService","Error during sync: "+e,S.ERROR)})):e&&!this.isOnline&&this.apiLog("OfflineStorageService","Device is offline, data will be stored locally",S.INFO)}async storeOffline(i,s){try{const t={id:`${i}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,courseId:i,timestamp:Date.now(),data:s,syncAttempts:0},n=await this.getFromStorage(this.syncQueue)||[];return n.push(t),await this.saveToStorage(this.syncQueue,n),await this.saveToStorage(`${this.storeName}_${i}`,s),this.apiLog("OfflineStorageService","Stored data offline for course "+i,S.INFO),{result:e,errorCode:0}}catch(e){return this.apiLog("OfflineStorageService","Error storing offline data: "+e,S.ERROR),{result:t,errorCode:this.error_codes.GENERAL??0}}}async getOfflineData(e){try{return await this.getFromStorage(`${this.storeName}_${e}`)||null}catch(e){return this.apiLog("OfflineStorageService","Error retrieving offline data: "+e,S.ERROR),null}}async syncOfflineData(){if(this.syncInProgress||!this.isOnline)return!1;this.syncInProgress=!0;try{const t=await this.getFromStorage(this.syncQueue)||[];if(0===t.length)return this.syncInProgress=!1,!0;this.apiLog("OfflineStorageService",`Found ${t.length} items to sync`,S.INFO);const i=[];for(const s of t)if(5>s.syncAttempts)try{(await this.sendDataToLMS(s.data)).result===e?this.apiLog("OfflineStorageService","Successfully synced item "+s.id,S.INFO):(s.syncAttempts++,i.push(s),this.apiLog("OfflineStorageService",`Failed to sync item ${s.id}, attempt #${s.syncAttempts}`,S.WARN))}catch(e){s.syncAttempts++,i.push(s),this.apiLog("OfflineStorageService",`Error syncing item ${s.id}: ${e}`,S.ERROR)}else this.apiLog("OfflineStorageService",`Skipping item ${s.id} after 5 failed attempts`,S.WARN);return await this.saveToStorage(this.syncQueue,i),this.apiLog("OfflineStorageService",`Sync completed. ${t.length-i.length} items synced, ${i.length} items remaining`,S.INFO),this.syncInProgress=!1,!0}catch(e){return this.apiLog("OfflineStorageService","Error during sync process: "+e,S.ERROR),this.syncInProgress=!1,!1}}async sendDataToLMS(i){if(!this.settings.lmsCommitUrl)return{result:t,errorCode:this.error_codes.GENERAL||101};try{const t=this.settings.requestHandler(i),s={method:"POST",mode:this.settings.fetchMode,body:JSON.stringify(t),headers:{...this.settings.xhrHeaders,"Content-Type":this.settings.commitRequestDataType}};this.settings.xhrWithCredentials&&(s.credentials="include");const n=await fetch(this.settings.lmsCommitUrl,s),result="function"==typeof this.settings.responseHandler?await this.settings.responseHandler(n):await n.json();return 200>n.status||n.status>299||!0!==result.result&&result.result!==e?(Object.hasOwnProperty.call(result,"errorCode")||(result.errorCode=this.error_codes.GENERAL),result):(Object.hasOwnProperty.call(result,"errorCode")||(result.errorCode=0),result)}catch(e){return this.apiLog("OfflineStorageService","Error sending data to LMS: "+e,S.ERROR),{result:t,errorCode:this.error_codes.GENERAL||101}}}isDeviceOnline(){return this.isOnline}async getFromStorage(e){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(e){return null}return null}async saveToStorage(e,t){localStorage.setItem(e,JSON.stringify(t))}async hasPendingOfflineData(e){return(await this.getFromStorage(this.syncQueue)||[]).some(t=>t.courseId===e)}updateSettings(e){this.settings=e}}class I{constructor(e){this.jsonString=!1,this._initialized=!1,this._cmi_element=e}get initialized(){return this._initialized}initialize(){this._initialized=!0}}class L extends I{get start_time(){return this._start_time}setStartTime(){if(void 0!==this._start_time)throw Error("Start time has already been set.");this._start_time=(new Date).getTime()}}const D={GENERAL:101,INITIALIZATION_FAILED:101,INITIALIZED:101,TERMINATED:101,TERMINATION_FAILURE:101,TERMINATION_BEFORE_INIT:101,MULTIPLE_TERMINATION:101,RETRIEVE_BEFORE_INIT:101,RETRIEVE_AFTER_TERM:101,STORE_BEFORE_INIT:101,STORE_AFTER_TERM:101,COMMIT_BEFORE_INIT:101,COMMIT_AFTER_TERM:101,ARGUMENT_ERROR:101,CHILDREN_ERROR:101,COUNT_ERROR:101,GENERAL_GET_FAILURE:101,GENERAL_SET_FAILURE:101,GENERAL_COMMIT_FAILURE:101,UNDEFINED_DATA_MODEL:101,UNIMPLEMENTED_ELEMENT:101,VALUE_NOT_INITIALIZED:101,INVALID_SET_VALUE:101,READ_ONLY_ELEMENT:101,WRITE_ONLY_ELEMENT:101,TYPE_MISMATCH:101,VALUE_OUT_OF_RANGE:101,DEPENDENCY_NOT_ESTABLISHED:101},x={...D,INVALID_SET_VALUE:402,READ_ONLY_ELEMENT:403,TYPE_MISMATCH:405,VALUE_OUT_OF_RANGE:407},j={...D,INITIALIZATION_FAILED:102,INITIALIZED:103,TERMINATED:104,TERMINATION_FAILURE:111,TERMINATION_BEFORE_INIT:112,MULTIPLE_TERMINATION:113,MULTIPLE_TERMINATIONS:113,RETRIEVE_BEFORE_INIT:122,RETRIEVE_AFTER_TERM:123,STORE_BEFORE_INIT:132,STORE_AFTER_TERM:133,COMMIT_BEFORE_INIT:142,COMMIT_AFTER_TERM:143,ARGUMENT_ERROR:201,GENERAL_GET_FAILURE:301,GENERAL_SET_FAILURE:351,GENERAL_COMMIT_FAILURE:391,UNDEFINED_DATA_MODEL:401,UNIMPLEMENTED_ELEMENT:402,VALUE_NOT_INITIALIZED:403,READ_ONLY_ELEMENT:404,WRITE_ONLY_ELEMENT:405,TYPE_MISMATCH:406,VALUE_OUT_OF_RANGE:407,DEPENDENCY_NOT_ESTABLISHED:408};class P extends I{constructor(e){super(e.CMIElement),this.__children=e.children,this._errorCode=e.errorCode||x.GENERAL,this._errorClass=e.errorClass||w,this.childArray=[]}reset(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._initialized=!1,e)this.childArray=[];else for(let e=0;this.childArray.length>e;e++)this.childArray[e].reset()}get _children(){return this.__children}set _children(_children){throw new this._errorClass(this._cmi_element+"._children",this._errorCode)}get _count(){return this.childArray.length}set _count(_count){throw new this._errorClass(this._cmi_element+"._count",this._errorCode)}toJSON(){this.jsonString=!0;const result={};for(let e=0;this.childArray.length>e;e++)result[e+""]=this.childArray[e];return this.jsonString=!1,result}}class z{constructor(e,t,i,s,n,r,o,a,c){if(this._settings=A,this._courseId="",new.target===z)throw new TypeError("Cannot construct BaseAPI instances directly");this.currentState=0,this._error_codes=e,t&&(this.settings={...A,...t}),this._loggingService=a||O(),this._loggingService.setLogLevel(this.settings.logLevel),this._loggingService.setLogHandler(this.settings.onLogMessage?this.settings.onLogMessage:E),this._httpService=i||new y(this.settings,this._error_codes),this._eventService=s||new b((e,t,i,s)=>this.apiLog(e,t,i,s)),this._serializationService=n||new R,this._errorHandlingService=o||new N(this._error_codes,(e,t,i,s)=>this.apiLog(e,t,i||S.ERROR,s),(e,t)=>this.getLmsErrorMessageDetails(e,t),void 0),this.settings.enableOfflineSupport&&(this._offlineStorageService=c||new q(this.settings,this._error_codes,(e,t,i,s)=>this.apiLog(e,t,i,s)),this.settings.courseId&&(this._courseId=this.settings.courseId),this._offlineStorageService&&this._courseId&&this._offlineStorageService.getOfflineData(this._courseId).then(e=>{e&&(this.apiLog("constructor","Found offline data to restore",S.INFO),this.loadFromJSON(e.runtimeData))}).catch(e=>{this.apiLog("constructor","Error retrieving offline data: "+e,S.ERROR)}))}get lastErrorCode(){return this._errorHandlingService?.lastErrorCode??"0"}set lastErrorCode(e){this._errorHandlingService&&(this._errorHandlingService.lastErrorCode=e)}get eventService(){return this._eventService}get loggingService(){return this._loggingService}commonReset(e){this.apiLog("reset","Called",S.INFO),this.settings={...this.settings,...e},this.clearScheduledCommit(),this.currentState=0,this.lastErrorCode="0",this._eventService.reset(),this.startingData={},this._offlineStorageService&&(this._offlineStorageService.updateSettings(this.settings),e?.courseId&&(this._courseId=e.courseId))}initialize(i,s,n){let r=t;return this.isInitialized()?this.throwSCORMError("api",this._error_codes.INITIALIZED,s):this.isTerminated()?this.throwSCORMError("api",this._error_codes.TERMINATED,n):(this.settings.selfReportSessionTime&&this.cmi.setStartTime(),this.currentState=1,this.lastErrorCode="0",r=e,this.processListeners(i),this.settings.enableOfflineSupport&&this._offlineStorageService&&this._courseId&&this.settings.syncOnInitialize&&this._offlineStorageService.isDeviceOnline()&&this._offlineStorageService.hasPendingOfflineData(this._courseId).then(e=>{e&&(this.apiLog(i,"Syncing pending offline data on initialization",S.INFO),this._offlineStorageService?.syncOfflineData().then(e=>{e&&(this.apiLog(i,"Successfully synced offline data",S.INFO),this.processListeners("OfflineDataSynced"))}))})),this.apiLog(i,"returned: "+r,S.INFO),this.clearSCORMError(r),r}apiLog(e,t,i,s){t=function(e,t,i){let s=e.padEnd(20)+": ";return i&&(s+=i,s=s.padEnd(70)),s+=t??"",s}(e,t,s),this._loggingService.log(i,t)}get settings(){return this._settings}set settings(e){const t=this._settings;this._settings={...this._settings,...e},this._httpService?.updateSettings(this._settings),void 0!==e.logLevel&&e.logLevel!==t.logLevel&&this._loggingService?.setLogLevel(e.logLevel),void 0!==e.onLogMessage&&e.onLogMessage!==t.onLogMessage&&this._loggingService?.setLogHandler(e.onLogMessage)}async terminate(i,s){let n=t;if(this.checkState(s,this._error_codes.TERMINATION_BEFORE_INIT??0,this._error_codes.MULTIPLE_TERMINATION??0)){this.currentState=2,this.settings.enableOfflineSupport&&this._offlineStorageService&&this._courseId&&this.settings.syncOnTerminate&&this._offlineStorageService.isDeviceOnline()&&await this._offlineStorageService.hasPendingOfflineData(this._courseId)&&(this.apiLog(i,"Syncing pending offline data before termination",S.INFO),await this._offlineStorageService.syncOfflineData());const result=await this.storeData(!0);(result.errorCode??0)>0&&(result.errorMessage&&this.apiLog("terminate","Terminate failed with error: "+result.errorMessage,S.ERROR),result.errorDetails&&this.apiLog("terminate","Error details: "+JSON.stringify(result.errorDetails),S.DEBUG),this.throwSCORMError("api",result.errorCode??0)),n=result?.result??t,s&&(this.lastErrorCode="0"),n=e,this.processListeners(i)}return this.apiLog(i,"returned: "+n,S.INFO),this.clearSCORMError(n),n}getValue(e,t,i){let s="";if(this.checkState(t,this._error_codes.RETRIEVE_BEFORE_INIT??0,this._error_codes.RETRIEVE_AFTER_TERM??0)){try{s=this.getCMIValue(i)}catch(e){s=this.handleValueAccessException(i,e,s)}this.processListeners(e,i)}return this.apiLog(e,": returned: "+s,S.INFO,i),void 0===s?"":("0"===this.lastErrorCode&&this.clearSCORMError(s),s)}setValue(e,i,s,n,r){void 0!==r&&(r+="");let o=t;if(this.checkState(s,this._error_codes.STORE_BEFORE_INIT??0,this._error_codes.STORE_AFTER_TERM??0)){try{o=this.setCMIValue(n,r)}catch(e){o=this.handleValueAccessException(n,e,o)}this.processListeners(e,n,r)}return void 0===o&&(o=t),this.lastErrorCode+""=="0"&&this.settings.autocommit&&this.scheduleCommit(1e3*this.settings.autocommitSeconds,i),this.apiLog(e,": "+r+": result: "+o,S.INFO,n),"0"===this.lastErrorCode&&this.clearSCORMError(o),o}async commit(e){let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.clearScheduledCommit();let s=t;if(this.checkState(i,this._error_codes.COMMIT_BEFORE_INIT??0,this._error_codes.COMMIT_AFTER_TERM??0)){const result=await this.storeData(!1);(result.errorCode??0)>0&&(result.errorMessage&&this.apiLog("commit","Commit failed with error: "+result.errorMessage,S.ERROR),result.errorDetails&&this.apiLog("commit","Error details: "+JSON.stringify(result.errorDetails),S.DEBUG),this.throwSCORMError("api",result.errorCode)),s=result?.result??t,this.apiLog(e," Result: "+s,S.DEBUG,"HttpRequest"),i&&(this.lastErrorCode="0"),this.processListeners(e),this.settings.enableOfflineSupport&&this._offlineStorageService&&this._offlineStorageService.isDeviceOnline()&&this._courseId&&this._offlineStorageService.hasPendingOfflineData(this._courseId).then(t=>{t&&(this.apiLog(e,"Syncing pending offline data",S.INFO),this._offlineStorageService?.syncOfflineData().then(t=>{t?(this.apiLog(e,"Successfully synced offline data",S.INFO),this.processListeners("OfflineDataSynced")):this.apiLog(e,"Failed to sync some offline data",S.WARN)}))})}return this.apiLog(e,"returned: "+s,S.INFO),"0"===this.lastErrorCode&&this.clearSCORMError(s),s}getLastError(e){const t=this.lastErrorCode+"";return this.processListeners(e),this.apiLog(e,"returned: "+t,S.INFO),t}getErrorString(e,t){let i="";return null!==t&&""!==t&&(i=this.getLmsErrorMessageDetails(t),this.processListeners(e)),this.apiLog(e,"returned: "+i,S.INFO),i}getDiagnostic(e,t){let i="";return null!==t&&""!==t&&(i=this.getLmsErrorMessageDetails(t,!0),this.processListeners(e)),this.apiLog(e,"returned: "+i,S.INFO),i}checkState(e,t,i){return this.isNotInitialized()?(this.throwSCORMError("api",t),!1):!e||!this.isTerminated()||(this.throwSCORMError("api",i),!1)}getLmsErrorMessageDetails(e){throw Error("The getLmsErrorMessageDetails method has not been implemented")}getCMIValue(e){throw Error("The getCMIValue method has not been implemented")}setCMIValue(e,t){throw Error("The setCMIValue method has not been implemented")}_commonSetCMIValue(i,s,n,r){if(!n||""===n)return t;this.lastErrorCode="0";const o=n.split(".");let a=this,l=t,u=!1;const h=`The data model element passed to ${i} (${n}) is not a valid SCORM data model element.`,d=s?this._error_codes.UNDEFINED_DATA_MODEL:this._error_codes.GENERAL;for(let t=0;o.length>t;t++){const i=o[t];if(t===o.length-1)if(s&&i&&"{target="===i.substring(0,8)){if(this.isInitialized()){this.throwSCORMError(n,this._error_codes.READ_ONLY_ELEMENT);break}a={...a,attribute:r}}else{if(void 0===i||!this._checkObjectHasProperty(a,i)){this.throwSCORMError(n,d,h);break}if(c(n,"\\.correct_responses\\.\\d+$")&&this.isInitialized()&&"pattern"!==i&&(this.validateCorrectResponse(n,r),"0"!==this.lastErrorCode)){this.throwSCORMError(n,this._error_codes.TYPE_MISMATCH);break}if(!s||"0"===this._errorHandlingService.lastErrorCode){if(void 0===i||"__proto__"===i||"constructor"===i){this.throwSCORMError(n,d,h);break}a[i]=r,l=e}}else{if(void 0===i||!this._checkObjectHasProperty(a,i)){this.throwSCORMError(n,d,h);break}if(a=a[i],!a){this.throwSCORMError(n,d,h);break}if(a instanceof P){const e=parseInt(o[t+1]||"0",10);if(!isNaN(e)){const i=a.childArray[e];if(i)a=i,u=!0;else{const t=this.getChildElement(n,r,u);if(u=!0,!t){"0"===this.lastErrorCode&&this.throwSCORMError(n,d,h);break}a.initialized&&t.initialize(),a.childArray[e]=t,a=t}t++}}}}return l===t&&this.apiLog(i,`There was an error setting the value for: ${n}, value of: ${r}`,S.WARN),l}_commonGetCMIValue(e,t,i){if(!i||""===i)return"";const s=i.split(".");let n=this,r=null;const o=`The data model element passed to ${e} (${i}) has not been initialized.`,a=`The data model element passed to ${e} (${i}) is not a valid SCORM data model element.`,c=t?this._error_codes.UNDEFINED_DATA_MODEL:this._error_codes.GENERAL;for(let e=0;s.length>e;e++){if(r=s[e],t){if("{target="===(r+"").substring(0,8)&&"function"==typeof n._isTargetValid)return n._isTargetValid((r+"").substring(8,(r+"").length-9));if(void 0===r||!this._checkObjectHasProperty(n,r))return void this.throwSCORMError(i,c,a)}else if(e===s.length-1&&(void 0===r||!this._checkObjectHasProperty(n,r)))return void this.throwSCORMError(i,c,a);if(null==r){this.throwSCORMError(i,c,a);break}if(n=n[r],void 0===n){this.throwSCORMError(i,c,a);break}if(n instanceof P){const t=parseInt(s[e+1]||"",10);if(!isNaN(t)){const s=n.childArray[t];if(!s){this.throwSCORMError(i,this._error_codes.VALUE_NOT_INITIALIZED,o);break}n=s,e++}}}if(null!=n)return n;t||("_children"===r?this.throwSCORMError(i,this._error_codes.CHILDREN_ERROR,void 0):"_count"===r&&this.throwSCORMError(i,this._error_codes.COUNT_ERROR,void 0))}isInitialized(){return 1===this.currentState}isNotInitialized(){return 0===this.currentState}isTerminated(){return 2===this.currentState}on(e,t){this._eventService.on(e,t)}off(e,t){this._eventService.off(e,t)}clear(e){this._eventService.clear(e)}processListeners(e,t,i){this._eventService.processListeners(e,t,i)}throwSCORMError(e,t,i){this._errorHandlingService.throwSCORMError(e,t??0,i)}clearSCORMError(e){this._errorHandlingService.clearSCORMError(e)}loadFromFlattenedJSON(e,t){t||(t=""),this._serializationService.loadFromFlattenedJSON(e,t,(e,t)=>this.setCMIValue(e,t),()=>this.isNotInitialized(),e=>{this.startingData=e})}getFlattenedCMI(){return a(this.renderCMIToJSONObject())}loadFromJSON(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t&&""!==t||Object.hasOwnProperty.call(e,"cmi")||Object.hasOwnProperty.call(e,"adl")||(t="cmi"),this._serializationService.loadFromJSON(e,t,(e,t)=>this.setCMIValue(e,t),()=>this.isNotInitialized(),e=>{this.startingData=e})}renderCMIToJSONString(){return this._serializationService.renderCMIToJSONString(this.cmi,this.settings.sendFullCommit)}renderCMIToJSONObject(){return this._serializationService.renderCMIToJSONObject(this.cmi,this.settings.sendFullCommit)}async processHttpRequest(e,i){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.settings.enableOfflineSupport&&this._offlineStorageService&&!this._offlineStorageService.isDeviceOnline()&&this._courseId?(this.apiLog("processHttpRequest","Device is offline, storing data locally",S.INFO),i&&"object"==typeof i&&"cmi"in i?await this._offlineStorageService.storeOffline(this._courseId,i):(this.apiLog("processHttpRequest","Invalid commit data format for offline storage",S.ERROR),{result:t,errorCode:this._error_codes.GENERAL??101})):await this._httpService.processHttpRequest(e,i,s,(e,t,i,s)=>this.apiLog(e,t,i,s),(e,t,i)=>this.processListeners(e,t,i))}scheduleCommit(e,t){this._timeout||(this._timeout=new C(this,e,t),this.apiLog("scheduleCommit","scheduled",S.DEBUG,""))}clearScheduledCommit(){this._timeout&&(this._timeout.cancel(),this._timeout=void 0,this.apiLog("clearScheduledCommit","cleared",S.DEBUG,""))}_checkObjectHasProperty(e,t){return Object.hasOwnProperty.call(e,t)||null!=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),t)||t in e}handleValueAccessException(e,i,s){return i instanceof T?(this.lastErrorCode=i.errorCode+"",s=t,this.throwSCORMError(e,i.errorCode,i.errorMessage)):this.throwSCORMError(e,this._error_codes.GENERAL,i instanceof Error&&i.message?i.message:"Unknown error"),s}getCommitObject(e){return this._serializationService.getCommitObject(e,this.settings.alwaysSendTotalTime,this.settings.renderCommonCommitFields,(e,t)=>this.renderCommitObject(e,t),(e,t)=>this.renderCommitCMI(e,t),this.settings.logLevel)}}const k=i.error_descriptions;class F extends T{constructor(e,t){!{}.hasOwnProperty.call(k,t+"")?super(e,101,k[101]?.basicMessage,k[101]?.detailMessage):super(e,t,k[t+""]?.basicMessage||"Unknown error",k[t+""]?.detailMessage),Object.setPrototypeOf(this,F.prototype)}}const $=l((e,t,i,s,n,r)=>{if("string"!=typeof t)return!1;const o=RegExp(i),a=t.match(o);if(r&&""===t)return!0;if(void 0===t||!a||""===a[0])throw new n(e,s);return!0},(e,t,i,s,n,r)=>`${e}:${"string"==typeof t?t:`[${typeof t}]`}:${i}:${s}:${r||!1}`),B=l((e,t,i,s,n)=>{const r=i.split("#");if(t*=1,r[0]&&t>=r[0]){if(!r[1]||"*"!==r[1]&&t>r[1])throw new n(e,s);return!0}throw new n(e,s)},(e,t,i,s,n)=>`${e}:${t}:${i}:${s}`);function H(e,t,i,s){return $(e,t,i,j.TYPE_MISMATCH,F,s)}function V(e,t,i){return B(e,t,i,j.VALUE_OUT_OF_RANGE,F)}const U="^-?([0-9]+)$",Y="^[\\u0000-\\uFFFF]{0,4000}$",G="^({lang=([a-zA-Z]{2,3}|i|x)(-[a-zA-Z0-9-]{2,8})?})?((?!{.*$).{0,250}$)?$",J="^({lang=([a-zA-Z]{2,3}|i|x)(-[a-zA-Z0-9-]{2,8})?})?((?!{.*$).{0,4000}$)?$",W="^(19[7-9]{1}[0-9]{1}|20[0-2]{1}[0-9]{1}|203[0-8]{1})((-(0[1-9]{1}|1[0-2]{1}))((-(0[1-9]{1}|[1-2]{1}[0-9]{1}|3[0-1]{1}))(T([0-1]{1}[0-9]{1}|2[0-3]{1})((:[0-5]{1}[0-9]{1})((:[0-5]{1}[0-9]{1})((\\.[0-9]{1,6})((Z|([+|-]([0-1]{1}[0-9]{1}|2[0-3]{1})))(:[0-5]{1}[0-9]{1})?)?)?)?)?)?)?)?$",X="^P(?:([.,\\d]+)Y)?(?:([.,\\d]+)M)?(?:([.,\\d]+)W)?(?:([.,\\d]+)D)?(?:T?(?:([.,\\d]+)H)?(?:([.,\\d]+)M)?(?:([.,\\d]+)S)?)?$",K="^-?([0-9]{1,5})(\\.[0-9]{1,18})?$",Z="^[\\w\\.\\-\\_]{1,250}$",Q="^(?:(?!urn:)\\S{1,4000}|urn:[A-Za-z0-9-]{1,31}:\\S{1,4000}|.{1,4000})$",ee="^(completed|incomplete|not attempted|unknown)$",te="^(passed|failed|unknown)$",ie="^(start|resumeAll|previous|continue|exit|exitAll|abandon|abandonAll|suspendAll|retry|retryAll|_none_|(\\{target=(?<choice_target>\\S{0,}[a-zA-Z0-9-_]+)})?choice|(\\{target=(?<jump_target>\\S{0,}[a-zA-Z0-9-_]+)})?jump)$",se="^(unknown|true|false)$",ne="^{target=\\S{0,}[a-zA-Z0-9-_]+}$";class re extends I{constructor(){super("cmi.learner_preference"),this.__children=i.student_preference_children,this._audio_level="1",this._language="",this._delivery_speed="1",this._audio_captioning="0"}reset(){this._initialized=!1}get _children(){return this.__children}set _children(_children){throw new F(this._cmi_element+"._children",j.READ_ONLY_ELEMENT)}get audio_level(){return this._audio_level}set audio_level(audio_level){H(this._cmi_element+".audio_level",audio_level,K)&&V(this._cmi_element+".audio_level",audio_level,"0#999.9999999")&&(this._audio_level=audio_level)}get language(){return this._language}set language(language){H(this._cmi_element+".language",language,"^([a-zA-Z]{2,3}|i|x)(-[a-zA-Z0-9-]{2,8})?$|^$")&&(this._language=language)}get delivery_speed(){return this._delivery_speed}set delivery_speed(delivery_speed){H(this._cmi_element+".delivery_speed",delivery_speed,K)&&V(this._cmi_element+".delivery_speed",delivery_speed,"0#999.9999999")&&(this._delivery_speed=delivery_speed)}get audio_captioning(){return this._audio_captioning}set audio_captioning(audio_captioning){H(this._cmi_element+".audio_captioning",audio_captioning,"^-?([0-9]+)$")&&V(this._cmi_element+".audio_captioning",audio_captioning,"-1#1")&&(this._audio_captioning=audio_captioning)}toJSON(){this.jsonString=!0;const result={audio_level:this.audio_level,language:this.language,delivery_speed:this.delivery_speed,audio_captioning:this.audio_captioning};return this.jsonString=!1,result}}const oe={"true-false":{format:"^true$|^false$",max:1,delimiter:"",unique:!1},choice:{format:Q,max:36,delimiter:"[,]",unique:!0},"fill-in":{format:G,max:10,delimiter:"[,]",unique:!1},"long-fill-in":{format:J,max:1,delimiter:"",unique:!1},matching:{format:Z,format2:Z,max:36,delimiter:"[,]",delimiter2:"[.]",unique:!1},performance:{format:"^$|"+Z,format2:K+"|^$|"+Z,max:250,delimiter:"[,]",delimiter2:"[.]",unique:!1},sequencing:{format:Z,max:36,delimiter:"[,]",unique:!1},likert:{format:Z,max:1,delimiter:"",unique:!1},numeric:{format:K,max:1,delimiter:"",unique:!1},other:{format:Y,max:1,delimiter:"",unique:!1}},ae={"true-false":{max:1,delimiter:"",unique:!1,duplicate:!1,format:"^true$|^false$",limit:1},choice:{max:36,delimiter:"[,]",unique:!0,duplicate:!1,format:Q},"fill-in":{max:10,delimiter:"[,]",unique:!1,duplicate:!1,format:"^(({lang=([a-zA-Z]{2,3}|i|x)?(-[a-zA-Z0-9-]{2,8})?})?(.{0,250})?)?$"},"long-fill-in":{max:1,delimiter:"",unique:!1,duplicate:!0,format:J},matching:{max:36,delimiter:"[,]",delimiter2:"[.]",unique:!1,duplicate:!1,format:Z,format2:Z},performance:{max:250,delimiter:"[,]",delimiter2:"[.]",delimiter3:"[:]",unique:!1,duplicate:!1,format:Z,format2:`^(${Z})$|^(?:\\d+(?:\\.\\d+)?(?::\\d+(?:\\.\\d+)?)?)$`},sequencing:{max:36,delimiter:"[,]",unique:!1,duplicate:!1,format:Z},likert:{max:1,delimiter:"",unique:!1,duplicate:!1,format:Z,limit:1},numeric:{max:2,delimiter:"[:]",unique:!1,duplicate:!1,format:K,limit:1},other:{max:1,delimiter:"",unique:!1,duplicate:!1,format:Y,limit:1}};class ce extends P{constructor(){super({CMIElement:"cmi.interactions",children:i.interactions_children,errorCode:j.READ_ONLY_ELEMENT,errorClass:F})}}class le extends I{constructor(){super("cmi.interactions.n"),this._id="",this._type="",this._timestamp="",this._weighting="",this._learner_response="",this._result="",this._latency="",this._description="",this.objectives=new P({CMIElement:"cmi.interactions.n.objectives",errorCode:j.READ_ONLY_ELEMENT,errorClass:F,children:i.objectives_children}),this.correct_responses=new P({CMIElement:"cmi.interactions.n.correct_responses",errorCode:j.READ_ONLY_ELEMENT,errorClass:F,children:i.correct_responses_children})}initialize(){super.initialize(),this.objectives?.initialize(),this.correct_responses?.initialize()}reset(){this._initialized=!1,this._id="",this._type="",this._timestamp="",this._weighting="",this._learner_response="",this._result="",this._latency="",this._description="",this.objectives=new P({CMIElement:"cmi.interactions.n.objectives",errorCode:j.READ_ONLY_ELEMENT,errorClass:F,children:i.objectives_children}),this.correct_responses=new P({CMIElement:"cmi.interactions.n.correct_responses",errorCode:j.READ_ONLY_ELEMENT,errorClass:F,children:i.correct_responses_children})}get id(){return this._id}set id(id){H(this._cmi_element+".id",id,Q)&&(this._id=id)}get type(){return this._type}set type(type){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".type",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".type",type,"^(true-false|choice|fill-in|long-fill-in|matching|performance|sequencing|likert|numeric|other)$")&&(this._type=type)}get timestamp(){return this._timestamp}set timestamp(timestamp){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".timestamp",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".timestamp",timestamp,W)&&(this._timestamp=timestamp)}get weighting(){return this._weighting}set weighting(weighting){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".weighting",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".weighting",weighting,K)&&(this._weighting=weighting)}get learner_response(){return this._learner_response}set learner_response(learner_response){if(this.initialized&&(""===this._type||""===this._id))throw new F(this._cmi_element+".learner_response",j.DEPENDENCY_NOT_ESTABLISHED);{let e=[];const t=oe[this.type];if(!t)throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH);if(t?.delimiter?e=learner_response.split("[,]"===t.delimiter?",":t.delimiter):e[0]=learner_response,0>=e.length||e.length>t.max)throw new F(this._cmi_element+".learner_response",j.GENERAL_SET_FAILURE);{const i=RegExp(t.format);for(let s=0;e.length>s;s++)if(t?.delimiter2){const n="[.]"===t.delimiter2?".":t.delimiter2,r=e[s]?.split(n);if(2!==r?.length)throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH);if("performance"===this.type&&(""===r[0]||""===r[1]))throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH);if(!r[0]?.match(i))throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH);if(!t.format2||!r[1]?.match(RegExp(t.format2)))throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH)}else{if(!e[s]?.match(i))throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH);if(""!==e[s]&&t.unique)for(let t=0;s>t;t++)if(e[s]===e[t])throw new F(this._cmi_element+".learner_response",j.TYPE_MISMATCH)}}this._learner_response=learner_response}}get result(){return this._result}set result(result){H(this._cmi_element+".result",result,"^(correct|incorrect|unanticipated|neutral|-?([0-9]{1,4})(\\.[0-9]{1,18})?)$")&&(this._result=result)}get latency(){return this._latency}set latency(latency){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".latency",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".latency",latency,X)&&(this._latency=latency)}get description(){return this._description}set description(description){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".description",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".description",description,G,!0)&&(this._description=description)}toJSON(){this.jsonString=!0;const result={id:this.id,type:this.type,objectives:this.objectives,timestamp:this.timestamp,weighting:this.weighting,learner_response:this.learner_response,result:this.result,latency:this.latency,description:this.description,correct_responses:this.correct_responses};return this.jsonString=!1,result}}class ue extends I{constructor(){super("cmi.interactions.n.objectives.n"),this._id=""}reset(){this._initialized=!1,this._id=""}get id(){return this._id}set id(id){H(this._cmi_element+".id",id,Q)&&(this._id=id)}toJSON(){this.jsonString=!0;const result={id:this.id};return this.jsonString=!1,result}}function he(e){return e.replace(/[[\]]/g,"")}function de(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function me(text,e){const t=de(e),i=RegExp("(?<!\\\\)"+t,"g"),s=RegExp("\\\\"+t,"g");return text.split(i).map(t=>t.replace(s,e))}class ge extends I{constructor(e){super("cmi.interactions.n.correct_responses.n"),this._pattern="",this._interactionType=e}reset(){this._initialized=!1,this._pattern=""}get pattern(){return this._pattern}set pattern(pattern){if("fill-in"!==this._interactionType||""!==pattern){if(H(this._cmi_element+".pattern",pattern,"^.*$")){if(this._interactionType){const e=ae[this._interactionType];e&&("matching"===this._interactionType&&/\\[.,]/.test(pattern)||function(type,pattern,e){if(pattern.trim()!==pattern)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);const t=e.delimiter?he(e.delimiter):null,i=t?me(pattern,t):[pattern];for(const e of i)if(e.trim()!==e)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if("fill-in"===type&&""===pattern)return;const s=e.delimiter?he(e.delimiter):null;let n;if(n=s?me(pattern,s):[pattern],!e.delimiter&&pattern.includes(","))throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if((e.unique||!1===e.duplicate)&&new Set(n).size!==n.length)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if(0===n.length||n.length>e.max)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.GENERAL_SET_FAILURE);const r=RegExp(e.format),o=e.format2?RegExp(e.format2):null,a=e=>{if(!r.test(e))throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH)},c=(e,t)=>{if(!t)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);const i=he(t),s=e.split(RegExp("(?<!\\\\)"+de(i),"g")).map(e=>e.replace(RegExp("\\\\"+de(i),"g"),i));if(2!==s.length||""===s[0]||""===s[1])throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if(void 0!==s[0]&&!r.test(s[0])||o&&void 0!==s[1]&&!o.test(s[1]))throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH)};for(const t of n)switch(type){case"numeric":{const i=e.delimiter?he(e.delimiter):":",s=t.split(i);if(1>s.length||s.length>2)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);s.forEach(a);break}case"performance":{const i=e.delimiter2;if(!i)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);const s=he(i),n=me(t,s);if(!t.includes(":")&&2!==n.length)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);const[a,c]=me(t,s);if(""===a||""===c||a===c)throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if(void 0===a||!r.test(a))throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);if(o&&void 0!==c&&!o.test(c))throw new F("cmi.interactions.n.correct_responses.n.pattern",j.TYPE_MISMATCH);break}default:e.delimiter2?c(t,e.delimiter2):a(t)}}(this._interactionType,pattern,e))}this._pattern=pattern}}else this._pattern=""}toJSON(){this.jsonString=!0;const result={pattern:this.pattern};return this.jsonString=!1,result}}const _e={101:{basicMessage:"General Exception",detailMessage:"No specific error code exists to describe the error."},201:{basicMessage:"Invalid argument error",detailMessage:"Indicates that an argument represents an invalid data model element or is otherwise incorrect."},202:{basicMessage:"Element cannot have children",detailMessage:'Indicates that LMSGetValue was called with a data model element name that ends in "_children" for a data model element that does not support the "_children" suffix.'},203:{basicMessage:"Element not an array - cannot have count",detailMessage:'Indicates that LMSGetValue was called with a data model element name that ends in "_count" for a data model element that does not support the "_count" suffix.'},301:{basicMessage:"Not initialized",detailMessage:"Indicates that an API call was made before the call to lmsInitialize."},401:{basicMessage:"Not implemented error",detailMessage:"The data model element indicated in a call to LMSGetValue or LMSSetValue is valid, but was not implemented by this LMS. SCORM 1.2 defines a set of data model elements as being optional for an LMS to implement."},402:{basicMessage:"Invalid set value, element is a keyword",detailMessage:'Indicates that LMSSetValue was called on a data model element that represents a keyword (elements that end in "_children" and "_count").'},403:{basicMessage:"Element is read only",detailMessage:"LMSSetValue was called with a data model element that can only be read."},404:{basicMessage:"Element is write only",detailMessage:"LMSGetValue was called on a data model element that can only be written to."},405:{basicMessage:"Incorrect Data Type",detailMessage:"LMSSetValue was called with a value that is not consistent with the data format of the supplied data model element."},407:{basicMessage:"Element Value Out Of Range",detailMessage:"The numeric value supplied to a LMSSetValue call is outside of the numeric range allowed for the supplied data model element."},408:{basicMessage:"Data Model Dependency Not Established",detailMessage:"Some data model elements cannot be set until another data model element was set. This error condition indicates that the prerequisite element was not set before the dependent element."}};class pe extends T{constructor(e,t){!{}.hasOwnProperty.call(_e,t+"")?super(e,101,_e[101]?.basicMessage??"General error",_e[101]?.detailMessage):super(e,t,_e[t+""]?.basicMessage||"Unknown error",_e[t+""]?.detailMessage),Object.setPrototypeOf(this,pe.prototype)}}function ve(e,t,i,s){return $(e,t,i,x.TYPE_MISMATCH,pe,s)}function fe(e,t,i,s){if(""===t)throw new pe(e,x.VALUE_OUT_OF_RANGE);return B(e,t,i,x.VALUE_OUT_OF_RANGE,pe)}const Se=new class{validateScore(e,t,i,s,n,r,o){return $(e,t,i,n,o)&&(!s||B(e,t,s,r,o))}validateScorm12Audio(e,t){return ve(e,t,U)&&fe(e,t,"-1#100")}validateScorm12Language(e,t){return ve(e,t,"^.{0,255}$")}validateScorm12Speed(e,t){return ve(e,t,U)&&fe(e,t,"-100#100")}validateScorm12Text(e,t){return ve(e,t,U)&&fe(e,t,"-1#1")}validateReadOnly(e,t){if(t)throw new pe(e,x.READ_ONLY_ELEMENT)}};class Ae extends I{constructor(e){super(e.CMIElement),this._raw="",this._min="",this.__children=e.score_children||"raw,min,max",this.__score_range=!!e.score_range&&"0#100",this._max=e.max||""===e.max?e.max:"100",this.__invalid_error_code=e.invalidErrorCode||x.INVALID_SET_VALUE,this.__invalid_type_code=e.invalidTypeCode||x.TYPE_MISMATCH,this.__invalid_range_code=e.invalidRangeCode||x.VALUE_OUT_OF_RANGE,this.__decimal_regex=e.decimalRegex||"^-?([0-9]{0,3})(\\.[0-9]*)?$",this.__error_class=e.errorClass}reset(){this._initialized=!1}get _children(){return this.__children}set _children(_children){throw new this.__error_class(this._cmi_element+"._children",this.__invalid_error_code)}get raw(){return this._raw}set raw(e){Se.validateScore(this._cmi_element+".raw",e,this.__decimal_regex,this.__score_range,this.__invalid_type_code,this.__invalid_range_code,this.__error_class)&&(this._raw=e)}get min(){return this._min}set min(e){Se.validateScore(this._cmi_element+".min",e,this.__decimal_regex,this.__score_range,this.__invalid_type_code,this.__invalid_range_code,this.__error_class)&&(this._min=e)}get max(){return this._max}set max(e){Se.validateScore(this._cmi_element+".max",e,this.__decimal_regex,this.__score_range,this.__invalid_type_code,this.__invalid_range_code,this.__error_class)&&(this._max=e)}getScoreObject(){const e={};return Number.isNaN(Number.parseFloat(this.raw))||(e.raw=Number.parseFloat(this.raw)),Number.isNaN(Number.parseFloat(this.min))||(e.min=Number.parseFloat(this.min)),Number.isNaN(Number.parseFloat(this.max))||(e.max=Number.parseFloat(this.max)),e}toJSON(){this.jsonString=!0;const result={raw:this.raw,min:this.min,max:this.max};return this.jsonString=!1,result}}class Ee extends Ae{constructor(){super({CMIElement:"cmi.score",score_children:i.score_children,max:"",invalidErrorCode:j.READ_ONLY_ELEMENT,invalidTypeCode:j.TYPE_MISMATCH,invalidRangeCode:j.VALUE_OUT_OF_RANGE,decimalRegex:K,errorClass:F}),this._scaled=""}reset(){this._initialized=!1,this._scaled="",this._raw="",this._min="",this._max=""}get scaled(){return this._scaled}set scaled(e){H(this._cmi_element+".scaled",e,K)&&V(this._cmi_element+".scaled",e,"-1#1")&&(this._scaled=e)}getScoreObject(){const e=super.getScoreObject();return Number.isNaN(Number.parseFloat(this.scaled))||(e.scaled=Number.parseFloat(this.scaled)),e}toJSON(){this.jsonString=!0;const result={scaled:this.scaled,raw:this.raw,min:this.min,max:this.max};return this.jsonString=!1,result}}class Ce extends P{constructor(){super({CMIElement:"cmi.comments_from_lms",children:i.comments_children,errorCode:j.READ_ONLY_ELEMENT,errorClass:F})}}class ye extends P{constructor(){super({CMIElement:"cmi.comments_from_learner",children:i.comments_children,errorCode:j.READ_ONLY_ELEMENT,errorClass:F})}}class be extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];super("cmi.comments_from_learner.n"),this._comment="",this._location="",this._timestamp="",this._comment="",this._location="",this._timestamp="",this._readOnlyAfterInit=e}reset(){this._initialized=!1}get comment(){return this._comment}set comment(comment){if(this.initialized&&this._readOnlyAfterInit)throw new F(this._cmi_element+".comment",j.READ_ONLY_ELEMENT);H(this._cmi_element+".comment",comment,J,!0)&&(this._comment=comment)}get location(){return this._location}set location(location){if(this.initialized&&this._readOnlyAfterInit)throw new F(this._cmi_element+".location",j.READ_ONLY_ELEMENT);H(this._cmi_element+".location",location,"^[\\u0000-\\uFFFF]{0,250}$")&&(this._location=location)}get timestamp(){return this._timestamp}set timestamp(timestamp){if(this.initialized&&this._readOnlyAfterInit)throw new F(this._cmi_element+".timestamp",j.READ_ONLY_ELEMENT);H(this._cmi_element+".timestamp",timestamp,W)&&(this._timestamp=timestamp)}toJSON(){this.jsonString=!0;const result={comment:this.comment,location:this.location,timestamp:this.timestamp};return this.jsonString=!1,result}}class Re extends P{constructor(){super({CMIElement:"cmi.objectives",children:i.objectives_children,errorCode:j.READ_ONLY_ELEMENT,errorClass:F})}findObjectiveById(id){return this.childArray.find(e=>e.id===id)}findObjectiveByIndex(e){return this.childArray[e]}setObjectiveByIndex(e,t){this.childArray[e]=t}}class we extends I{constructor(){super("cmi.objectives.n"),this._id="",this._success_status="unknown",this._completion_status="unknown",this._progress_measure="",this._description="",this.score=new Ee}reset(){this._initialized=!1}initialize(){super.initialize(),this.score?.initialize()}get id(){return this._id}set id(id){H(this._cmi_element+".id",id,Q)&&(this._id=id)}get success_status(){return this._success_status}set success_status(success_status){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".success_status",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".success_status",success_status,te)&&(this._success_status=success_status)}get completion_status(){return this._completion_status}set completion_status(completion_status){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".completion_status",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".completion_status",completion_status,ee)&&(this._completion_status=completion_status)}get progress_measure(){return this._progress_measure}set progress_measure(progress_measure){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".progress_measure",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".progress_measure",progress_measure,K)&&V(this._cmi_element+".progress_measure",progress_measure,"0#1")&&(this._progress_measure=progress_measure)}get description(){return this._description}set description(description){if(this.initialized&&""===this._id)throw new F(this._cmi_element+".description",j.DEPENDENCY_NOT_ESTABLISHED);H(this._cmi_element+".description",description,G,!0)&&(this._description=description)}toJSON(){this.jsonString=!0;const result={id:this.id,success_status:this.success_status,completion_status:this.completion_status,progress_measure:this.progress_measure,description:this.description,score:this.score};return this.jsonString=!1,result}fromJSON(e){e&&"object"==typeof e&&("string"==typeof e.id&&(this.id=e.id),"string"==typeof e.success_status&&(this.success_status=e.success_status),"string"==typeof e.completion_status&&(this.completion_status=e.completion_status),void 0!==e.progress_measure&&(this.progress_measure=e.progress_measure+""),"string"==typeof e.description&&(this.description=e.description),e.score&&"object"==typeof e.score&&(void 0!==e.score.scaled&&(this.score.scaled=e.score.scaled+""),void 0!==e.score.raw&&(this.score.raw=e.score.raw+""),void 0!==e.score.min&&(this.score.min=e.score.min+""),void 0!==e.score.max&&(this.score.max=e.score.max+"")))}}class Te extends I{constructor(){super("cmi"),this.__version="1.0",this.__children=i.cmi_children}get _version(){return this.__version}set _version(_version){throw new F(this._cmi_element+"._version",j.READ_ONLY_ELEMENT)}get _children(){return this.__children}set _children(_children){throw new F(this._cmi_element+"._children",j.READ_ONLY_ELEMENT)}reset(){this._initialized=!1}}class Me extends I{constructor(){super("cmi"),this._learner_id="",this._learner_name=""}get learner_id(){return this._learner_id}set learner_id(learner_id){if(this.initialized)throw new F(this._cmi_element+".learner_id",j.READ_ONLY_ELEMENT);this._learner_id=learner_id}get learner_name(){return this._learner_name}set learner_name(learner_name){if(this.initialized)throw new F(this._cmi_element+".learner_name",j.READ_ONLY_ELEMENT);this._learner_name=learner_name}reset(){this._initialized=!1}}class Oe extends I{constructor(){super("cmi"),this._completion_status="unknown",this._success_status="unknown",this._progress_measure=""}get completion_status(){return this._completion_status}set completion_status(completion_status){H(this._cmi_element+".completion_status",completion_status,ee)&&(this._completion_status=completion_status)}get success_status(){return this._success_status}set success_status(success_status){H(this._cmi_element+".success_status",success_status,te)&&(this._success_status=success_status)}get progress_measure(){return this._progress_measure}set progress_measure(progress_measure){H(this._cmi_element+".progress_measure",progress_measure,K)&&V(this._cmi_element+".progress_measure",progress_measure,"0#1")&&(this._progress_measure=progress_measure)}reset(){this._initialized=!1,this._completion_status="unknown",this._success_status="unknown",this._progress_measure=""}}class Ne extends I{constructor(){super("cmi"),this._entry="",this._exit="",this._session_time="PT0H0M0S",this._total_time=""}get entry(){return this._entry}set entry(entry){if(this.initialized)throw new F(this._cmi_element+".entry",j.READ_ONLY_ELEMENT);this._entry=entry}get exit(){if(!this.jsonString)throw new F(this._cmi_element+".exit",j.WRITE_ONLY_ELEMENT);return this._exit}set exit(exit){H(this._cmi_element+".exit",exit,"^(time-out|suspend|logout|normal)$",!0)&&(this._exit=exit)}get session_time(){if(!this.jsonString)throw new F(this._cmi_element+".session_time",j.WRITE_ONLY_ELEMENT);return this._session_time}set session_time(session_time){H(this._cmi_element+".session_time",session_time,X)&&(this._session_time=session_time)}get total_time(){return this._total_time}set total_time(total_time){if(this.initialized)throw new F(this._cmi_element+".total_time",j.READ_ONLY_ELEMENT);this._total_time=total_time}getCurrentTotalTime(e){let t=this._session_time;if(null!=e){const i=(new Date).getTime()-e;t=n(i/1e3)}return function(e,t,i){const s=RegExp(i);return n(r(e,s)+r(t,s))}(this._total_time,t,X)}reset(){this._initialized=!1,this._entry="",this._exit="",this._session_time="PT0H0M0S"}}class qe extends I{constructor(){super("cmi"),this._location="",this._launch_data="",this._suspend_data=""}get location(){return this._location}set location(location){H(this._cmi_element+".location",location,"^[\\u0000-\\uFFFF]{0,1000}$")&&(this._location=location)}get launch_data(){return this._launch_data}set launch_data(launch_data){if(this.initialized)throw new F(this._cmi_element+".launch_data",j.READ_ONLY_ELEMENT);this._launch_data=launch_data}get suspend_data(){return this._suspend_data}set suspend_data(suspend_data){H(this._cmi_element+".suspend_data",suspend_data,"^[\\u0000-\\uFFFF]{0,64000}$",!0)&&(this._suspend_data=suspend_data)}reset(){this._initialized=!1,this._location="",this._suspend_data=""}}class Ie extends I{constructor(){super("cmi"),this._credit="credit",this._mode="normal",this._time_limit_action="continue,no message",this._max_time_allowed=""}get credit(){return this._credit}set credit(credit){if(this.initialized)throw new F(this._cmi_element+".credit",j.READ_ONLY_ELEMENT);this._credit=credit}get mode(){return this._mode}set mode(mode){if(this.initialized)throw new F(this._cmi_element+".mode",j.READ_ONLY_ELEMENT);this._mode=mode}get time_limit_action(){return this._time_limit_action}set time_limit_action(time_limit_action){if(this.initialized)throw new F(this._cmi_element+".time_limit_action",j.READ_ONLY_ELEMENT);this._time_limit_action=time_limit_action}get max_time_allowed(){return this._max_time_allowed}set max_time_allowed(max_time_allowed){if(this.initialized)throw new F(this._cmi_element+".max_time_allowed",j.READ_ONLY_ELEMENT);this._max_time_allowed=max_time_allowed}reset(){this._initialized=!1}}class Le extends I{constructor(){super("cmi"),this._scaled_passing_score="",this._completion_threshold=""}get scaled_passing_score(){return this._scaled_passing_score}set scaled_passing_score(scaled_passing_score){if(this.initialized)throw new F(this._cmi_element+".scaled_passing_score",j.READ_ONLY_ELEMENT??404);this._scaled_passing_score=scaled_passing_score}get completion_threshold(){return this._completion_threshold}set completion_threshold(e){if(this.initialized)throw new F(this._cmi_element+".completion_threshold",j.READ_ONLY_ELEMENT??404);this._completion_threshold=e}reset(){this._initialized=!1}}class De extends L{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];super("cmi"),this.metadata=new Te,this.learner=new Me,this.status=new Oe,this.session=new Ne,this.content=new qe,this.settings=new Ie,this.thresholds=new Le,this.learner_preference=new re,this.score=new Ee,this.comments_from_learner=new ye,this.comments_from_lms=new Ce,this.interactions=new ce,this.objectives=new Re,e&&this.initialize()}initialize(){super.initialize(),this.metadata?.initialize(),this.learner?.initialize(),this.status?.initialize(),this.session?.initialize(),this.content?.initialize(),this.settings?.initialize(),this.thresholds?.initialize(),this.learner_preference?.initialize(),this.score?.initialize(),this.comments_from_learner?.initialize(),this.comments_from_lms?.initialize(),this.interactions?.initialize(),this.objectives?.initialize()}reset(){this._initialized=!1,this.metadata?.reset(),this.learner?.reset(),this.status?.reset(),this.session?.reset(),this.content?.reset(),this.settings?.reset(),this.thresholds?.reset(),this.objectives?.reset(!1),this.interactions?.reset(!0),this.score?.reset(),this.comments_from_learner?.reset(),this.comments_from_lms?.reset(),this.learner_preference?.reset()}get _version(){return this.metadata._version}set _version(_version){this.metadata._version=_version}get _children(){return this.metadata._children}set _children(_children){this.metadata._children=_children}get completion_status(){return this.status.completion_status}set completion_status(completion_status){this.status.completion_status=completion_status}get completion_threshold(){return this.thresholds.completion_threshold}set completion_threshold(e){this.thresholds.completion_threshold=e}get credit(){return this.settings.credit}set credit(credit){this.settings.credit=credit}get entry(){return this.session.entry}set entry(entry){this.session.entry=entry}get exit(){return this.session.jsonString=this.jsonString,this.session.exit}set exit(exit){this.session.exit=exit}get launch_data(){return this.content.launch_data}set launch_data(launch_data){this.content.launch_data=launch_data}get learner_id(){return this.learner.learner_id}set learner_id(learner_id){this.learner.learner_id=learner_id}get learner_name(){return this.learner.learner_name}set learner_name(learner_name){this.learner.learner_name=learner_name}get location(){return this.content.location}set location(location){this.content.location=location}get max_time_allowed(){return this.settings.max_time_allowed}set max_time_allowed(max_time_allowed){this.settings.max_time_allowed=max_time_allowed}get mode(){return this.settings.mode}set mode(mode){this.settings.mode=mode}get progress_measure(){return this.status.progress_measure}set progress_measure(progress_measure){this.status.progress_measure=progress_measure}get scaled_passing_score(){return this.thresholds.scaled_passing_score}set scaled_passing_score(scaled_passing_score){this.thresholds.scaled_passing_score=scaled_passing_score}get session_time(){return this.session.jsonString=this.jsonString,this.session.session_time}set session_time(session_time){this.session.session_time=session_time}get success_status(){return this.status.success_status}set success_status(success_status){this.status.success_status=success_status}get suspend_data(){return this.content.suspend_data}set suspend_data(suspend_data){this.content.suspend_data=suspend_data}get time_limit_action(){return this.settings.time_limit_action}set time_limit_action(time_limit_action){this.settings.time_limit_action=time_limit_action}get total_time(){return this.session.total_time}set total_time(total_time){this.session.total_time=total_time}getCurrentTotalTime(){return this.session.getCurrentTotalTime(this.start_time)}toJSON(){this.jsonString=!0,this.session.jsonString=!0;const result={comments_from_learner:this.comments_from_learner,comments_from_lms:this.comments_from_lms,completion_status:this.completion_status,completion_threshold:this.completion_threshold,credit:this.credit,entry:this.entry,exit:this.exit,interactions:this.interactions,launch_data:this.launch_data,learner_id:this.learner_id,learner_name:this.learner_name,learner_preference:this.learner_preference,location:this.location,max_time_allowed:this.max_time_allowed,mode:this.mode,objectives:this.objectives,progress_measure:this.progress_measure,scaled_passing_score:this.scaled_passing_score,score:this.score,session_time:this.session_time,success_status:this.success_status,suspend_data:this.suspend_data,time_limit_action:this.time_limit_action};return this.jsonString=!1,this.session.jsonString=!1,result}}class xe extends I{constructor(){super("adl"),this.data=new Pe,this._sequencing=null,this.nav=new je,this.data=new Pe}initialize(){super.initialize(),this.nav?.initialize()}reset(){this._initialized=!1,this.nav?.reset()}get sequencing(){return this._sequencing}set sequencing(e){this._sequencing=e,e&&(e.adlNav=this.nav,this.nav.sequencing=e)}toJSON(){this.jsonString=!0;const result={nav:this.nav,data:this.data};return this.jsonString=!1,result}}class je extends I{constructor(){super("adl.nav"),this._request="_none_",this._sequencing=null,this.request_valid=new ke}get sequencing(){return this._sequencing}set sequencing(e){this._sequencing=e}initialize(){super.initialize(),this.request_valid?.initialize()}reset(){this._initialized=!1,this._request="_none_",this._sequencing&&(this._sequencing.adlNav=null),this._sequencing=null,this.request_valid?.reset()}get request(){return this._request}set request(request){H(this._cmi_element+".request",request,ie)&&(this._request=request)}toJSON(){this.jsonString=!0;const result={request:this.request};return this.jsonString=!1,result}}class Pe extends P{constructor(){super({CMIElement:"adl.data",children:i.adl_data_children,errorCode:j.READ_ONLY_ELEMENT,errorClass:F})}}class ze extends I{constructor(){super("adl.data.n"),this._id="",this._store=""}reset(){this._initialized=!1}get id(){return this._id}set id(id){H(this._cmi_element+".id",id,Q)&&(this._id=id)}get store(){return this._store}set store(e){H(this._cmi_element+".store",e,J)&&(this._store=e)}toJSON(){this.jsonString=!0;const result={id:this._id,store:this._store};return this.jsonString=!1,result}}class ke extends I{constructor(){super("adl.nav.request_valid"),this._continue="unknown",this._previous="unknown",this._choice={},this._jump={},this._exit="unknown",this._exitAll="unknown",this._abandon="unknown",this._abandonAll="unknown",this._suspendAll="unknown"}reset(){this._initialized=!1,this._continue="unknown",this._previous="unknown",this._choice={},this._jump={},this._exit="unknown",this._exitAll="unknown",this._abandon="unknown",this._abandonAll="unknown",this._suspendAll="unknown"}get continue(){return this._continue}set continue(e){if(this.initialized)throw new F(this._cmi_element+".continue",j.READ_ONLY_ELEMENT);H(this._cmi_element+".continue",e,se)&&(this._continue=e)}get previous(){return this._previous}set previous(e){if(this.initialized)throw new F(this._cmi_element+".previous",j.READ_ONLY_ELEMENT);H(this._cmi_element+".previous",e,se)&&(this._previous=e)}get choice(){return this._choice}set choice(e){if(this.initialized)throw new F(this._cmi_element+".choice",j.READ_ONLY_ELEMENT);if("object"!=typeof e)throw new F(this._cmi_element+".choice",j.TYPE_MISMATCH);for(const t in e)if({}.hasOwnProperty.call(e,t)&&H(this._cmi_element+".choice."+t,e[t]||"",se)&&H(this._cmi_element+".choice."+t,t,ne)){const i=e[t];"true"===i?this._choice[t]=h:"false"===i?this._choice[t]=d:"unknown"===i&&(this._choice[t]=u)}}get jump(){return this._jump}set jump(e){if(this.initialized)throw new F(this._cmi_element+".jump",j.READ_ONLY_ELEMENT);if("object"!=typeof e)throw new F(this._cmi_element+".jump",j.TYPE_MISMATCH);for(const t in e)if({}.hasOwnProperty.call(e,t)&&H(this._cmi_element+".jump."+t,e[t]||"",se)&&H(this._cmi_element+".jump."+t,t,ne)){const i=e[t];"true"===i?this._jump[t]=h:"false"===i?this._jump[t]=d:"unknown"===i&&(this._jump[t]=u)}}get exit(){return this._exit}set exit(e){if(this.initialized)throw new F(this._cmi_element+".exit",j.READ_ONLY_ELEMENT);H(this._cmi_element+".exit",e,se)&&(this._exit=e)}get exitAll(){return this._exitAll}set exitAll(e){if(this.initialized)throw new F(this._cmi_element+".exitAll",j.READ_ONLY_ELEMENT);H(this._cmi_element+".exitAll",e,se)&&(this._exitAll=e)}get abandon(){return this._abandon}set abandon(e){if(this.initialized)throw new F(this._cmi_element+".abandon",j.READ_ONLY_ELEMENT);H(this._cmi_element+".abandon",e,se)&&(this._abandon=e)}get abandonAll(){return this._abandonAll}set abandonAll(e){if(this.initialized)throw new F(this._cmi_element+".abandonAll",j.READ_ONLY_ELEMENT);H(this._cmi_element+".abandonAll",e,se)&&(this._abandonAll=e)}get suspendAll(){return this._suspendAll}set suspendAll(e){if(this.initialized)throw new F(this._cmi_element+".suspendAll",j.READ_ONLY_ELEMENT);H(this._cmi_element+".suspendAll",e,se)&&(this._suspendAll=e)}toJSON(){this.jsonString=!0;const result={previous:this._previous,continue:this._continue,choice:this._choice,jump:this._jump};return this.jsonString=!1,result}}var Fe=(e=>(e.NOT="not",e.AND="and",e.OR="or",e))(Fe||{}),$e=(e=>(e.SKIP="skip",e.DISABLED="disabled",e.HIDE_FROM_CHOICE="hideFromChoice",e.STOP_FORWARD_TRAVERSAL="stopForwardTraversal",e.EXIT_PARENT="exitParent",e.EXIT_ALL="exitAll",e.RETRY="retry",e.RETRY_ALL="retryAll",e.CONTINUE="continue",e.PREVIOUS="previous",e.EXIT="exit",e))($e||{});const Be=class e extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"always",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map;super("ruleCondition"),this._condition="always",this._operator=null,this._parameters=new Map,this._condition=e,this._operator=t,this._parameters=i}static setNowProvider(t){"function"==typeof t&&(e._now=t)}reset(){this._initialized=!1,this._condition="always",this._operator=null,this._parameters=new Map}get condition(){return this._condition}set condition(e){this._condition=e}get operator(){return this._operator}set operator(e){this._operator=e}get parameters(){return this._parameters}set parameters(e){this._parameters=e}evaluate(e){let result;switch(this._condition){case"satisfied":result=e.successStatus===m;break;case"objectiveStatusKnown":case"objectiveMeasureKnown":result=!!e.objectiveMeasureStatus;break;case"objectiveMeasureGreaterThan":{const t=this._parameters.get("threshold")||0;result=e.objectiveMeasureStatus&&e.objectiveNormalizedMeasure>t;break}case"objectiveMeasureLessThan":{const t=this._parameters.get("threshold")||0;result=e.objectiveMeasureStatus&&t>e.objectiveNormalizedMeasure;break}case"completed":result=e.isCompleted;break;case"progressKnown":result="unknown"!==e.completionStatus;break;case"attempted":result=e.attemptCount>0;break;case"attemptLimitExceeded":{const t=this._parameters.get("attemptLimit")||0;result=e.attemptCount>=t;break}case"timeLimitExceeded":result=this.evaluateTimeLimitExceeded(e);break;case"outsideAvailableTimeRange":result=this.evaluateOutsideAvailableTimeRange(e);break;case"always":result=!0;break;default:result=!1}return"not"===this._operator&&(result=!result),result}evaluateTimeLimitExceeded(e){const t=e.timeLimitDuration;if(!t)return!1;const i=this.parseISO8601Duration(t);return 0!==i&&this.parseISO8601Duration(e.attemptExperiencedDuration)>i}evaluateOutsideAvailableTimeRange(t){const i=t.beginTimeLimit,s=t.endTimeLimit;if(!i&&!s)return!1;const n=e._now();return!(!i||n>=new Date(i))||!(!s||new Date(s)>=n)}parseISO8601Duration(e){const t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?/);return t?1e3*(3600*parseInt(t[1]||"0",10)+60*parseInt(t[2]||"0",10)+parseFloat(t[3]||"0")):0}toJSON(){this.jsonString=!0;const result={condition:this._condition,operator:this._operator,parameters:Object.fromEntries(this._parameters)};return this.jsonString=!1,result}};Be._now=()=>new Date;let He=Be;class Ve extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"skip",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"and";super("sequencingRule"),this._conditions=[],this._action="skip",this._conditionCombination="and",this._action=e,this._conditionCombination=t}reset(){this._initialized=!1,this._conditions=[],this._action="skip",this._conditionCombination="and"}get conditions(){return this._conditions}addCondition(e){if(!(e instanceof He))throw new F(this._cmi_element+".conditions",j.TYPE_MISMATCH);this._conditions.includes(e)||this._conditions.push(e)}removeCondition(e){if(!(e instanceof He))throw new F(this._cmi_element+".conditions",j.TYPE_MISMATCH);const t=this._conditions.indexOf(e);return-1!==t&&(this._conditions.splice(t,1),!0)}get action(){return this._action}set action(e){this._action=e}get conditionCombination(){return this._conditionCombination}set conditionCombination(e){this._conditionCombination=e}evaluate(e){return 0===this._conditions.length||("all"===this._conditionCombination||"and"===this._conditionCombination?this._conditions.every(t=>t.evaluate(e)):("any"===this._conditionCombination||"or"===this._conditionCombination)&&this._conditions.some(t=>t.evaluate(e)))}toJSON(){this.jsonString=!0;const result={conditions:this._conditions,action:this._action,conditionCombination:this._conditionCombination};return this.jsonString=!1,result}}class Ue extends I{constructor(){super("sequencingRules"),this._preConditionRules=[],this._exitConditionRules=[],this._postConditionRules=[]}reset(){this._initialized=!1,this._preConditionRules=[],this._exitConditionRules=[],this._postConditionRules=[]}get preConditionRules(){return this._preConditionRules}addPreConditionRule(e){if(!(e instanceof Ve))throw new F(this._cmi_element+".preConditionRules",j.TYPE_MISMATCH);this._preConditionRules.push(e)}get exitConditionRules(){return this._exitConditionRules}addExitConditionRule(e){if(!(e instanceof Ve))throw new F(this._cmi_element+".exitConditionRules",j.TYPE_MISMATCH);this._exitConditionRules.push(e)}get postConditionRules(){return this._postConditionRules}addPostConditionRule(e){if(!(e instanceof Ve))throw new F(this._cmi_element+".postConditionRules",j.TYPE_MISMATCH);this._postConditionRules.push(e)}evaluatePreConditionRules(e){for(const t of this._preConditionRules)if(t.evaluate(e))return t.action;return null}evaluateExitConditionRules(e){for(const t of this._exitConditionRules)if(t.evaluate(e))return t.action;return null}evaluatePostConditionRules(e){for(const t of this._postConditionRules)if(t.evaluate(e))return t.action;return null}toJSON(){this.jsonString=!0;const result={preConditionRules:this._preConditionRules,exitConditionRules:this._exitConditionRules,postConditionRules:this._postConditionRules};return this.jsonString=!1,result}}var Ye=(e=>(e.SATISFIED="satisfied",e.NOT_SATISFIED="notSatisfied",e.COMPLETED="completed",e.INCOMPLETE="incomplete",e))(Ye||{}),Ge=(e=>(e.ALL="all",e.ANY="any",e.NONE="none",e.AT_LEAST_COUNT="atLeastCount",e.AT_LEAST_PERCENT="atLeastPercent",e))(Ge||{});class Je extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"always",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map;super("rollupCondition"),this._condition="always",this._parameters=new Map,this._condition=e,this._parameters=t}reset(){this._initialized=!1}get condition(){return this._condition}set condition(e){this._condition=e}get parameters(){return this._parameters}set parameters(e){this._parameters=e}evaluate(e){switch(this._condition){case"satisfied":return e.successStatus===m;case"objectiveStatusKnown":case"objectiveMeasureKnown":return e.objectiveMeasureStatus;case"objectiveMeasureGreaterThan":{const t=this._parameters.get("threshold")||0;return e.objectiveMeasureStatus&&e.objectiveNormalizedMeasure>t}case"objectiveMeasureLessThan":{const t=this._parameters.get("threshold")||0;return e.objectiveMeasureStatus&&t>e.objectiveNormalizedMeasure}case"completed":return e.isCompleted;case"progressKnown":return e.completionStatus!==f;case"attempted":return e.attemptCount>0;case"notAttempted":return 0===e.attemptCount;case"always":return!0;default:return!1}}toJSON(){this.jsonString=!0;const result={condition:this._condition,parameters:Object.fromEntries(this._parameters)};return this.jsonString=!1,result}}class We extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"satisfied",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;super("rollupRule"),this._conditions=[],this._action="satisfied",this._consideration="all",this._minimumCount=0,this._minimumPercent=0,this._action=e,this._consideration=t,this._minimumCount=i,this._minimumPercent=s}reset(){this._initialized=!1,this._conditions=[]}get conditions(){return this._conditions}addCondition(e){if(!(e instanceof Je))throw new F(this._cmi_element+".conditions",j.TYPE_MISMATCH);this._conditions.push(e)}removeCondition(e){const t=this._conditions.indexOf(e);return-1!==t&&(this._conditions.splice(t,1),!0)}get action(){return this._action}set action(e){this._action=e}get consideration(){return this._consideration}set consideration(e){this._consideration=e}get minimumCount(){return this._minimumCount}set minimumCount(e){0>e||(this._minimumCount=e)}get minimumPercent(){return this._minimumPercent}set minimumPercent(e){0>e||e>100||(this._minimumPercent=e)}evaluate(e){if(0===e.length)return!1;const t=e.filter(e=>this._conditions.every(t=>t.evaluate(e)));switch(this._consideration){case"all":return t.length===e.length;case"any":return t.length>0;case"none":return 0===t.length;case"atLeastCount":return t.length>=this._minimumCount;case"atLeastPercent":return t.length/e.length*100>=this._minimumPercent;default:return!1}}toJSON(){this.jsonString=!0;const result={conditions:this._conditions,action:this._action,consideration:this._consideration,minimumCount:this._minimumCount,minimumPercent:this._minimumPercent};return this.jsonString=!1,result}}class Xe extends I{constructor(){super("rollupRules"),this._rules=[]}reset(){this._initialized=!1,this._rules=[]}get rules(){return this._rules}addRule(e){if(!(e instanceof We))throw new F(this._cmi_element+".rules",j.TYPE_MISMATCH);this._rules.push(e)}removeRule(e){const t=this._rules.indexOf(e);return-1!==t&&(this._rules.splice(t,1),!0)}processRollup(e){if(!e||0===e.children.length)return;const t=e.getAvailableChildren();let i=!1,s=!1;if(e.sequencingControls.rollupObjectiveSatisfied&&null!==this._objectiveRollupUsingMeasure(e,t)&&(s=!0),!s)for(const n of this._rules)if(n.evaluate(t))switch(n.action){case"satisfied":e.successStatus=m,s=!0;break;case"notSatisfied":e.successStatus=g,s=!0;break;case"completed":e.completionStatus=p,e.isCompleted=!0,i=!0;break;case"incomplete":e.completionStatus=v,e.isCompleted=!1,i=!0}i||this._defaultCompletionRollup(e,t),s||this._defaultSuccessRollup(e,t)}_defaultCompletionRollup(e,t){t.every(e=>e.isCompleted)?(e.completionStatus=p,e.isCompleted=!0):t.some(e=>e.completionStatus===v)&&(e.completionStatus=v,e.isCompleted=!1)}_objectiveRollupUsingMeasure(e,t){if(0>=e.sequencingControls.objectiveMeasureWeight)return null;let i=0,s=0,n=!1;for(const e of t)if(e.sequencingControls.rollupObjectiveSatisfied&&e.objectiveMeasureStatus&&!0===e.objectiveMeasureStatus){const t=e.sequencingControls.objectiveMeasureWeight;t>0&&(s+=e.objectiveNormalizedMeasure*t,i+=t,n=!0)}if(!n||0===i)return null;const r=s/i;return e.objectiveNormalizedMeasure=r,e.objectiveMeasureStatus=!0,e.scaledPassingScore>r?(e.successStatus=g,e.objectiveSatisfiedStatus=!1,!1):(e.successStatus=m,e.objectiveSatisfiedStatus=!0,!0)}_defaultSuccessRollup(e,t){t.every(e=>e.successStatus===m)?e.successStatus=m:t.some(e=>e.successStatus===g)&&(e.successStatus=g)}toJSON(){this.jsonString=!0;const result={rules:this._rules};return this.jsonString=!1,result}}const Ke=["aa","ab","ae","af","ak","am","an","ar","as","av","ay","az","ba","be","bg","bh","bi","bm","bn","bo","br","bs","ca","ce","ch","co","cr","cs","cu","cv","cy","da","de","dv","dz","ee","el","en","eo","es","et","eu","fa","ff","fi","fj","fo","fr","fy","ga","gd","gl","gn","gu","gv","ha","he","hi","ho","hr","ht","hu","hy","hz","ia","id","ie","ig","ii","ik","io","is","it","iu","ja","jv","ka","kg","ki","kj","kk","kl","km","kn","ko","kr","ks","ku","kv","kw","ky","la","lb","lg","li","ln","lo","lt","lu","lv","mg","mh","mi","mk","ml","mn","mo","mr","ms","mt","my","na","nb","nd","ne","ng","nl","nn","no","nr","nv","ny","oc","oj","om","or","os","pa","pi","pl","ps","pt","qu","rm","rn","ro","ru","rw","sa","sc","sd","se","sg","sh","si","sk","sl","sm","sn","so","sq","sr","ss","st","su","sv","sw","ta","te","tg","th","ti","tk","tl","tn","to","tr","ts","tt","tw","ty","ug","uk","ur","uz","ve","vi","vo","wa","wo","xh","yi","yo","za","zh","zu","aar","abk","ave","afr","aka","amh","arg","ara","asm","ava","aym","aze","bak","bel","bul","bih","bis","bam","ben","tib","bod","bre","bos","cat","che","cha","cos","cre","cze","ces","chu","chv","wel","cym","dan","ger","deu","div","dzo","ewe","gre","ell","eng","epo","spa","est","baq","eus","per","fas","ful","fin","fij","fao","fre","fra","fry","gle","gla","glg","grn","guj","glv","hau","heb","hin","hmo","hrv","hat","hun","arm","hye","her","ina","ind","ile","ibo","iii","ipk","ido","ice","isl","ita","iku","jpn","jav","geo","kat","kon","kik","kua","kaz","kal","khm","kan","kor","kau","kas","kur","kom","cor","kir","lat","ltz","lug","lim","lin","lao","lit","lub","lav","mlg","mah","mao","mri","mac","mkd","mal","mon","mol","mar","may","msa","mlt","bur","mya","nau","nob","nde","nep","ndo","dut","nld","nno","nor","nbl","nav","nya","oci","oji","orm","ori","oss","pan","pli","pol","pus","por","que","roh","run","rum","ron","rus","kin","san","srd","snd","sme","sag","slo","sin","slk","slv","smo","sna","som","alb","sqi","srp","ssw","sot","sun","swe","swa","tam","tel","tgk","tha","tir","tuk","tgl","tsn","ton","tur","tso","tat","twi","tah","uig","ukr","urd","uzb","ven","vie","vol","wln","wol","xho","yid","yor","zha","chi","zho","zul"];var Ze=(e=>(e.NEVER="never",e.ONCE="once",e.ON_EACH_NEW_ATTEMPT="onEachNewAttempt",e))(Ze||{}),Qe=(e=>(e.NEVER="never",e.ONCE="once",e.ON_EACH_NEW_ATTEMPT="onEachNewAttempt",e))(Qe||{});class et extends I{constructor(){super("sequencingControls"),this._enabled=!0,this._choice=!0,this._choiceExit=!0,this._flow=!1,this._forwardOnly=!1,this._useCurrentAttemptObjectiveInfo=!0,this._useCurrentAttemptProgressInfo=!0,this._preventActivation=!1,this._constrainChoice=!1,this._stopForwardTraversal=!1,this._rollupObjectiveSatisfied=!0,this._rollupProgressCompletion=!0,this._objectiveMeasureWeight=1,this._selectionTiming="never",this._selectCount=null,this._selectionCountStatus=!1,this._randomizeChildren=!1,this._randomizationTiming="never",this._reorderChildren=!1}reset(){this._initialized=!1,this._enabled=!0,this._choice=!0,this._choiceExit=!0,this._flow=!1,this._forwardOnly=!1,this._useCurrentAttemptObjectiveInfo=!0,this._useCurrentAttemptProgressInfo=!0,this._preventActivation=!1,this._constrainChoice=!1,this._stopForwardTraversal=!1,this._rollupObjectiveSatisfied=!0,this._rollupProgressCompletion=!0,this._objectiveMeasureWeight=1,this._selectionTiming="never",this._selectCount=null,this._selectionCountStatus=!1,this._randomizeChildren=!1,this._randomizationTiming="never",this._reorderChildren=!1}get enabled(){return this._enabled}set enabled(e){this._enabled=e}get choice(){return this._choice}set choice(e){this._choice=e}get choiceExit(){return this._choiceExit}set choiceExit(e){this._choiceExit=e}get flow(){return this._flow}set flow(e){this._flow=e}get forwardOnly(){return this._forwardOnly}set forwardOnly(e){this._forwardOnly=e}get useCurrentAttemptObjectiveInfo(){return this._useCurrentAttemptObjectiveInfo}set useCurrentAttemptObjectiveInfo(e){this._useCurrentAttemptObjectiveInfo=e}get useCurrentAttemptProgressInfo(){return this._useCurrentAttemptProgressInfo}set useCurrentAttemptProgressInfo(e){this._useCurrentAttemptProgressInfo=e}get preventActivation(){return this._preventActivation}set preventActivation(e){this._preventActivation=e}get constrainChoice(){return this._constrainChoice}set constrainChoice(e){this._constrainChoice=e}get stopForwardTraversal(){return this._stopForwardTraversal}set stopForwardTraversal(e){this._stopForwardTraversal=e}get rollupObjectiveSatisfied(){return this._rollupObjectiveSatisfied}set rollupObjectiveSatisfied(e){this._rollupObjectiveSatisfied=e}get rollupProgressCompletion(){return this._rollupProgressCompletion}set rollupProgressCompletion(e){this._rollupProgressCompletion=e}get objectiveMeasureWeight(){return this._objectiveMeasureWeight}set objectiveMeasureWeight(e){0>e||(this._objectiveMeasureWeight=e)}isChoiceNavigationAllowed(){return this._enabled&&!this._constrainChoice}isFlowNavigationAllowed(){return this._enabled&&this._flow}isForwardNavigationAllowed(){return this._enabled&&this._flow}isBackwardNavigationAllowed(){return this._enabled&&this._flow&&!this._forwardOnly}get selectionTiming(){return this._selectionTiming}set selectionTiming(e){this._selectionTiming=e}get selectCount(){return this._selectCount}set selectCount(e){(null===e||e>0)&&(this._selectCount=e)}get selectionCountStatus(){return this._selectionCountStatus}set selectionCountStatus(e){this._selectionCountStatus=e}get randomizeChildren(){return this._randomizeChildren}set randomizeChildren(e){this._randomizeChildren=e}get randomizationTiming(){return this._randomizationTiming}set randomizationTiming(e){this._randomizationTiming=e}get reorderChildren(){return this._reorderChildren}set reorderChildren(e){this._reorderChildren=e}toJSON(){this.jsonString=!0;const result={enabled:this._enabled,choice:this._choice,choiceExit:this._choiceExit,flow:this._flow,forwardOnly:this._forwardOnly,useCurrentAttemptObjectiveInfo:this._useCurrentAttemptObjectiveInfo,useCurrentAttemptProgressInfo:this._useCurrentAttemptProgressInfo,preventActivation:this._preventActivation,constrainChoice:this._constrainChoice,stopForwardTraversal:this._stopForwardTraversal,rollupObjectiveSatisfied:this._rollupObjectiveSatisfied,rollupProgressCompletion:this._rollupProgressCompletion,objectiveMeasureWeight:this._objectiveMeasureWeight,selectionTiming:this._selectionTiming,selectCount:this._selectCount,selectionCountStatus:this._selectionCountStatus,randomizeChildren:this._randomizeChildren,randomizationTiming:this._randomizationTiming,reorderChildren:this._reorderChildren};return this.jsonString=!1,result}}class tt extends I{constructor(){let id=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";super("activity"),this._id="",this._title="",this._children=[],this._parent=null,this._isVisible=!0,this._isActive=!1,this._isSuspended=!1,this._isCompleted=!1,this._completionStatus=f,this._successStatus=_,this._attemptCount=0,this._attemptCompletionAmount=0,this._attemptAbsoluteDuration="PT0H0M0S",this._attemptExperiencedDuration="PT0H0M0S",this._activityAbsoluteDuration="PT0H0M0S",this._activityExperiencedDuration="PT0H0M0S",this._objectiveSatisfiedStatus=!1,this._objectiveMeasureStatus=!1,this._objectiveNormalizedMeasure=0,this._scaledPassingScore=.7,this._progressMeasure=0,this._progressMeasureStatus=!1,this._location="",this._attemptAbsoluteStartTime="",this._learnerPrefs=null,this._activityAttemptActive=!1,this._isHiddenFromChoice=!1,this._isAvailable=!0,this._attemptLimit=null,this._attemptAbsoluteDurationLimit=null,this._activityAbsoluteDurationLimit=null,this._timeLimitAction=null,this._timeLimitDuration=null,this._beginTimeLimit=null,this._endTimeLimit=null,this._processedChildren=null,this._isNewAttempt=!1,this._id=id,this._title=e,this._sequencingControls=new et,this._sequencingRules=new Ue,this._rollupRules=new Xe}initialize(){super.initialize();for(const e of this._children)e.initialize()}reset(){this._initialized=!1,this._isActive=!1,this._isSuspended=!1,this._isCompleted=!1,this._completionStatus=f,this._successStatus=_,this._attemptCount=0,this._attemptCompletionAmount=0,this._attemptAbsoluteDuration="PT0H0M0S",this._attemptExperiencedDuration="PT0H0M0S",this._activityAbsoluteDuration="PT0H0M0S",this._activityExperiencedDuration="PT0H0M0S",this._objectiveSatisfiedStatus=!1,this._objectiveMeasureStatus=!1,this._objectiveNormalizedMeasure=0,this._progressMeasure=0,this._progressMeasureStatus=!1,this._location="",this._attemptAbsoluteStartTime="",this._learnerPrefs=null,this._activityAttemptActive=!1;for(const e of this._children)e.reset()}get id(){return this._id}set id(id){H(this._cmi_element+".id",id,Q)&&(this._id=id)}get title(){return this._title}set title(e){H(this._cmi_element+".title",e,G)&&(this._title=e)}get children(){return this._children}addChild(e){if(!(e instanceof tt))throw new F(this._cmi_element+".children",j.TYPE_MISMATCH);e._parent=this,this._children.push(e)}removeChild(e){const t=this._children.indexOf(e);return-1!==t&&(this._children.splice(t,1),e._parent=null,!0)}get parent(){return this._parent}get isVisible(){return this._isVisible}set isVisible(e){this._isVisible=e}get isActive(){return this._isActive}set isActive(e){this._isActive=e}get isSuspended(){return this._isSuspended}set isSuspended(e){this._isSuspended=e}get isCompleted(){return this._isCompleted}set isCompleted(e){this._isCompleted=e,this._completionStatus=e?p:v}get completionStatus(){return this._completionStatus}set completionStatus(e){this._completionStatus=e,this._isCompleted=e===p}get successStatus(){return this._successStatus}set successStatus(e){this._successStatus=e}get attemptCount(){return this._attemptCount}set attemptCount(e){this._attemptCount=e}get attemptCompletionAmount(){return this._attemptCompletionAmount}set attemptCompletionAmount(e){this._attemptCompletionAmount=e}incrementAttemptCount(){this._attemptCount++,this._isNewAttempt=!0;const e=this._sequencingControls;"onEachNewAttempt"!==e.selectionTiming&&"onEachNewAttempt"!==e.randomizationTiming||(this._processedChildren=null)}get objectiveSatisfiedStatus(){return this._objectiveSatisfiedStatus}set objectiveSatisfiedStatus(e){this._objectiveSatisfiedStatus=e,this._successStatus=e?m:g}get objectiveMeasureStatus(){return this._objectiveMeasureStatus}set objectiveMeasureStatus(e){this._objectiveMeasureStatus=e}get objectiveNormalizedMeasure(){return this._objectiveNormalizedMeasure}set objectiveNormalizedMeasure(e){this._objectiveNormalizedMeasure=e}get scaledPassingScore(){return this._scaledPassingScore}set scaledPassingScore(e){-1>e||e>1||(this._scaledPassingScore=e)}get progressMeasure(){return this._progressMeasure}set progressMeasure(e){this._progressMeasure=e}get progressMeasureStatus(){return this._progressMeasureStatus}set progressMeasureStatus(e){this._progressMeasureStatus=e}get location(){return this._location}set location(location){this._location=location}get attemptAbsoluteStartTime(){return this._attemptAbsoluteStartTime}set attemptAbsoluteStartTime(e){this._attemptAbsoluteStartTime=e}get learnerPrefs(){return this._learnerPrefs}set learnerPrefs(e){this._learnerPrefs=e}get activityAttemptActive(){return this._activityAttemptActive}set activityAttemptActive(e){this._activityAttemptActive=e}get isHiddenFromChoice(){return this._isHiddenFromChoice}set isHiddenFromChoice(e){this._isHiddenFromChoice=e}get isAvailable(){return this._isAvailable}set isAvailable(e){this._isAvailable=e}get attemptLimit(){return this._attemptLimit}set attemptLimit(e){this._attemptLimit=e}hasAttemptLimitExceeded(){return null!==this._attemptLimit&&this._attemptCount>=this._attemptLimit}get timeLimitDuration(){return this._timeLimitDuration}set timeLimitDuration(e){this._timeLimitDuration=e}get timeLimitAction(){return this._timeLimitAction}set timeLimitAction(e){this._timeLimitAction=e}get beginTimeLimit(){return this._beginTimeLimit}set beginTimeLimit(e){this._beginTimeLimit=e}get endTimeLimit(){return this._endTimeLimit}set endTimeLimit(e){this._endTimeLimit=e}get attemptAbsoluteDurationLimit(){return this._attemptAbsoluteDurationLimit}set attemptAbsoluteDurationLimit(e){if(null!==e&&!o(e,X))throw new F(this._cmi_element+".attemptAbsoluteDurationLimit",j.TYPE_MISMATCH);this._attemptAbsoluteDurationLimit=e}get attemptExperiencedDuration(){return this._attemptExperiencedDuration}set attemptExperiencedDuration(e){if(!o(e,X))throw new F(this._cmi_element+".attemptExperiencedDuration",j.TYPE_MISMATCH);this._attemptExperiencedDuration=e}get activityAbsoluteDurationLimit(){return this._activityAbsoluteDurationLimit}set activityAbsoluteDurationLimit(e){if(null!==e&&!o(e,X))throw new F(this._cmi_element+".activityAbsoluteDurationLimit",j.TYPE_MISMATCH);this._activityAbsoluteDurationLimit=e}get activityExperiencedDuration(){return this._activityExperiencedDuration}set activityExperiencedDuration(e){if(!o(e,X))throw new F(this._cmi_element+".activityExperiencedDuration",j.TYPE_MISMATCH);this._activityExperiencedDuration=e}get attemptAbsoluteDuration(){return this._attemptAbsoluteDurationLimit||"PT0H0M0S"}set attemptAbsoluteDuration(e){this._attemptAbsoluteDurationLimit=e}get activityAbsoluteDuration(){return this._activityAbsoluteDurationLimit||"PT0H0M0S"}set activityAbsoluteDuration(e){this._activityAbsoluteDurationLimit=e}get sequencingControls(){return this._sequencingControls}set sequencingControls(e){this._sequencingControls=e}get sequencingRules(){return this._sequencingRules}set sequencingRules(e){this._sequencingRules=e}get rollupRules(){return this._rollupRules}set rollupRules(e){this._rollupRules=e}getAvailableChildren(){return 0===this._children.length?[]:null!==this._processedChildren?this._processedChildren:this._children}setProcessedChildren(e){this._processedChildren=e}resetProcessedChildren(){this._processedChildren=null}get isNewAttempt(){return this._isNewAttempt}set isNewAttempt(e){this._isNewAttempt=e}toJSON(){this.jsonString=!0;const result={id:this._id,title:this._title,isVisible:this._isVisible,isActive:this._isActive,isSuspended:this._isSuspended,isCompleted:this._isCompleted,completionStatus:this._completionStatus,successStatus:this._successStatus,attemptCount:this._attemptCount,attemptCompletionAmount:this._attemptCompletionAmount,attemptAbsoluteDuration:this._attemptAbsoluteDuration,attemptExperiencedDuration:this._attemptExperiencedDuration,activityAbsoluteDuration:this._activityAbsoluteDuration,activityExperiencedDuration:this._activityExperiencedDuration,objectiveSatisfiedStatus:this._objectiveSatisfiedStatus,objectiveMeasureStatus:this._objectiveMeasureStatus,objectiveNormalizedMeasure:this._objectiveNormalizedMeasure,children:this._children.map(e=>e.toJSON())};return this.jsonString=!1,result}}class it extends I{constructor(e){super("activityTree"),this._root=null,this._currentActivity=null,this._suspendedActivity=null,this._activities=new Map,e&&(this.root=e)}initialize(){super.initialize(),this._root&&this._root.initialize()}reset(){this._initialized=!1,this._currentActivity=null,this._suspendedActivity=null,this._activities.clear(),this._root&&(this._root.reset(),this._activities.set(this._root.id,this._root),this._addActivitiesToMap(this._root))}get root(){return this._root}set root(e){if(null!==e&&!(e instanceof tt))throw new F(this._cmi_element+".root",j.TYPE_MISMATCH);this._activities.clear(),this._root=e,e&&(this._activities.set(e.id,e),this._addActivitiesToMap(e))}_addActivitiesToMap(e){for(const t of e.children)this._activities.set(t.id,t),this._addActivitiesToMap(t)}get currentActivity(){return this._currentActivity}set currentActivity(e){if(null!==e&&!(e instanceof tt))throw new F(this._cmi_element+".currentActivity",j.TYPE_MISMATCH);this._currentActivity&&(this._currentActivity.isActive=!1),this._currentActivity=e,e&&(e.isActive=!0)}get suspendedActivity(){return this._suspendedActivity}set suspendedActivity(e){if(null!==e&&!(e instanceof tt))throw new F(this._cmi_element+".suspendedActivity",j.TYPE_MISMATCH);this._suspendedActivity&&(this._suspendedActivity.isSuspended=!1),this._suspendedActivity=e,e&&(e.isSuspended=!0)}getActivity(id){return this._activities.get(id)||null}getAllActivities(){return Array.from(this._activities.values())}getParent(e){return e.parent}getChildren(e){return 1>=arguments.length||void 0===arguments[1]||arguments[1]?e.getAvailableChildren():e.children}getSiblings(e){return e.parent?e.parent.children.filter(t=>t!==e):[]}getNextSibling(e){let t=1>=arguments.length||void 0===arguments[1]||arguments[1];if(!e.parent)return null;let i=t?e.parent.getAvailableChildren():e.parent.children,s=i.indexOf(e);return-1===s&&t&&(i=e.parent.children,s=i.indexOf(e)),-1===s||s===i.length-1?null:i[s+1]??null}getPreviousSibling(e){let t=1>=arguments.length||void 0===arguments[1]||arguments[1];if(!e.parent)return null;let i=t?e.parent.getAvailableChildren():e.parent.children,s=i.indexOf(e);return-1===s&&t&&(i=e.parent.children,s=i.indexOf(e)),s>0?i[s-1]??null:null}getFirstChild(e){const t=1>=arguments.length||void 0===arguments[1]||arguments[1]?e.getAvailableChildren():e.children;return 0===t.length?null:t[0]??null}getLastChild(e){const t=1>=arguments.length||void 0===arguments[1]||arguments[1]?e.getAvailableChildren():e.children;return 0===t.length?null:t[t.length-1]??null}getCommonAncestor(e,t){const i=[];let s=e;for(;s;)i.unshift(s),s=s.parent;for(s=t;s;){if(i.includes(s))return s;s=s.parent}return null}toJSON(){this.jsonString=!0;const result={root:this._root,currentActivity:this._currentActivity?this._currentActivity.id:null,suspendedActivity:this._suspendedActivity?this._suspendedActivity.id:null};return this.jsonString=!1,result}}class st extends I{constructor(){super("sequencing"),this._adlNav=null,this._activityTree=new it,this._sequencingRules=new Ue,this._sequencingControls=new et,this._rollupRules=new Xe}initialize(){super.initialize(),this._activityTree.initialize(),this._sequencingRules.initialize(),this._sequencingControls.initialize(),this._rollupRules.initialize()}reset(){this._initialized=!1,this._activityTree.reset(),this._sequencingRules.reset(),this._sequencingControls.reset(),this._rollupRules.reset()}get activityTree(){return this._activityTree}set activityTree(e){if(!(e instanceof it))throw new F(this._cmi_element+".activityTree",j.TYPE_MISMATCH);this._activityTree=e}get sequencingRules(){return this._sequencingRules}set sequencingRules(e){if(!(e instanceof Ue))throw new F(this._cmi_element+".sequencingRules",j.TYPE_MISMATCH);this._sequencingRules=e}get sequencingControls(){return this._sequencingControls}set sequencingControls(e){if(!(e instanceof et))throw new F(this._cmi_element+".sequencingControls",j.TYPE_MISMATCH);this._sequencingControls=e}get rollupRules(){return this._rollupRules}set rollupRules(e){if(!(e instanceof Xe))throw new F(this._cmi_element+".rollupRules",j.TYPE_MISMATCH);this._rollupRules=e}get adlNav(){return this._adlNav}set adlNav(e){this._adlNav=e}processRollup(){const e=this._activityTree.root;e&&this._processRollupRecursive(e)}_processRollupRecursive(e){for(const t of e.children)this._processRollupRecursive(t);this._rollupRules.processRollup(e)}getCurrentActivity(){return this._activityTree.currentActivity}getRootActivity(){return this._activityTree.root}toJSON(){this.jsonString=!0;const result={activityTree:this._activityTree,sequencingRules:this._sequencingRules,sequencingControls:this._sequencingControls,rollupRules:this._rollupRules,adlNav:this._adlNav};return this.jsonString=!1,result}}class nt{constructor(e){this.rollupStateLog=[],this.eventCallback=null,this.eventCallback=e||null}overallRollupProcess(e){let t=e;for(;t&&t.parent;){const e=t.parent;(e.sequencingControls.rollupObjectiveSatisfied||e.sequencingControls.rollupProgressCompletion)&&(this.measureRollupProcess(e),e.sequencingControls.rollupObjectiveSatisfied&&this.objectiveRollupProcess(e),e.sequencingControls.rollupProgressCompletion&&this.activityProgressRollupProcess(e)),t=e}}measureRollupProcess(e){if(!e.sequencingControls.rollupObjectiveSatisfied)return;const t=e.getAvailableChildren();if(0===t.length)return;if(!t.some(e=>this.checkChildForRollupSubprocess(e,"measure")&&e.objectiveMeasureStatus&&null!==e.objectiveNormalizedMeasure))return void(e.objectiveMeasureStatus=!1);const i=this.calculateComplexWeightedMeasure(e,t,{enableThresholdBias:!1});e.objectiveNormalizedMeasure=i,e.objectiveMeasureStatus=!0;const s=this.identifyActivityClusters(t);s.length>1&&this.processCrossClusterDependencies(e,s)}objectiveRollupProcess(e){const t=this.objectiveRollupUsingRules(e,e.rollupRules.rules);if(null!==t)return void(e.objectiveSatisfiedStatus=t);const i=this.objectiveRollupUsingMeasure(e);e.objectiveSatisfiedStatus=null===i?this.objectiveRollupUsingDefault(e):i}objectiveRollupUsingRules(e,t){const i=t.filter(e=>e.action===Ye.SATISFIED),s=t.filter(e=>e.action===Ye.NOT_SATISFIED);for(const t of i)if(this.evaluateRollupRule(e,t))return!0;for(const t of s)if(this.evaluateRollupRule(e,t))return!1;return null}objectiveRollupUsingMeasure(e){return e.objectiveMeasureStatus&&null!==e.scaledPassingScore?e.objectiveNormalizedMeasure>=e.scaledPassingScore:null}objectiveRollupUsingDefault(e){const t=e.getAvailableChildren();if(0===t.length)return!1;for(const e of t)if(this.checkChildForRollupSubprocess(e,"objective")&&!e.objectiveSatisfiedStatus)return!1;return!0}activityProgressRollupProcess(e){const t=e.rollupRules,i=t.rules.filter(e=>e.action===Ye.COMPLETED),s=t.rules.filter(e=>e.action===Ye.INCOMPLETE);for(const t of i)if(this.evaluateRollupRule(e,t))return void(e.completionStatus="completed");for(const t of s)if(this.evaluateRollupRule(e,t))return void(e.completionStatus="incomplete");const n=e.getAvailableChildren();let r=!0;for(const e of n)if(this.checkChildForRollupSubprocess(e,"progress")&&"completed"!==e.completionStatus){r=!1;break}e.completionStatus=r?"completed":"incomplete"}checkChildForRollupSubprocess(e,t){switch(t){case"measure":case"objective":if(!e.sequencingControls.rollupObjectiveSatisfied)return!1;break;case"progress":if(!e.sequencingControls.rollupProgressCompletion)return!1}return!!e.isAvailable}evaluateRollupRule(e,t){const i=e.getAvailableChildren();let s=0,n=0;for(const e of i){let i=!1;switch(t.action){case Ye.SATISFIED:case Ye.NOT_SATISFIED:i=this.checkChildForRollupSubprocess(e,"objective");break;case Ye.COMPLETED:case Ye.INCOMPLETE:i=this.checkChildForRollupSubprocess(e,"progress")}i&&(s++,this.evaluateRollupConditionsSubprocess(e,t)&&n++)}return t.consideration===Ge.ALL?s>0&&n===s:null!==t.minimumCount?n>=t.minimumCount:null!==t.minimumPercent?(s>0?n/s:0)>=t.minimumPercent:s>0&&n===s}evaluateRollupConditionsSubprocess(e,t){if(0===t.conditions.length)return!0;switch(t.consideration){case Ge.ALL:return t.conditions.every(t=>t.evaluate(e));case Ge.ANY:return t.conditions.some(t=>t.evaluate(e));case Ge.NONE:return!t.conditions.some(t=>t.evaluate(e));case Ge.AT_LEAST_COUNT:case Ge.AT_LEAST_PERCENT:return t.conditions.every(t=>t.evaluate(e));default:return!1}}validateRollupStateConsistency(e){try{this.eventCallback?.("rollup_validation_started",{activityId:e.id,timestamp:(new Date).toISOString()});const t=[];return this.validateActivityRollupState(e,t),t.length>0?(this.eventCallback?.("rollup_state_inconsistencies",{activityId:e.id,inconsistencies:t,count:t.length}),!1):(this.eventCallback?.("rollup_validation_completed",{activityId:e.id,result:"consistent"}),!0)}catch(t){return this.eventCallback?.("rollup_validation_error",{activityId:e.id,error:t instanceof Error?t.message:t+""}),!1}}processGlobalObjectiveMapping(e,t){try{this.eventCallback?.("global_objective_processing_started",{activityId:e.id,globalObjectiveCount:t.size}),this.synchronizeGlobalObjectives(e,t);const i=e.getAvailableChildren();for(const e of i)this.processGlobalObjectiveMapping(e,t);this.eventCallback?.("global_objective_processing_completed",{activityId:e.id,processedObjectives:t.size})}catch(t){this.eventCallback?.("global_objective_processing_error",{activityId:e.id,error:t instanceof Error?t.message:t+""})}}calculateComplexWeightedMeasure(e,t,i){let s=0,n=0;const r=[],o=i?.enableThresholdBias??!0;for(const e of t)if(this.checkChildForRollupSubprocess(e,"measure")&&e.objectiveMeasureStatus&&null!==e.objectiveNormalizedMeasure){const t=this.calculateAdjustedWeight(e,e.sequencingControls.objectiveMeasureWeight,o);s+=e.objectiveNormalizedMeasure*t,n+=t,r.push({childId:e.id,measure:e.objectiveNormalizedMeasure,weight:t})}return this.eventCallback?.("complex_weighting_calculated",{activityId:e.id,weightingDetails:r,totalWeight:n,totalWeightedMeasure:s,result:n>0?s/n:0}),n>0?s/n:0}processCrossClusterDependencies(e,t){try{this.eventCallback?.("cross_cluster_processing_started",{activityId:e.id,clusterCount:t.length});const i=new Map;for(const e of t)this.analyzeCrossClusterDependencies(e,i);const s=this.resolveDependencyOrder(i);for(const e of s){const i=t.find(t=>t.id===e);i&&this.processClusterRollup(i)}this.eventCallback?.("cross_cluster_processing_completed",{activityId:e.id,processedClusters:s.length,dependencyMap:Array.from(i.entries())})}catch(t){this.eventCallback?.("cross_cluster_processing_error",{activityId:e.id,error:t instanceof Error?t.message:t+""})}}validateActivityRollupState(e,t){const i=e.id;e.objectiveMeasureStatus&&null===e.objectiveNormalizedMeasure&&t.push(`Activity ${i}: measure status true but normalized measure is null`),e.objectiveMeasureStatus&&null!==e.scaledPassingScore&&"unknown"!==e.successStatus&&e.objectiveSatisfiedStatus!==e.objectiveNormalizedMeasure>=e.scaledPassingScore&&t.push(`Activity ${i}: satisfaction status inconsistent with measure`);const s=e.sequencingControls;s.rollupObjectiveSatisfied||s.rollupProgressCompletion||(e.objectiveMeasureStatus||"unknown"!==e.completionStatus)&&t.push(`Activity ${i}: has rollup data but rollup controls disabled`);const n=e.getAvailableChildren();for(const e of n)this.validateActivityRollupState(e,t);this.rollupStateLog.push({activity:i,timestamp:(new Date).toISOString(),state:{measureStatus:e.objectiveMeasureStatus,measure:e.objectiveNormalizedMeasure,satisfiedStatus:e.objectiveSatisfiedStatus,completionStatus:e.completionStatus}})}synchronizeGlobalObjectives(e,t){const i=this.getActivityObjectives(e);for(const s of i)if(t.has(s)){const i=t.get(s);this.syncObjectiveState(e,s,i)}else{const i=this.getLocalObjectiveState(e,s);t.set(s,i)}}calculateAdjustedWeight(e,t){let i=2>=arguments.length||void 0===arguments[2]||arguments[2],s=t;return"completed"!==e.completionStatus&&(s*=.8),e.attemptCount>1&&(s*=Math.max(.5,1-.1*(e.attemptCount-1))),e.hasAttemptLimitExceeded()&&(s*=.6),i&&e.objectiveMeasureStatus&&(s*=(e.scaledPassingScore??.7)>e.objectiveNormalizedMeasure?.95:1.05),Math.max(0,s)}analyzeCrossClusterDependencies(e,t){t.set(e.id,[])}resolveDependencyOrder(e){const t=[],i=new Set,s=id=>{if(t.includes(id))return;if(i.has(id))return void this.eventCallback?.("circular_dependency_detected",{activityId:id});i.add(id);const n=e.get(id)||[];for(const e of n)s(e);i.delete(id),t.push(id)};for(const id of Array.from(e.keys()))s(id);return t}processClusterRollup(e){this.measureRollupProcess(e),e.sequencingControls.rollupObjectiveSatisfied&&this.objectiveRollupProcess(e),e.sequencingControls.rollupProgressCompletion&&this.activityProgressRollupProcess(e)}getActivityObjectives(e){return[e.id+"_primary_objective"]}syncObjectiveState(e,t,i){try{const s=this.getLocalObjectiveState(e,t);i.readSatisfiedStatus&&i.satisfiedStatusKnown&&(e.objectiveSatisfiedStatus=i.satisfiedStatus,e.objectiveMeasureStatus=!0),i.readNormalizedMeasure&&i.normalizedMeasureKnown&&(e.objectiveNormalizedMeasure=i.normalizedMeasure,e.objectiveMeasureStatus=!0,i.satisfiedByMeasure)&&(e.objectiveSatisfiedStatus=i.normalizedMeasure>=(e.scaledPassingScore||.7)),i.writeSatisfiedStatus&&e.objectiveMeasureStatus&&(i.satisfiedStatus=e.objectiveSatisfiedStatus,i.satisfiedStatusKnown=!0),i.writeNormalizedMeasure&&e.objectiveMeasureStatus&&(i.normalizedMeasure=e.objectiveNormalizedMeasure,i.normalizedMeasureKnown=!0,i.satisfiedByMeasure)&&(i.satisfiedStatus=e.objectiveNormalizedMeasure>=(e.scaledPassingScore||.7),i.satisfiedStatusKnown=!0),i.writeCompletionStatus&&"unknown"!==e.completionStatus&&(i.completionStatus=e.completionStatus,i.completionStatusKnown=!0),i.readCompletionStatus&&i.completionStatusKnown&&(e.completionStatus=i.completionStatus),i.writeProgressMeasure&&e.progressMeasureStatus&&(i.progressMeasure=e.progressMeasure,i.progressMeasureKnown=!0),i.readProgressMeasure&&i.progressMeasureKnown&&(e.progressMeasure=i.progressMeasure,e.progressMeasureStatus=!0),i.updateAttemptData&&this.updateActivityAttemptData(e,i),this.eventCallback?.("objective_synchronized",{activityId:e.id,objectiveId:t,localState:s,globalState:i,synchronizationTime:(new Date).toISOString()})}catch(i){this.eventCallback?.("objective_sync_error",{activityId:e.id,objectiveId:t,error:i instanceof Error?i.message:i+"",timestamp:(new Date).toISOString()})}}updateActivityAttemptData(e,t){try{t.satisfiedStatusKnown&&t.satisfiedStatus&&("unknown"!==e.completionStatus&&"incomplete"!==e.completionStatus||(e.completionStatus="completed"),"unknown"===e.successStatus&&(e.successStatus="passed")),t.attemptCount&&t.attemptCount>e.attemptCount&&(e.attemptCount=t.attemptCount),t.progressMeasureKnown&&void 0!==t.progressMeasure&&(e.attemptCompletionAmount=t.progressMeasure),t.attemptAbsoluteDuration&&(e.attemptAbsoluteDuration=t.attemptAbsoluteDuration),t.attemptExperiencedDuration&&(e.attemptExperiencedDuration=t.attemptExperiencedDuration),t.activityAbsoluteDuration&&(e.activityAbsoluteDuration=t.activityAbsoluteDuration),t.activityExperiencedDuration&&(e.activityExperiencedDuration=t.activityExperiencedDuration),void 0!==t.location&&(e.location=t.location),void 0!==t.suspendData&&(e.isSuspended=t.suspendData.length>0)}catch(t){this.eventCallback?.("attempt_data_update_error",{activityId:e.id,error:t instanceof Error?t.message:t+"",timestamp:(new Date).toISOString()})}}getLocalObjectiveState(e,t){return{id:t,satisfiedStatus:e.objectiveSatisfiedStatus,measureStatus:e.objectiveMeasureStatus,normalizedMeasure:e.objectiveNormalizedMeasure,scaledPassingScore:e.scaledPassingScore}}identifyActivityClusters(e){const t=[];for(const i of e)i.children.length>0&&i.sequencingControls.flow&&t.push(i);return t}}class rt{static selectChildrenProcess(e){const t=e.sequencingControls,i=[...e.children];if(t.selectionTiming===Ze.NEVER)return i;if(t.selectionTiming===Ze.ONCE&&t.selectionCountStatus)return i;const s=t.selectCount;if(null===s||s>=i.length)return t.selectionTiming===Ze.ONCE&&(t.selectionCountStatus=!0),i;const n=[],r=i.map((e,t)=>t);for(let e=0;s>e&&0!==r.length;e++){const e=Math.floor(Math.random()*r.length),t=r[e];void 0!==t&&i[t]&&n.push(i[t]),r.splice(e,1)}t.selectionTiming===Ze.ONCE&&(t.selectionCountStatus=!0);for(const e of i)n.includes(e)||(e.isHiddenFromChoice=!0,e.isAvailable=!1);return n}static randomizeChildrenProcess(e){const t=e.sequencingControls,i=[...e.children];if(t.randomizationTiming===Qe.NEVER)return i;if(t.randomizationTiming===Qe.ONCE&&t.reorderChildren)return i;if(!t.randomizeChildren)return i;const s=[...i];for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1)),i=s[e],n=s[t];i&&n&&(s[e]=n,s[t]=i)}return t.randomizationTiming===Qe.ONCE&&(t.reorderChildren=!0),e.children.length=0,e.children.push(...s),s}static applySelectionAndRandomization(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=e.sequencingControls;let s=!1,n=!1;i.selectionTiming===Ze.ON_EACH_NEW_ATTEMPT?(s=t,t&&(i.selectionCountStatus=!1)):i.selectionTiming===Ze.ONCE&&(s=!i.selectionCountStatus),i.randomizationTiming===Qe.ON_EACH_NEW_ATTEMPT?(n=t,t&&(i.reorderChildren=!1)):i.randomizationTiming===Qe.ONCE&&(n=!i.reorderChildren),s&&this.selectChildrenProcess(e),n&&this.randomizeChildrenProcess(e);const r=e.children.filter(e=>e.isAvailable);return e.setProcessedChildren(r),r}static isSelectionNeeded(e){const t=e.sequencingControls;return t.selectionTiming!==Ze.NEVER&&(t.selectionTiming!==Ze.ONCE||!t.selectionCountStatus)&&null!==t.selectCount&&e.children.length>t.selectCount}static isRandomizationNeeded(e){const t=e.sequencingControls;return t.randomizationTiming!==Qe.NEVER&&(t.randomizationTiming!==Qe.ONCE||!t.reorderChildren)&&t.randomizeChildren}}var ot=(e=>(e.START="start",e.RESUME_ALL="resumeAll",e.CONTINUE="continue",e.PREVIOUS="previous",e.CHOICE="choice",e.JUMP="jump",e.EXIT="exit",e.EXIT_ALL="exitAll",e.ABANDON="abandon",e.ABANDON_ALL="abandonAll",e.SUSPEND_ALL="suspendAll",e.RETRY="retry",e.RETRY_ALL="retryAll",e))(ot||{}),at=(e=>(e.DELIVER="deliver",e.DO_NOT_DELIVER="doNotDeliver",e))(at||{});class ct{constructor(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.deliveryRequest=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"doNotDeliver",this.targetActivity=e,this.exception=t}}class lt{constructor(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4?arguments[4]:void 0;this.activityTree=e,this.sequencingRules=t||null,this.sequencingControls=i||null,this.adlNav=s,this.now=n?.now||(()=>new Date),this.getAttemptElapsedSecondsHook=n?.getAttemptElapsedSeconds,this.getActivityElapsedSecondsHook=n?.getActivityElapsedSeconds}sequencingRequestProcess(request){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const result=new ct,t=this.activityTree.currentActivity;switch(request){case"start":return this.startSequencingRequestProcess();case"resumeAll":return this.resumeAllSequencingRequestProcess();case"continue":return t?this.continueSequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"previous":return t?this.previousSequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"choice":return e?this.choiceSequencingRequestProcess(e,t):(result.exception="SB.2.12-5",result);case"jump":return e?this.jumpSequencingRequestProcess(e):(result.exception="SB.2.12-5",result);case"exit":return t?this.exitSequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"exitAll":return t?this.exitAllSequencingRequestProcess():(result.exception="SB.2.12-1",result);case"abandon":return t?this.abandonSequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"abandonAll":return t?this.abandonAllSequencingRequestProcess():(result.exception="SB.2.12-1",result);case"suspendAll":return t?this.suspendAllSequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"retry":return t?this.retrySequencingRequestProcess(t):(result.exception="SB.2.12-1",result);case"retryAll":return this.retryAllSequencingRequestProcess();default:return result.exception="SB.2.12-6",result}}startSequencingRequestProcess(){const result=new ct,e=this.activityTree.root;if(!e)return result.exception="SB.2.5-1",result;if(null!==this.activityTree.currentActivity)return result.exception="SB.2.5-2",result;const t=this.findFirstDeliverableActivity(e);return t?(result.deliveryRequest="deliver",result.targetActivity=t,result):(result.exception="SB.2.5-3",result)}findFirstDeliverableActivity(e){if(0===e.children.length)return this.checkActivityProcess(e)?e:null;this.ensureSelectionAndRandomization(e);const t=e.getAvailableChildren();for(const e of t){const t=this.findFirstDeliverableActivity(e);if(t)return t}return null}resumeAllSequencingRequestProcess(){const result=new ct,e=this.activityTree.suspendedActivity;return e?null!==this.activityTree.currentActivity?(result.exception="SB.2.6-2",result):(result.deliveryRequest="deliver",result.targetActivity=e,result):(result.exception="SB.2.6-1",result)}continueSequencingRequestProcess(e){const result=new ct;if(e.isActive)return result.exception="SB.2.7-1",result;if(e.parent&&!e.parent.sequencingControls.flow)return result.exception="SB.2.7-2",result;const t=this.flowSubprocess(e,"forward");return t?(result.deliveryRequest="deliver",result.targetActivity=t,result):(result.exception="SB.2.7-2",result)}previousSequencingRequestProcess(e){const result=new ct;if(e.isActive)return result.exception="SB.2.8-1",result;if(e.parent&&!e.parent.sequencingControls.flow)return result.exception="SB.2.8-2",result;if(e.parent&&e.parent.sequencingControls.forwardOnly)return result.exception="SB.2.8-2",result;const t=this.flowSubprocess(e,"backward");return t?(result.deliveryRequest="deliver",result.targetActivity=t,result):(result.exception="SB.2.8-2",result)}choiceSequencingRequestProcess(e,t){const result=new ct;let i=this.activityTree.getActivity(e);if(!i)return result.exception="SB.2.9-1",result;if(!this.isActivityInTree(i))return result.exception="SB.2.9-2",result;if(i===this.activityTree.root)return result.exception="SB.2.9-3",result;let s=i;for(;s;){if(s.isHiddenFromChoice)return result.exception="SB.2.9-4",result;if(s.parent&&!s.parent.sequencingControls.choice)return result.exception="SB.2.9-5",result;s=s.parent}if(t&&t.isActive)return result.exception="SB.2.9-6",result;const n=this.findCommonAncestor(t,i);t&&this.terminateDescendentAttemptsProcess(n||this.activityTree.root);const r=[];for(s=i;s&&s!==n;)r.unshift(s),s=s.parent;for(const e of r)if(!this.checkActivityProcess(e))return result;if(i.children.length>0){this.ensureSelectionAndRandomization(i),i.getAvailableChildren();const e=this.flowActivityTraversalSubprocess(i,!0,!0,"forward");if(!e)return result.exception="SB.2.9-7",result;i=e}return result.deliveryRequest="deliver",result.targetActivity=i,result}jumpSequencingRequestProcess(e){const result=new ct,t=this.activityTree.getActivity(e);return t?this.isActivityInTree(t)?t.isAvailable?(result.deliveryRequest="deliver",result.targetActivity=t,result):(result.exception="SB.2.13-3",result):(result.exception="SB.2.13-2",result):(result.exception="SB.2.13-1",result)}exitSequencingRequestProcess(e){const result=new ct;return e.parent?e.parent.sequencingControls.choiceExit?(this.terminateDescendentAttemptsProcess(e),result):(result.exception="SB.2.11-2",result):(result.exception="SB.2.11-1",result)}exitAllSequencingRequestProcess(){const result=new ct;return this.activityTree.root&&this.terminateDescendentAttemptsProcess(this.activityTree.root),result}abandonSequencingRequestProcess(e){const result=new ct;return e.isActive=!1,this.activityTree.currentActivity=e.parent,result}abandonAllSequencingRequestProcess(){const result=new ct;return this.activityTree.currentActivity=null,result}suspendAllSequencingRequestProcess(e){const result=new ct;return e!==this.activityTree.root?(e.isSuspended=!0,this.activityTree.suspendedActivity=e,this.activityTree.currentActivity=null):result.exception="SB.2.15-1",result}retrySequencingRequestProcess(e){const result=new ct;return this.terminateDescendentAttemptsProcess(e),e.incrementAttemptCount(),result.deliveryRequest="deliver",result.targetActivity=e,result}retryAllSequencingRequestProcess(){return this.activityTree.currentActivity=null,this.startSequencingRequestProcess()}ensureSelectionAndRandomization(e){e.getAvailableChildren()===e.children&&(rt.isSelectionNeeded(e)||rt.isRandomizationNeeded(e))&&rt.applySelectionAndRandomization(e,e.isNewAttempt)}flowActivityTraversalSubprocess(e,t,i,mode){if(!e.isAvailable)return null;const s=e.parent;if(s&&!s.sequencingControls.flow)return null;if(i){this.ensureSelectionAndRandomization(e);const t=e.getAvailableChildren();for(const e of t){const t=this.flowActivityTraversalSubprocess(e,"forward"===mode,!0,mode);if(t)return t}}return 0===e.children.length?e.sequencingControls.flow?null:this.checkActivityProcess(e)?e:null:null}checkActivityProcess(e){if(!e.isAvailable)return!1;if(this.limitConditionsCheckProcess(e))return!1;const t=this.sequencingRulesCheckProcess(e,e.sequencingRules.preConditionRules);return t!==$e.SKIP&&t!==$e.DISABLED}terminateDescendentAttemptsProcess(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;t||(i=this.exitActionRulesSubprocess(e)),e.isActive=!1;for(const i of e.children)this.terminateDescendentAttemptsProcess(i,t);i&&!t&&this.processDeferredExitAction(i,e)}exitActionRulesSubprocess(e){const t=this.sequencingRulesCheckProcess(e,e.sequencingRules.exitConditionRules);return t===$e.EXIT||t===$e.EXIT_PARENT||t===$e.EXIT_ALL?t:null}processDeferredExitAction(e,t){switch(e){case $e.EXIT:break;case $e.EXIT_PARENT:t.parent&&t.parent.isActive&&this.terminateDescendentAttemptsProcess(t.parent,!0);break;case $e.EXIT_ALL:this.activityTree.root&&this.activityTree.root!==t&&this.activityTree.getAllActivities().some(e=>e.isActive)&&this.terminateDescendentAttemptsProcess(this.activityTree.root,!0)}}postConditionRulesSubprocess(e){const t=this.sequencingRulesCheckProcess(e,e.sequencingRules.postConditionRules);return t&&[$e.EXIT_PARENT,$e.EXIT_ALL,$e.RETRY,$e.RETRY_ALL,$e.CONTINUE,$e.PREVIOUS,$e.STOP_FORWARD_TRAVERSAL].includes(t)?t:null}validateSequencingRequest(request,e){if(!Object.values(ot).includes(request))return{valid:!1,exception:"SB.2.12-6"};if(("choice"===request||"jump"===request)&&!e)return{valid:!1,exception:"SB.2.12-5"};const t=this.validateRequestSpecificConstraints(request,e);return t.valid?{valid:!0,exception:null}:t}validateRequestSpecificConstraints(request,e){const t=this.activityTree.currentActivity;switch(request){case"continue":case"previous":case"exit":case"exitAll":case"abandon":case"abandonAll":case"suspendAll":case"retry":if(!t)return{valid:!1,exception:"SB.2.12-1"};break;case"choice":if(e&&!this.activityTree.getActivity(e))return{valid:!1,exception:"SB.2.9-1"};break;case"jump":if(e&&!this.activityTree.getActivity(e))return{valid:!1,exception:"SB.2.13-1"}}return{valid:!0,exception:null}}limitConditionsCheckProcess(e){return null!==e.attemptLimit&&e.attemptCount>=e.attemptLimit||null!==e.attemptAbsoluteDurationLimit&&this.parseISO8601Duration(e.attemptExperiencedDuration)>=this.parseISO8601Duration(e.attemptAbsoluteDurationLimit)||null!==e.activityAbsoluteDurationLimit&&this.parseISO8601Duration(e.activityExperiencedDuration)>=this.parseISO8601Duration(e.activityAbsoluteDurationLimit)}parseISO8601Duration(e){const t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?/);return t?1e3*(3600*parseInt(t[1]||"0",10)+60*parseInt(t[2]||"0",10)+parseFloat(t[3]||"0")):0}sequencingRulesCheckProcess(e,t){for(const i of t)if(this.sequencingRulesCheckSubprocess(e,i))return i.action;return null}sequencingRulesCheckSubprocess(e,t){if(0===t.conditions.length)return!0;const i=t.conditionCombination;return"all"===i||i===Fe.AND?t.conditions.every(t=>t.evaluate(e)):("any"===i||i===Fe.OR)&&t.conditions.some(t=>t.evaluate(e))}isActivityInTree(e){return this.activityTree.getAllActivities().includes(e)}findCommonAncestor(e,t){if(!e||!t)return null;const i=[];let s=e;for(;s;)i.push(s),s=s.parent;for(s=t;s;){if(i.includes(s))return s;s=s.parent}return null}flowSubprocess(e,t){let i=e,s=!0;for(;i;){const e=this.flowTreeTraversalSubprocess(i,t,s);if(!e)return null;const n=this.flowActivityTraversalSubprocess(e,"forward"===t,!0,t);if(n)return n;i=e,s=!1}return null}flowTreeTraversalSubprocess(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("forward"!==t){const t=this.activityTree.getPreviousSibling(e);if(t){let e=t;for(;;){this.ensureSelectionAndRandomization(e);const t=e.getAvailableChildren();if(0===t.length)break;const i=t[t.length-1];if(!i)break;e=i}return e}let i=e;for(;i&&i.parent;){const e=this.activityTree.getPreviousSibling(i.parent);if(e){let t=e;for(;;){this.ensureSelectionAndRandomization(t);const e=t.getAvailableChildren();if(0===e.length)break;const i=e[e.length-1];if(!i)break;t=i}return t}i=i.parent}return null}{if(!i){this.ensureSelectionAndRandomization(e);const t=e.getAvailableChildren();if(t.length>0)return t[0]||null}let t=e;for(;t;){const e=this.activityTree.getNextSibling(t);if(e)return e;t=t.parent}}return null}choiceFlowSubprocess(e,t){return 0===e.children.length?e:this.choiceFlowTreeTraversalSubprocess(e)}choiceFlowTreeTraversalSubprocess(e){this.ensureSelectionAndRandomization(e);const t=e.getAvailableChildren(),i=this.validateChoiceFlowConstraints(e,t);if(!i.valid)return null;for(const e of i.validChildren){const t=this.enhancedChoiceActivityTraversalSubprocess(e);if(t)return t}return null}enhancedChoiceActivityTraversalSubprocess(e){if(!e.isAvailable)return null;if(e.isHiddenFromChoice)return null;const t=this.validateChoiceTraversalConstraints(e);return t.canTraverse?0===e.children.length?this.checkActivityProcess(e)?e:null:t.canTraverseInto?this.choiceFlowTreeTraversalSubprocess(e):null:null}choiceActivityTraversalSubprocess(e){return this.enhancedChoiceActivityTraversalSubprocess(e)}evaluatePostConditionRules(e){const t=this.postConditionRulesSubprocess(e);if(!t)return null;switch(t){case $e.EXIT_PARENT:return"exit";case $e.EXIT_ALL:return"exitAll";case $e.RETRY:return"retry";case $e.RETRY_ALL:return"retryAll";case $e.CONTINUE:return"continue";case $e.PREVIOUS:return"previous";case $e.STOP_FORWARD_TRAVERSAL:return e.sequencingControls.stopForwardTraversal=!0,null;default:return null}}validateChoiceFlowConstraints(e,t){const i=[];for(const s of t)this.meetsChoiceFlowConstraints(s,e)&&i.push(s);return{valid:i.length>0,validChildren:i}}meetsChoiceFlowConstraints(e,t){return!(!e.isAvailable||e.isHiddenFromChoice)&&(!t.sequencingControls.constrainChoice||this.validateConstrainChoiceForFlow(e,t))}validateChoiceTraversalConstraints(e){let t=!0,i=!0;return e.parent?.sequencingControls.constrainChoice&&(t=this.evaluateConstrainChoiceForTraversal(e)),e.sequencingControls&&e.sequencingControls.stopForwardTraversal&&(i=!1),e.parent?.sequencingControls.forwardOnly&&(i=this.evaluateForwardOnlyForChoice(e)),{canTraverse:t,canTraverseInto:i}}validateConstrainedChoiceBoundaries(e,t){let i=t;for(;i;){if(i.isHiddenFromChoice)return{valid:!1,exception:"SB.2.9-4"};if(i.parent&&!i.parent.sequencingControls.choice)return{valid:!1,exception:"SB.2.9-5"};if(i.parent?.sequencingControls.constrainChoice){const t=this.checkConstrainedChoiceBoundary(e,i,i.parent);if(!t.valid)return t}i=i.parent}return{valid:!0,exception:null}}validateConstrainChoiceForFlow(e,t){if(!t.sequencingControls||!t.sequencingControls.constrainChoice)return!0;const i=t.children;if(!i||0===i.length)return!0;const s=i.indexOf(e);if(-1===s)return!1;const n=this.getCurrentActivity(t);if(!n)return this.isActivityAvailableForChoice(e);const r=i.indexOf(n);return-1!==r&&(t.sequencingControls.flow?s===r+1?this.isActivityAvailableForChoice(e):r>s&&!t.sequencingControls.forwardOnly&&("completed"===e.completionStatus||"passed"===e.completionStatus):this.isActivityAvailableForChoice(e)&&("completed"===e.completionStatus||"unknown"===e.completionStatus||"incomplete"===e.completionStatus))}evaluateConstrainChoiceForTraversal(e){if(!e.parent)return!0;const t=e.parent;if(!t.sequencingControls||!t.sequencingControls.constrainChoice)return!0;const i=t.children;if(!i||0===i.length)return!0;const s=i.indexOf(e);if(-1===s)return!1;if(!this.isActivityAvailableForChoice(e))return!1;if(t.sequencingControls.flow){const e=this.getCurrentActivity(t);if(e){const n=i.indexOf(e);if(t.sequencingControls.forwardOnly&&n>s)return!1;if(s>n)for(let e=n+1;s>e;e++){const t=i[e];if(t&&this.isActivityMandatory(t)&&!this.isActivityCompleted(t))return!1}}}return this.validateActivityChoiceState(e)}evaluateForwardOnlyForChoice(e){if(!e.parent)return!0;const t=e.parent;if(!t.sequencingControls||!t.sequencingControls.forwardOnly)return!0;const i=t.children;if(!i||0===i.length)return!0;const s=i.indexOf(e);if(-1===s)return!1;const n=this.getCurrentActivity(t);if(!n)return this.isActivityAvailableForChoice(e);const r=i.indexOf(n);return-1===r||(r>s?!("completed"!==e.completionStatus&&"passed"!==e.completionStatus||!e.sequencingControls||!e.sequencingControls.choice)||!!this.hasBackwardChoiceException(e,t):this.isActivityAvailableForChoice(e))}checkConstrainedChoiceBoundary(e,t,i){try{if(!e)return this.isActivityAvailableForChoice(t)?{valid:!0,exception:null}:{valid:!1,exception:"Activity not available for choice"};if(!i.sequencingControls||!i.sequencingControls.constrainChoice)return this.isActivityAvailableForChoice(t)?{valid:!0,exception:null}:{valid:!1,exception:"Activity not available for choice"};const s=i.children;if(!s||0===s.length)return{valid:!0,exception:null};const n=s.indexOf(e),r=s.indexOf(t);if(-1===n||-1===r)return{valid:!1,exception:"Activity not found in parent structure"};if(i.sequencingControls.flow){if(i.sequencingControls.forwardOnly&&n>r&&"completed"!==t.completionStatus&&"passed"!==t.completionStatus)return{valid:!1,exception:"Forward-only constraint violated"};if(r>n)for(let e=n+1;r>e;e++){const t=s[e];if(t&&this.isActivityMandatory(t)&&!this.isActivityCompleted(t))return{valid:!1,exception:"Cannot skip mandatory incomplete activity"}}}return this.isActivityAvailableForChoice(t)?this.hasChoiceBoundaryViolation(e,t,i)?{valid:!1,exception:"Choice boundary constraint violation"}:{valid:!0,exception:null}:{valid:!1,exception:"Activity not available for choice"}}catch(e){return{valid:!1,exception:"Boundary check error: "+e}}}getCurrentActivity(e){if(e.children)for(const t of e.children)if(t.isActive)return t;return null}isActivityAvailableForChoice(e){return e.isVisible&&!e.isHiddenFromChoice&&e.isAvailable&&(!e.sequencingControls||e.sequencingControls.choice)}isActivityMandatory(e){if(e.sequencingRules&&e.sequencingRules.preConditionRules)for(const t of e.sequencingRules.preConditionRules)if("skip"===t.action&&t.conditions&&0===t.conditions.length)return!1;return!1!==e.mandatory}isActivityCompleted(e){return"completed"===e.completionStatus||"passed"===e.completionStatus||"passed"===e.successStatus}validateActivityChoiceState(e){if(!this.isActivityAvailableForChoice(e))return!1;if(e.sequencingRules&&e.sequencingRules.preConditionRules)for(const t of e.sequencingRules.preConditionRules)if((t.action===$e.DISABLED||t.action===$e.HIDE_FROM_CHOICE)&&this.evaluateRuleConditions(t.conditions||[],e,t.conditionCombination||"all"))return!1;return!0}hasBackwardChoiceException(e,t){if(t.sequencingRules&&t.sequencingRules.preConditionRules)for(const i of t.sequencingRules.preConditionRules)if("exitParent"===i.action||"retry"===i.action)return this.evaluateRuleConditions(i.conditions||[],e,i.conditionCombination||"all");return!0===e.allowBackwardChoice}hasChoiceBoundaryViolation(e,t,i){if(t.timeLimitAction&&t.beginTimeLimit){const e=new Date;if(new Date(t.beginTimeLimit)>e)return!0}return!(!t.endTimeLimit||new Date(t.endTimeLimit)>=new Date)||!(!t.attemptLimit||t.attemptLimit>t.attemptCount)}evaluateRuleConditions(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all";if(0===e.length)return!0;const s=[];for(const i of e){let result=!1;switch(i.condition||i.conditionType){case"always":result=!0;break;case"never":default:result=!1;break;case"activityAttempted":case"attempted":result=t.attemptCount>0;break;case"activityCompleted":case"completed":result=this.isActivityCompleted(t);break;case"satisfied":result=!0===t.objectiveSatisfiedStatus;break;case"objectiveStatusKnown":case"objectiveMeasureKnown":result=!0===t.objectiveMeasureStatus;break;case"objectiveMeasureGreaterThan":t.objectiveMeasureStatus&&(result=t.objectiveNormalizedMeasure>(i.measureThreshold||0));break;case"objectiveMeasureLessThan":t.objectiveMeasureStatus&&(result=(i.measureThreshold||0)>t.objectiveNormalizedMeasure);break;case"progressKnown":result="unknown"!==t.completionStatus;break;case"attemptLimitExceeded":result=t.hasAttemptLimitExceeded();break;case"timeLimitExceeded":{const e=t.timeLimitDuration;if(!e){result=!1;break}const i=r(e,X);let s=0;if(this.getAttemptElapsedSecondsHook)try{s=this.getAttemptElapsedSecondsHook(t)||0}catch(e){s=0}else if(t.attemptAbsoluteStartTime){const e=new Date(t.attemptAbsoluteStartTime).getTime(),i=this.now().getTime();!Number.isNaN(e)&&i>e&&(s=Math.max(0,(i-e)/1e3))}result=s>i&&i>0;break}case"outsideAvailableTimeRange":if(t.beginTimeLimit||t.endTimeLimit){const e=new Date;t.beginTimeLimit&&new Date(t.beginTimeLimit)>e&&(result=!0),t.endTimeLimit&&e>new Date(t.endTimeLimit)&&(result=!0)}}"not"!==i.operator&&!0!==i.not||(result=!result),s.push(result)}return"all"===i||"and"===i?s.every(result=>result):"any"===i||"or"===i?s.some(result=>result):s.every(result=>result)}getAttemptElapsedSeconds(e){if(this.getAttemptElapsedSecondsHook)try{return this.getAttemptElapsedSecondsHook(e)||0}catch{return 0}if(e.attemptAbsoluteStartTime){const t=new Date(e.attemptAbsoluteStartTime).getTime(),i=this.now().getTime();if(!Number.isNaN(t)&&i>t)return Math.max(0,(i-t)/1e3)}return 0}}var ut=(e=>(e.START="start",e.RESUME_ALL="resumeAll",e.CONTINUE="continue",e.PREVIOUS="previous",e.CHOICE="choice",e.JUMP="jump",e.EXIT="exit",e.EXIT_ALL="exitAll",e.ABANDON="abandon",e.ABANDON_ALL="abandonAll",e.SUSPEND_ALL="suspendAll",e.NOT_VALID="_none_",e))(ut||{});class ht{constructor(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.valid=arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.terminationRequest=e,this.sequencingRequest=t,this.targetActivityId=i,this.exception=s}}class dt{constructor(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.valid=arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.targetActivity=e,this.exception=t}}class mt{constructor(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5?arguments[5]:void 0;this.contentDelivered=!1,this.eventCallback=null,this.globalObjectiveMap=new Map,this.activityTree=e,this.sequencingProcess=t,this.rollupProcess=i,this.adlNav=s,this.eventCallback=n,this.now=r?.now||(()=>new Date),this.enhancedDeliveryValidation=!0===r?.enhancedDeliveryValidation,this.initializeGlobalObjectiveMap()}processNavigationRequest(e){const t=this.navigationRequestProcess(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null);if(!t.valid)return new dt(!1,null,t.exception);if(t.terminationRequest){if(!this.terminationRequestProcess(t.terminationRequest,!!t.sequencingRequest))return new dt(!1,null,"TB.2.3-1");if(!t.sequencingRequest)return new dt(!0,null)}if(t.sequencingRequest){const e=this.sequencingProcess.sequencingRequestProcess(t.sequencingRequest,t.targetActivityId);if(e.exception)return new dt(!1,null,e.exception);if(e.deliveryRequest===at.DELIVER&&e.targetActivity){if(this.activityTree.root&&!this.rollupProcess.validateRollupStateConsistency(this.activityTree.root))return new dt(!1,null,"OP.1-3");this.rollupProcess.processGlobalObjectiveMapping(e.targetActivity,this.globalObjectiveMap);const t=this.deliveryRequestProcess(e.targetActivity);return t.valid?(this.contentDeliveryEnvironmentProcess(t.targetActivity),this.activityTree.root&&this.rollupProcess.validateRollupStateConsistency(this.activityTree.root),t):t}}return new dt(!1,null,"OP.1-1")}navigationRequestProcess(request){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.fireEvent("onNavigationRequestProcessing",{request:request,targetActivityId:e});const t=this.activityTree.currentActivity;switch(request){case"start":return null!==t?new ht(!1,null,null,null,"NB.2.1-1"):new ht(!0,null,ot.START,null);case"resumeAll":return null!==t?new ht(!1,null,null,null,"NB.2.1-2"):null===this.activityTree.suspendedActivity?new ht(!1,null,null,null,"NB.2.1-3"):new ht(!0,null,ot.RESUME_ALL,null);case"continue":return t?t.parent&&t.parent.sequencingControls.flow?new ht(!0,ot.EXIT,ot.CONTINUE,null):new ht(!1,null,null,null,"NB.2.1-5"):new ht(!1,null,null,null,"NB.2.1-4");case"previous":{if(!t)return new ht(!1,null,null,null,"NB.2.1-6");if(!t.parent||!t.parent.sequencingControls.flow)return new ht(!1,null,null,null,"NB.2.1-7");const e=this.validateForwardOnlyConstraints(t);return e.valid?new ht(!0,ot.EXIT,ot.PREVIOUS,null):new ht(!1,null,null,null,e.exception)}case"choice":{if(!e)return new ht(!1,null,null,null,"NB.2.1-9");const i=this.activityTree.getActivity(e);if(!i)return new ht(!1,null,null,null,"NB.2.1-10");const s=this.validateComplexChoicePath(t,i);return s.valid?new ht(!0,t?ot.EXIT:null,ot.CHOICE,e):new ht(!1,null,null,null,s.exception)}case"jump":return e?new ht(!0,null,ot.JUMP,e):new ht(!1,null,null,null,"NB.2.1-12");case"exit":return t?new ht(!0,t===this.activityTree.root?ot.EXIT_ALL:ot.EXIT,null,null):new ht(!1,null,null,null,"NB.2.1-13");case"exitAll":return t?new ht(!0,ot.EXIT_ALL,null,null):new ht(!1,null,null,null,"NB.2.1-14");case"abandon":return t?new ht(!0,ot.ABANDON,null,null):new ht(!1,null,null,null,"NB.2.1-15");case"abandonAll":return t?new ht(!0,ot.ABANDON_ALL,null,null):new ht(!1,null,null,null,"NB.2.1-16");case"suspendAll":return t?new ht(!0,ot.SUSPEND_ALL,null,null):new ht(!1,null,null,null,"NB.2.1-17");default:return new ht(!1,null,null,null,"NB.2.1-18")}}terminationRequestProcess(request){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const t=this.activityTree.currentActivity;if(!t)return!1;if(this.fireEvent("onTerminationRequestProcessing",{request:request,hasSequencingRequest:e,currentActivity:t.id}),request===ot.EXIT){const i=this.enhancedExitActionRulesSubprocess(t);if(i.action){if(i.recursionDepth>10)return this.fireEvent("onSequencingError",{error:"Exit action recursion detected",depth:i.recursionDepth,activity:t.id}),!1;switch(i.action){case"EXIT_PARENT":if(t.parent)return this.activityTree.currentActivity=t.parent,this.terminationRequestProcess(request,e);break;case"EXIT_ALL":request=ot.EXIT_ALL}}}(request===ot.EXIT_ALL||request===ot.ABANDON_ALL||request===ot.EXIT&&t.children.length>0)&&this.terminateDescendentAttemptsProcess(t),(request===ot.EXIT_ALL||request===ot.ABANDON_ALL||request===ot.EXIT&&t.children.length>0)&&this.terminateDescendentAttemptsProcess(t);const i=this.executeTermination(request,t,e);if(!i.success)return!1;if(i.shouldEvaluatePostConditions){const e=this.integratePostConditionRulesSubprocess(t);e&&this.fireEvent("onPostConditionTriggered",{activity:t.id,action:e})}return request!==ot.EXIT_ALL&&request!==ot.ABANDON_ALL||this.performComplexSuspendedActivityCleanup(),!0}executeTermination(request,e,t){let i=!1;try{switch(request){case ot.EXIT:e.isActive&&(this.endAttemptProcess(e),i=!0),t||(this.activityTree.currentActivity=e.parent);break;case ot.EXIT_ALL:this.handleMultiLevelExitActions(this.activityTree.root),this.activityTree.currentActivity=null;break;case ot.ABANDON:e.isActive=!1,t||(this.activityTree.currentActivity=e.parent);break;case ot.ABANDON_ALL:e.isActive=!1,this.activityTree.currentActivity=null;break;case ot.SUSPEND_ALL:this.handleSuspendAllRequest(e);break;default:return{success:!1,shouldEvaluatePostConditions:!1}}return{success:!0,shouldEvaluatePostConditions:i}}catch(t){return this.fireEvent("onTerminationError",{error:t instanceof Error?t.message:t+"",request:request,activity:e.id}),{success:!1,shouldEvaluatePostConditions:!1}}}enhancedExitActionRulesSubprocess(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;t++;const i=e.sequencingRules.exitConditionRules;for(const s of i){let i=!0;if(i="all"===s.conditionCombination?s.conditions.every(t=>t.evaluate(e)):s.conditions.some(t=>t.evaluate(e)),i){if(s.action===$e.EXIT_PARENT)return{action:"EXIT_PARENT",recursionDepth:t};if(s.action===$e.EXIT_ALL)return{action:"EXIT_ALL",recursionDepth:t}}}return{action:null,recursionDepth:t}}integratePostConditionRulesSubprocess(e){const t=this.sequencingProcess.evaluatePostConditionRules(e);return t?(this.fireEvent("onPostConditionEvaluated",{activity:e.id,action:t,timestamp:(new Date).toISOString()}),t):null}handleMultiLevelExitActions(e){this.processExitActionsAtLevel(e,0),this.terminateAllActivities(e)}processExitActionsAtLevel(e,t){const i=this.enhancedExitActionRulesSubprocess(e,0);i.action&&this.fireEvent("onMultiLevelExitAction",{activity:e.id,level:t,action:i.action});for(const i of e.children)this.processExitActionsAtLevel(i,t+1)}performComplexSuspendedActivityCleanup(){const e=this.activityTree.suspendedActivity;if(e){let t=e;const i=[];for(;t;)t.isSuspended&&(t.isSuspended=!1,i.push(t.id)),t=t.parent;this.activityTree.suspendedActivity=null,this.fireEvent("onSuspendedActivityCleanup",{cleanedActivities:i,originalSuspendedActivity:e.id})}}handleSuspendAllRequest(e){e.isSuspended=!0,e.isActive=!1,this.activityTree.suspendedActivity=e,this.activityTree.currentActivity=null,this.fireEvent("onActivitySuspended",{activity:e.id,timestamp:(new Date).toISOString()})}deliveryRequestProcess(e){if(this.fireEvent("onDeliveryRequestProcessing",{activity:e.id,timestamp:(new Date).toISOString()}),this.enhancedDeliveryValidation){const t=this.validateActivityTreeStateConsistency(e);if(!t.consistent)return new dt(!1,null,t.exception)}if(e.children.length>0)return new dt(!1,null,"DB.1.1-1");if(e.sequencingControls.flow&&0===e.children.length)return new dt(!1,null,"DB.1.1-2");if(this.enhancedDeliveryValidation){const t=this.validateResourceConstraints(e);if(!t.available)return new dt(!1,null,t.exception)}if(this.enhancedDeliveryValidation){const t=this.validateConcurrentDeliveryPrevention(e);if(!t.allowed)return new dt(!1,null,t.exception)}if(this.enhancedDeliveryValidation){const t=this.validateActivityDependencies(e);if(!t.satisfied)return new dt(!1,null,t.exception)}return this.checkActivityProcess(e)?new dt(!0,e):new dt(!1,null,"DB.1.1-3")}contentDeliveryEnvironmentProcess(e){this.activityTree.suspendedActivity&&this.activityTree.suspendedActivity!==e&&this.clearSuspendedActivitySubprocess(),this.activityTree.currentActivity=e,e.isActive=!0,this.initializeActivityForDelivery(e),this.setupActivityAttemptTracking(e),this.contentDelivered=!0,this.adlNav&&this.updateNavigationValidity(),this.fireActivityDeliveryEvent(e)}initializeActivityForDelivery(e){"unknown"===e.completionStatus&&0===e.children.length&&(e.completionStatus="not attempted"),null===e.objectiveSatisfiedStatus&&(e.objectiveSatisfiedStatus=!1),null===e.progressMeasure&&(e.progressMeasure=0,e.progressMeasureStatus=!1),null===e.objectiveNormalizedMeasure&&(e.objectiveNormalizedMeasure=0,e.objectiveMeasureStatus=!1),e.attemptAbsoluteDuration="PT0H0M0S",e.attemptExperiencedDuration="PT0H0M0S",e.isAvailable=!0}setupActivityAttemptTracking(e){e.attemptCount&&0!==e.attemptCount||(e.attemptCount=1),e.attemptAbsoluteStartTime=this.now().toISOString(),e.location||(e.location=""),e.activityAttemptActive=!0,e.learnerPrefs||(e.learnerPrefs={audioCaptioning:"0",audioLevel:"1",deliverySpeed:"1",language:""})}fireActivityDeliveryEvent(e){try{this.eventCallback&&this.eventCallback("onActivityDelivery",e),console.debug(`Activity delivered: ${e.id} - ${e.title}`)}catch(e){console.warn("Failed to fire activity delivery event: "+e)}}fireEvent(e,t){try{this.eventCallback&&this.eventCallback(e,t)}catch(t){console.warn(`Failed to fire sequencing event ${e}: ${t}`)}}clearSuspendedActivitySubprocess(){if(this.activityTree.suspendedActivity){let e=this.activityTree.suspendedActivity;for(;e;)e.isSuspended=!1,e=e.parent;this.activityTree.suspendedActivity=null}}endAttemptProcess(e){e.isActive&&(e.isActive=!1,"unknown"===e.completionStatus&&(e.completionStatus="incomplete"),"unknown"===e.successStatus&&e.objectiveSatisfiedStatus&&(e.successStatus=e.objectiveSatisfiedStatus?"passed":"failed"),this.rollupProcess.processGlobalObjectiveMapping(e,this.globalObjectiveMap),this.rollupProcess.overallRollupProcess(e),this.activityTree.root&&this.rollupProcess.validateRollupStateConsistency(this.activityTree.root))}updateNavigationValidity(){if(!this.adlNav||!this.activityTree.currentActivity)return;const e=this.navigationRequestProcess("continue");try{this.adlNav.request_valid.continue=e.valid?"true":"false"}catch(e){}const t=this.navigationRequestProcess("previous");try{this.adlNav.request_valid.previous=t.valid?"true":"false"}catch(e){}const i=this.activityTree.getAllActivities(),s={},n={};for(const e of i){const t=this.navigationRequestProcess("choice",e.id);s[e.id]=t.valid?"true":"false";const i=this.navigationRequestProcess("jump",e.id);n[e.id]=i.valid?"true":"false"}try{this.adlNav.request_valid.choice=s}catch(e){}try{this.adlNav.request_valid.jump=n}catch(e){}this.fireEvent("onNavigationValidityUpdate",{continue:e.valid,previous:t.valid,choice:s,jump:n})}findCommonAncestor(e,t){const i=[];let s=e;for(;s;)i.push(s),s=s.parent;for(s=t;s;){if(i.includes(s))return s;s=s.parent}return null}hasContentBeenDelivered(){return this.contentDelivered}resetContentDelivered(){this.contentDelivered=!1}exitActionRulesSubprocess(e){const t=e.sequencingRules.exitConditionRules;for(const i of t){let t=!0;if(t="all"===i.conditionCombination?i.conditions.every(t=>t.evaluate(e)):i.conditions.some(t=>t.evaluate(e)),t){if(i.action===$e.EXIT_PARENT)return"EXIT_PARENT";if(i.action===$e.EXIT_ALL)return"EXIT_ALL"}}return null}terminateAllActivities(e){for(const t of e.children)this.terminateAllActivities(t);e.isActive&&this.endAttemptProcess(e)}limitConditionsCheckProcess(e){let result=!0,t="";if(null!==e.attemptLimit&&e.attemptLimit>0&&(e.attemptLimit>e.attemptCount||(result=!1,t="Attempt limit exceeded")),result&&e.attemptAbsoluteDurationLimit){const i=r(e.attemptAbsoluteDuration||"PT0H0M0S",X);r(e.attemptAbsoluteDurationLimit,X)>i||(result=!1,t="Attempt duration limit exceeded")}if(result&&e.activityAbsoluteDurationLimit){const i=r(e.activityAbsoluteDuration||"PT0H0M0S",X);r(e.activityAbsoluteDurationLimit,X)>i||(result=!1,t="Activity duration limit exceeded")}if(result&&e.beginTimeLimit){const i=this.now();new Date(e.beginTimeLimit)>i&&(result=!1,t="Not yet time to begin")}return result&&e.endTimeLimit&&this.now()>new Date(e.endTimeLimit)&&(result=!1,t="Time limit expired"),this.fireEvent("onLimitConditionCheck",{activity:e,result:result,failureReason:t,checks:{attemptLimit:e.attemptLimit,attemptCount:e.attemptCount,attemptDurationLimit:e.attemptAbsoluteDurationLimit,activityDurationLimit:e.activityAbsoluteDurationLimit,beginTimeLimit:e.beginTimeLimit,endTimeLimit:e.endTimeLimit}}),result}checkActivityProcess(e){return!(!e.isAvailable||!this.limitConditionsCheckProcess(e)||e.children.length>0&&!e.sequencingControls.flow)}terminateDescendentAttemptsProcess(e){for(const t of e.children){t.children.length>0&&this.terminateDescendentAttemptsProcess(t);const e=this.exitActionRulesSubprocess(t);t.isActive&&("EXIT_ALL"===e&&this.terminateDescendentAttemptsProcess(t),this.endAttemptProcess(t))}}getSequencingState(){return{version:"1.0",timestamp:(new Date).toISOString(),contentDelivered:this.contentDelivered,currentActivity:this.activityTree.currentActivity?.id||null,suspendedActivity:this.activityTree.suspendedActivity?.id||null,activityStates:this.serializeActivityStates(),navigationState:this.getNavigationState()}}restoreSequencingState(e){try{if(!e||"1.0"!==e.version)return console.warn("Incompatible sequencing state version"),!1;if(this.contentDelivered=e.contentDelivered||!1,e.activityStates&&this.deserializeActivityStates(e.activityStates),e.currentActivity){const t=this.activityTree.getActivity(e.currentActivity);t&&(this.activityTree.currentActivity=t,t.isActive=!0)}if(e.suspendedActivity){const t=this.activityTree.getActivity(e.suspendedActivity);t&&(this.activityTree.suspendedActivity=t,t.isSuspended=!0)}return e.navigationState&&this.restoreNavigationState(e.navigationState),console.debug("Sequencing state restored successfully"),!0}catch(e){return console.error("Failed to restore sequencing state: "+e),!1}}serializeActivityStates(){const e={},t=i=>{e[i.id]={id:i.id,title:i.title,isActive:i.isActive,isSuspended:i.isSuspended,isCompleted:i.isCompleted,completionStatus:i.completionStatus,successStatus:i.successStatus,attemptCount:i.attemptCount,attemptCompletionAmount:i.attemptCompletionAmount,attemptAbsoluteDuration:i.attemptAbsoluteDuration,attemptExperiencedDuration:i.attemptExperiencedDuration,activityAbsoluteDuration:i.activityAbsoluteDuration,activityExperiencedDuration:i.activityExperiencedDuration,objectiveSatisfiedStatus:i.objectiveSatisfiedStatus,objectiveMeasureStatus:i.objectiveMeasureStatus,objectiveNormalizedMeasure:i.objectiveNormalizedMeasure,progressMeasure:i.progressMeasure,progressMeasureStatus:i.progressMeasureStatus,isAvailable:i.isAvailable,location:i.location,attemptAbsoluteStartTime:i.attemptAbsoluteStartTime};for(const e of i.children)t(e)};return this.activityTree.root&&t(this.activityTree.root),e}deserializeActivityStates(e){const t=i=>{const s=e[i.id];s&&(i.isActive=s.isActive||!1,i.isSuspended=s.isSuspended||!1,i.isCompleted=s.isCompleted||!1,i.completionStatus=s.completionStatus||"unknown",i.successStatus=s.successStatus||"unknown",i.attemptCount=s.attemptCount||0,i.attemptCompletionAmount=s.attemptCompletionAmount||0,i.attemptAbsoluteDuration=s.attemptAbsoluteDuration||"PT0H0M0S",i.attemptExperiencedDuration=s.attemptExperiencedDuration||"PT0H0M0S",i.activityAbsoluteDuration=s.activityAbsoluteDuration||"PT0H0M0S",i.activityExperiencedDuration=s.activityExperiencedDuration||"PT0H0M0S",i.objectiveSatisfiedStatus=s.objectiveSatisfiedStatus||!1,i.objectiveMeasureStatus=s.objectiveMeasureStatus||!1,i.objectiveNormalizedMeasure=s.objectiveNormalizedMeasure||0,i.progressMeasure=s.progressMeasure||null,i.progressMeasureStatus=s.progressMeasureStatus||!1,i.isAvailable=!1!==s.isAvailable,i.location=s.location||"",i.attemptAbsoluteStartTime=s.attemptAbsoluteStartTime||null);for(const e of i.children)t(e)};this.activityTree.root&&t(this.activityTree.root)}getNavigationState(){return this.adlNav?{request:this.adlNav.request||"_none_",requestValid:{continue:this.adlNav.request_valid?.continue||"false",previous:this.adlNav.request_valid?.previous||"false",choice:this.adlNav.request_valid?.choice||"false",jump:this.adlNav.request_valid?.jump||"false",exit:this.adlNav.request_valid?.exit||"false",exitAll:this.adlNav.request_valid?.exitAll||"false",abandon:this.adlNav.request_valid?.abandon||"false",abandonAll:this.adlNav.request_valid?.abandonAll||"false",suspendAll:this.adlNav.request_valid?.suspendAll||"false"}}:null}restoreNavigationState(e){if(this.adlNav&&e)try{if(e.requestValid){const t=e.requestValid;this.adlNav.request_valid.continue=t.continue||"false",this.adlNav.request_valid.previous=t.previous||"false",this.adlNav.request_valid.choice=t.choice||"false",this.adlNav.request_valid.jump=t.jump||"false",this.adlNav.request_valid.exit=t.exit||"false",this.adlNav.request_valid.exitAll=t.exitAll||"false",this.adlNav.request_valid.abandon=t.abandon||"false",this.adlNav.request_valid.abandonAll=t.abandonAll||"false",this.adlNav.request_valid.suspendAll=t.suspendAll||"false"}}catch(e){console.warn("Could not fully restore navigation state: "+e)}}validateComplexChoicePath(e,t){if(t.isHiddenFromChoice)return{valid:!1,exception:"NB.2.1-11"};if(this.isActivityDisabled(t))return{valid:!1,exception:"NB.2.1-11"};if(e){const i=this.findCommonAncestor(e,t);if(!i)return{valid:!1,exception:"NB.2.1-11"};const s=this.validateConstrainChoiceControls(e,t,i);if(!s.valid)return s;const n=this.validateChoiceSetConstraints(e,t,i);if(!n.valid)return n}let i=t;for(;i;){if(i.parent&&!i.parent.sequencingControls.choice)return{valid:!1,exception:"NB.2.1-11"};i=i.parent}return{valid:!0,exception:null}}validateForwardOnlyConstraints(e){if(e.parent?.sequencingControls.forwardOnly)return{valid:!1,exception:"NB.2.1-8"};let t=e.parent?.parent;for(;t;){if(t.sequencingControls.forwardOnly)return{valid:!1,exception:"NB.2.1-8"};t=t.parent}return{valid:!0,exception:null}}validateConstrainChoiceControls(e,t,i){if(i.sequencingControls.constrainChoice){const s=i.children.indexOf(this.findChildContaining(i,e)),n=i.children.indexOf(this.findChildContaining(i,t));if(Math.abs(s-n)>1)return{valid:!1,exception:"NB.2.1-11"}}let s=i.parent;for(;s;){if(s.sequencingControls.constrainChoice){const i=this.validateAncestorConstraints(s,e,t);if(!i.valid)return i}s=s.parent}return{valid:!0,exception:null}}validateChoiceSetConstraints(e,t,i){return this.getValidChoiceSet(i,e).includes(t)?{valid:!0,exception:null}:{valid:!1,exception:"NB.2.1-11"}}isActivityDisabled(e){return"DISABLED"===this.evaluatePreConditionRulesForChoice(e)}findChildContaining(e,t){for(const i of e.children){if(i===t)return i;if(this.activityContains(i,t))return i}return null}activityContains(e,t){let i=t;for(;i;){if(i===e)return!0;i=i.parent}return!1}validateAncestorConstraints(e,t,i){const s=e.children;if(!s||0===s.length)return{valid:!0,exception:null};const n=this.findChildContaining(e,t),r=this.findChildContaining(e,i);if(!n||!r)return{valid:!1,exception:"NB.2.1-11"};const o=s.indexOf(n),a=s.indexOf(r);if(e.sequencingControls.forwardOnly&&o>a)return{valid:!1,exception:"NB.2.1-8"};if(a>o)for(let e=o+1;a>e;e++){const t=s[e];if(t&&this.helperIsActivityMandatory(t)&&!this.helperIsActivityCompleted(t))return{valid:!1,exception:"NB.2.1-11"}}return{valid:!0,exception:null}}helperIsActivityMandatory(e){if(e.sequencingRules&&e.sequencingRules.preConditionRules)for(const t of e.sequencingRules.preConditionRules)if("skip"===t.action&&t.conditions&&0===t.conditions.length)return!1;return!1!==e.mandatory}helperIsActivityCompleted(e){return"completed"===e.completionStatus||"passed"===e.successStatus||"passed"===e.successStatus}getValidChoiceSet(e,t){const i=[],s=this.getAllDescendants(e);for(const e of s)this.isValidChoiceTarget(e,t)&&i.push(e);return i}getAllDescendants(e){const t=[];for(const i of e.children)t.push(i),t.push(...this.getAllDescendants(i));return t}isValidChoiceTarget(e,t){return!e.isHiddenFromChoice&&e!==t&&!this.isActivityDisabled(e)}evaluatePreConditionRulesForChoice(e){const t=e.sequencingRules.preConditionRules;for(const i of t){let t=!0;if(t="all"===i.conditionCombination?i.conditions.every(t=>t.evaluate(e)):i.conditions.some(t=>t.evaluate(e)),t)switch(i.action){case"skip":return"SKIP";case"disabled":return"DISABLED";case"hideFromChoice":return"HIDDEN_FROM_CHOICE"}}return null}validateActivityTreeStateConsistency(e){if(!this.activityTree.root)return{consistent:!1,exception:"DB.1.1-4"};if(!this.isActivityPartOfTree(e,this.activityTree.root))return{consistent:!1,exception:"DB.1.1-5"};const t=this.getActiveActivities();if(t.length>1)return this.fireEvent("onStateInconsistency",{activeActivities:t.map(e=>e.id),targetActivity:e.id}),{consistent:!1,exception:"DB.1.1-6"};let i=e;for(;i?.parent;){if(!i.parent.children.includes(i))return{consistent:!1,exception:"DB.1.1-7"};i=i.parent}return{consistent:!0,exception:null}}validateResourceConstraints(e){const t=this.getActivityRequiredResources(e);for(const e of t)if(!this.isResourceAvailable(e))return{available:!1,exception:"DB.1.1-8"};return this.checkSystemResourceLimits().adequate?{available:!0,exception:null}:{available:!1,exception:"DB.1.1-9"}}validateConcurrentDeliveryPrevention(e){return this.contentDelivered&&this.activityTree.currentActivity&&this.activityTree.currentActivity!==e?{allowed:!1,exception:"DB.1.1-10"}:this.hasPendingDeliveryRequests()?{allowed:!1,exception:"DB.1.1-11"}:this.isDeliveryLocked()?{allowed:!1,exception:"DB.1.1-12"}:{allowed:!0,exception:null}}validateActivityDependencies(e){const t=this.getActivityPrerequisites(e);for(const i of t)if(!this.isPrerequisiteSatisfied(i,e))return{satisfied:!1,exception:"DB.1.1-13"};const i=this.getObjectiveDependencies(e);for(const e of i)if(!this.isObjectiveDependencySatisfied(e))return{satisfied:!1,exception:"DB.1.1-14"};return this.getSequencingRuleDependencies(e).satisfied?{satisfied:!0,exception:null}:{satisfied:!1,exception:"DB.1.1-15"}}isActivityPartOfTree(e,t){if(e===t)return!0;for(const i of t.children)if(this.isActivityPartOfTree(e,i))return!0;return!1}getActiveActivities(){const e=[];return this.activityTree.root&&this.collectActiveActivities(this.activityTree.root,e),e}collectActiveActivities(e,t){e.isActive&&t.push(e);for(const i of e.children)this.collectActiveActivities(i,t)}getActivityRequiredResources(e){const t=[],i=(e.title+" "+e.location).toLowerCase();return(i.includes("video")||i.includes("multimedia"))&&t.push("video-codec"),(i.includes("audio")||i.includes("sound"))&&t.push("audio-codec"),(i.includes("flash")||i.includes(".swf"))&&t.push("flash-plugin"),(i.includes("java")||i.includes("applet"))&&t.push("java-runtime"),e.children&&e.children.length>0&&t.push("high-bandwidth"),e.attemptAbsoluteDurationLimit&&this.parseDurationToMinutes(e.attemptAbsoluteDurationLimit)>60&&t.push("extended-storage"),e.attemptLimit&&e.attemptLimit>1&&t.push("persistent-storage"),t}isResourceAvailable(e){try{switch(e){case"video-codec":return!!document.createElement("video").canPlayType;case"audio-codec":return!!document.createElement("audio").canPlayType;case"flash-plugin":return navigator.plugins&&Array.from(navigator.plugins).some(e=>"Shockwave Flash"===e.name);case"java-runtime":return navigator.plugins&&Array.from(navigator.plugins).some(e=>"Java"===e.name);case"high-bandwidth":if("connection"in navigator){const e=navigator.connection;return"4g"===e.effectiveType||e.downlink>5}return!0;case"extended-storage":return"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(e=>(e.quota||0)>104857600),!0;case"persistent-storage":return"localStorage"in window&&"sessionStorage"in window;default:return!0}}catch(e){return!1}}checkSystemResourceLimits(){try{let e=!0;if("memory"in performance){const t=performance.memory;t.usedJSHeapSize/t.jsHeapSizeLimit>.8&&(e=!1)}if("deviceMemory"in navigator&&2>navigator.deviceMemory&&(e=!1),"hardwareConcurrency"in navigator&&2>navigator.hardwareConcurrency&&(e=!1),"connection"in navigator){const t=navigator.connection;(t.saveData||"slow-2g"===t.effectiveType)&&(e=!1)}return{adequate:e}}catch(e){return{adequate:!0}}}hasPendingDeliveryRequests(){if(this.activityTree&&this.activityTree.pendingRequests)return this.activityTree.pendingRequests.length>0;if("undefined"!=typeof window&&window.pendingScormRequests)return window.pendingScormRequests>0;if(this.eventCallback)try{this.eventCallback("check_pending_requests",{})}catch(e){}return!1}isDeliveryLocked(){return!((!this.activityTree||!this.activityTree.navigationLocked)&&(!this.activityTree||!this.activityTree.terminationInProgress)&&this.checkSystemResourceLimits().adequate&&("undefined"==typeof window||!window.scormMaintenanceMode))}getActivityPrerequisites(e){const t=[];if(e.sequencingRules&&e.sequencingRules.preConditionRules)for(const i of e.sequencingRules.preConditionRules)if(i.conditions&&i.conditions.length>0)for(const s of i.conditions)s.referencedObjectiveID&&s.referencedObjectiveID!==e.id&&t.push(s.referencedObjectiveID);if(e.parent&&e.sequencingControls&&!e.sequencingControls.choiceExit){const i=e.parent.children;if(i){const s=i.indexOf(e);for(let e=0;s>e;e++){const s=i[e];s&&t.push(s.id)}}}return e.prerequisiteActivities&&t.push(...e.prerequisiteActivities),Array.from(new Set(t))}isPrerequisiteSatisfied(e,t){const i=this.activityTree.getActivity(e);return!!i&&"completed"===i.completionStatus}getObjectiveDependencies(e){const t=[],objectives=e.objectives;if(objectives&&objectives.length>0)for(const e of objectives)e.globalObjectiveID&&t.push(e.globalObjectiveID),!e.satisfiedByMeasure&&e.readNormalizedMeasure&&t.push(e.id+"_measure");if(e.sequencingRules){const i=[...e.sequencingRules.preConditionRules||[],...e.sequencingRules.exitConditionRules||[],...e.sequencingRules.postConditionRules||[]];for(const s of i)if(s.conditions&&s.conditions.length>0)for(const i of s.conditions)i.objectiveReference&&i.objectiveReference!==e.id&&t.push(i.objectiveReference)}return Array.from(new Set(t))}isObjectiveDependencySatisfied(e){if(this.activityTree&&this.activityTree.globalObjectives){const t=this.activityTree.globalObjectives[e];if(t)return!0===t.satisfied&&!0===t.statusKnown}if(e.endsWith("_measure")){const t=e.replace("_measure","");if(this.activityTree&&this.activityTree.globalObjectives){const e=this.activityTree.globalObjectives[t];if(e)return!0===e.measureKnown&&e.normalizedMeasure>=0}}const t=this.activityTree.getActivity(e);return!!t&&t.objectiveSatisfiedStatus&&t.objectiveMeasureStatus}getSequencingRuleDependencies(e){let t=!0;try{if(e.sequencingRules&&e.sequencingRules.preConditionRules)for(const i of e.sequencingRules.preConditionRules)if(i.conditions&&i.conditions.length>0)for(const s of i.conditions)switch(s.conditionType||s.condition){case"activityProgressKnown":e.progressMeasureStatus||(t=!1);break;case"objectiveStatusKnown":case"objectiveSatisfied":this.isObjectiveDependencySatisfied(s.referencedObjectiveID||e.id)||(t=!1);break;case"attemptLimitExceeded":null===e.attemptLimit&&(t=!1);break;case"timeLimitExceeded":e.attemptAbsoluteDurationLimit||e.activityAbsoluteDurationLimit||(t=!1);break;case"always":case"never":break;default:t=!1}if(e.sequencingRules&&e.sequencingRules.exitConditionRules)for(const i of e.sequencingRules.exitConditionRules)if(i.conditions&&i.conditions.length>0)for(const s of i.conditions)["objectiveStatusKnown","objectiveSatisfied"].includes(s.conditionType||s.condition)&&(this.isObjectiveDependencySatisfied(s.referencedObjectiveID||e.id)||(t=!1));if(e.rollupRules&&e.rollupRules.rules)for(const i of e.rollupRules.rules)if(i.conditions&&i.conditions.length>0&&e.children&&e.children.length>0)for(const i of e.children)if(!i.isCompleted){t=!1;break}}catch(e){t=!1}return{satisfied:t}}parseDurationToMinutes(e){return r(e,X)/60}initializeGlobalObjectiveMap(){try{this.globalObjectiveMap.clear(),this.activityTree.root&&this.collectGlobalObjectives(this.activityTree.root),this.fireEvent("onGlobalObjectiveMapInitialized",{objectiveCount:this.globalObjectiveMap.size,timestamp:(new Date).toISOString()})}catch(e){this.fireEvent("onGlobalObjectiveMapError",{error:e instanceof Error?e.message:e+"",timestamp:(new Date).toISOString()})}}collectGlobalObjectives(e){const t=e.id+"_global";this.globalObjectiveMap.has(t)||this.globalObjectiveMap.set(t,{id:t,satisfiedStatus:e.objectiveSatisfiedStatus,satisfiedStatusKnown:e.objectiveMeasureStatus,normalizedMeasure:e.objectiveNormalizedMeasure,normalizedMeasureKnown:e.objectiveMeasureStatus,progressMeasure:e.progressMeasure,progressMeasureKnown:e.progressMeasureStatus,completionStatus:e.completionStatus,completionStatusKnown:"unknown"!==e.completionStatus,readSatisfiedStatus:!0,writeSatisfiedStatus:!0,readNormalizedMeasure:!0,writeNormalizedMeasure:!0,readProgressMeasure:!0,writeProgressMeasure:!0,readCompletionStatus:!0,writeCompletionStatus:!0,satisfiedByMeasure:null!==e.scaledPassingScore,updateAttemptData:!0});for(const t of e.children)this.collectGlobalObjectives(t)}getGlobalObjectiveMap(){return this.globalObjectiveMap}updateGlobalObjective(e,t){try{this.globalObjectiveMap.set(e,{...this.globalObjectiveMap.get(e),...t,lastUpdated:(new Date).toISOString()}),this.fireEvent("onGlobalObjectiveUpdated",{objectiveId:e,data:t,timestamp:(new Date).toISOString()})}catch(t){this.fireEvent("onGlobalObjectiveUpdateError",{objectiveId:e,error:t instanceof Error?t.message:t+"",timestamp:(new Date).toISOString()})}}}class gt{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.currentDeliveredActivity=null,this.pendingDelivery=null,this.eventService=e,this.loggingService=t,this.callbacks=i}processSequencingResult(result){if(result.exception)return this.loggingService.error("Sequencing error: "+result.exception),void this.callbacks.onSequencingError?.(result.exception);result.deliveryRequest===at.DELIVER&&result.targetActivity?this.deliverActivity(result.targetActivity):this.loggingService.info("Sequencing completed with no delivery request"),this.callbacks.onSequencingComplete?.(result)}deliverActivity(e){this.currentDeliveredActivity&&this.currentDeliveredActivity!==e&&this.unloadActivity(this.currentDeliveredActivity),this.pendingDelivery=e,this.loggingService.info(`Delivering activity: ${e.id} - ${e.title}`),this.eventService.processListeners("ActivityDelivery",e.id,e),this.callbacks.onDeliverActivity?.(e),this.currentDeliveredActivity=e,this.pendingDelivery=null,e.isActive=!0}unloadActivity(e){this.loggingService.info(`Unloading activity: ${e.id} - ${e.title}`),this.eventService.processListeners("ActivityUnload",e.id,e),this.callbacks.onUnloadActivity?.(e),e.isActive=!1}getCurrentDeliveredActivity(){return this.currentDeliveredActivity}getPendingDelivery(){return this.pendingDelivery}updateCallbacks(e){this.callbacks={...this.callbacks,...e}}reset(){this.currentDeliveredActivity&&this.unloadActivity(this.currentDeliveredActivity),this.currentDeliveredActivity=null,this.pendingDelivery=null}}class _t{constructor(e,cmi,adl,t,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.overallSequencingProcess=null,this.sequencingProcess=null,this.eventListeners={},this.isInitialized=!1,this.isSequencingActive=!1,this.lastCMIValues=new Map,this.lastSequencingResult=null,this.sequencing=e,this.cmi=cmi,this.adl=adl,this.eventService=t,this.loggingService=i,this.configuration={autoRollupOnCMIChange:!0,autoProgressOnCompletion:!1,validateNavigationRequests:!0,enableEventSystem:!0,logLevel:"info",now:()=>new Date,...s},this.activityDeliveryService=new gt(t,i,{onDeliverActivity:e=>this.handleActivityDelivery(e),onUnloadActivity:e=>this.handleActivityUnload(e),onSequencingComplete:result=>this.handleSequencingComplete(result),onSequencingError:e=>this.handleSequencingError(e)}),this.rollupProcess=new nt,this.configuration.now&&He.setNowProvider(this.configuration.now),this.setupCMIChangeWatchers()}initialize(){try{if(this.log("info","Initializing sequencing service"),this.sequencing.initialized||this.sequencing.initialize(),this.sequencing.adlNav=this.adl.nav,this.sequencing.activityTree.root){const e={};this.configuration.now&&(e.now=this.configuration.now),this.configuration.getAttemptElapsedSeconds&&(e.getAttemptElapsedSeconds=this.configuration.getAttemptElapsedSeconds),this.configuration.getActivityElapsedSeconds&&(e.getActivityElapsedSeconds=this.configuration.getActivityElapsedSeconds),this.sequencingProcess=new lt(this.sequencing.activityTree,this.sequencing.sequencingRules,this.sequencing.sequencingControls,this.adl.nav,e);const t={};this.configuration.now&&(t.now=this.configuration.now),this.overallSequencingProcess=new mt(this.sequencing.activityTree,this.sequencingProcess,this.rollupProcess,this.adl.nav,(e,t)=>this.handleSequencingProcessEvent(e,t),t),this.log("info","Sequencing processes created")}return this.shouldAutoStartSequencing()&&this.startSequencing(),this.initializeCMITracking(),this.isInitialized=!0,this.fireEvent("onSequencingStart",this.sequencing.getCurrentActivity()),this.log("info","Sequencing service initialized successfully"),e}catch(e){const i="Failed to initialize sequencing service: "+e;return this.log("error",i),this.fireEvent("onSequencingError",i,"initialization"),t}}terminate(){try{return this.log("info","Terminating sequencing service"),"_none_"!==this.adl.nav.request&&this.processNavigationRequest(this.adl.nav.request),this.triggerFinalRollup(),this.endSequencing(),this.isInitialized=!1,this.fireEvent("onSequencingEnd"),this.log("info","Sequencing service terminated successfully"),e}catch(e){const i="Failed to terminate sequencing service: "+e;return this.log("error",i),this.fireEvent("onSequencingError",i,"termination"),t}}processNavigationRequest(request,e){if(!this.isInitialized||!this.overallSequencingProcess)return this.log("warn",`Navigation request '${request}' ignored - sequencing not initialized`),!1;try{this.log("info",`Processing navigation request: ${request}${e?` (target: ${e})`:""}`),this.fireEvent("onNavigationRequest",request,e);const t=this.parseNavigationRequest(request);if(null===t)return this.log("warn","Invalid navigation request: "+request),!1;const i=this.overallSequencingProcess.processNavigationRequest(t,e||null);if(i.valid&&i.targetActivity){const e={deliveryRequest:i.valid?at.DELIVER:at.DO_NOT_DELIVER,targetActivity:i.targetActivity,exception:i.exception||null};return this.lastSequencingResult=e,this.activityDeliveryService.processSequencingResult(e),this.log("info",`Navigation request '${request}' resulted in activity delivery: ${i.targetActivity.id}`),!0}return i.exception?(this.log("warn",`Navigation request '${request}' failed: ${i.exception}`),this.fireEvent("onSequencingError",i.exception,"navigation")):this.log("info",`Navigation request '${request}' completed with no activity delivery`),i.valid}catch(e){const t=`Error processing navigation request '${request}': ${e}`;return this.log("error",t),this.fireEvent("onSequencingError",t,"navigation"),!1}}triggerRollupOnCMIChange(e,t,i){if(this.configuration.autoRollupOnCMIChange&&this.isInitialized&&["cmi.completion_status","cmi.success_status","cmi.score.scaled","cmi.score.raw","cmi.score.min","cmi.score.max","cmi.progress_measure","cmi.objectives.n.success_status","cmi.objectives.n.completion_status","cmi.objectives.n.score.scaled"].some(t=>e.startsWith(t)))try{this.log("debug",`Triggering rollup due to CMI change: ${e} = ${i} (was ${t})`);const s=this.sequencing.getCurrentActivity();if(!s)return void this.log("debug","No current activity for rollup");this.updateActivityFromCMI(s),this.rollupProcess.overallRollupProcess(s),this.fireEvent("onRollupComplete",s),this.log("debug","Rollup completed for activity: "+s.id)}catch(e){const t="Error during rollup on CMI change: "+e;this.log("error",t),this.fireEvent("onSequencingError",t,"rollup")}}setEventListeners(e){this.eventListeners={...this.eventListeners,...e},this.log("debug","Sequencing event listeners updated")}updateConfiguration(e){this.configuration={...this.configuration,...e},this.log("debug","Sequencing configuration updated")}getSequencingState(){return{isInitialized:this.isInitialized,isActive:this.isSequencingActive,currentActivity:this.sequencing.getCurrentActivity(),rootActivity:this.sequencing.getRootActivity(),lastSequencingResult:this.lastSequencingResult}}getOverallSequencingProcess(){return this.overallSequencingProcess}setupCMIChangeWatchers(){}initializeCMITracking(){this.lastCMIValues.set("cmi.completion_status",this.cmi.completion_status),this.lastCMIValues.set("cmi.success_status",this.cmi.success_status),this.lastCMIValues.set("cmi.progress_measure",this.cmi.progress_measure),this.cmi.score&&(this.lastCMIValues.set("cmi.score.scaled",this.cmi.score.scaled),this.lastCMIValues.set("cmi.score.raw",this.cmi.score.raw))}shouldAutoStartSequencing(){return!(!this.sequencing.activityTree.root||this.sequencing.getCurrentActivity())}startSequencing(){if(this.overallSequencingProcess)try{this.processNavigationRequest("start")&&(this.isSequencingActive=!0,this.log("info","Automatic sequencing started"))}catch(e){this.log("error","Failed to start automatic sequencing: "+e)}}endSequencing(){this.isSequencingActive=!1,this.activityDeliveryService.reset()}triggerFinalRollup(){try{const e=this.sequencing.getCurrentActivity();e&&(this.updateActivityFromCMI(e),this.rollupProcess.overallRollupProcess(e),this.log("info","Final rollup completed"))}catch(e){this.log("error","Error during final rollup: "+e)}}updateActivityFromCMI(e){if("unknown"!==this.cmi.completion_status&&(e.completionStatus=this.cmi.completion_status),"unknown"!==this.cmi.success_status&&(e.successStatus=this.cmi.success_status,e.objectiveSatisfiedStatus="passed"===this.cmi.success_status),""!==this.cmi.progress_measure){const t=parseFloat(this.cmi.progress_measure);isNaN(t)||(e.progressMeasure=t,e.progressMeasureStatus=!0)}if(this.cmi.score&&""!==this.cmi.score.scaled){const t=parseFloat(this.cmi.score.scaled);isNaN(t)||(e.objectiveNormalizedMeasure=t,e.objectiveMeasureStatus=!0)}}parseNavigationRequest(request){if(request.includes("choice"))return ut.CHOICE;if(request.includes("jump"))return ut.JUMP;switch(request){case"start":return ut.START;case"resumeAll":return ut.RESUME_ALL;case"continue":return ut.CONTINUE;case"previous":return ut.PREVIOUS;case"exit":return ut.EXIT;case"exitAll":return ut.EXIT_ALL;case"abandon":return ut.ABANDON;case"abandonAll":return ut.ABANDON_ALL;case"suspendAll":return ut.SUSPEND_ALL;case"_none_":return ut.NOT_VALID;default:return null}}handleActivityDelivery(e){this.log("info",`Activity delivered: ${e.id} - ${e.title}`),this.fireEvent("onActivityDelivery",e)}handleActivityUnload(e){this.log("info",`Activity unloaded: ${e.id} - ${e.title}`),this.fireEvent("onActivityUnload",e)}handleSequencingComplete(result){this.log("debug","Sequencing completed",result)}handleSequencingError(e){this.log("error","Sequencing error: "+e),this.fireEvent("onSequencingError",e,"sequencing")}fireEvent(e){if(this.configuration.enableEventSystem){for(var t=arguments.length,i=Array(t>1?t-1:0),s=1;t>s;s++)i[s-1]=arguments[s];"onSequencingDebug"!==e&&this.fireDebugEvent(e+" fired",{eventType:e,argsLength:i.length});try{const t=this.eventListeners[e];if(t&&"function"==typeof t)try{t(...i),this.log("debug",`Internal listener for ${e} executed successfully`)}catch(t){this.log("error",`Internal listener for ${e} failed: ${t}`)}try{this.eventService.processListeners("Sequencing."+e,i[0],...i.slice(1)),this.log("debug",`Event service listeners for ${e} processed`)}catch(t){this.log("warn",`Event service failed for ${e}: ${t}`)}try{if("undefined"!=typeof window&&window.scormSequencingEvents){const t=window.scormSequencingEvents;t[e]&&"function"==typeof t[e]&&(t[e](...i),this.log("debug",`Global listener for ${e} executed`))}}catch(t){this.log("warn",`Global listener for ${e} failed: ${t}`)}}catch(t){this.log("error",`Critical error firing event ${e}: ${t}`)}}}fireDebugEvent(e,t){try{const i=this.eventListeners.onSequencingDebug;i&&"function"==typeof i&&i(e,{timestamp:(new Date).toISOString(),...t});try{this.eventService.processListeners("Sequencing.onSequencingDebug",e,{timestamp:(new Date).toISOString(),...t})}catch(e){}}catch(e){console.debug("Debug event failed: "+e)}}fireActivityAttemptStart(e){this.fireEvent("onActivityAttemptStart",e),this.fireDebugEvent("Activity attempt started",{activityId:e.id,title:e.title,attemptCount:e.attemptCount})}fireActivityAttemptEnd(e){this.fireEvent("onActivityAttemptEnd",e),this.fireDebugEvent("Activity attempt ended",{activityId:e.id,title:e.title,completionStatus:e.completionStatus,successStatus:e.successStatus})}fireLimitConditionCheck(e,result){this.fireEvent("onLimitConditionCheck",e,result),this.fireDebugEvent("Limit condition check",{activityId:e.id,result:result,attemptCount:e.attemptCount,attemptLimit:e.attemptLimit})}fireNavigationValidityUpdate(e){this.fireEvent("onNavigationValidityUpdate",e),this.fireDebugEvent("Navigation validity updated",{validity:e})}fireSequencingStateChange(e){this.fireEvent("onSequencingStateChange",e),this.fireDebugEvent("Sequencing state changed",{stateKeys:Object.keys(e)})}handleSequencingProcessEvent(e,t){try{switch(e){case"onActivityDelivery":this.fireEvent("onActivityDelivery",t);break;case"onLimitConditionCheck":this.fireLimitConditionCheck(t.activity,t.result);break;case"onActivityAttemptStart":this.fireActivityAttemptStart(t);break;case"onActivityAttemptEnd":this.fireActivityAttemptEnd(t);break;default:this.fireDebugEvent("Sequencing process event: "+e,t)}}catch(t){this.log("error",`Error handling sequencing process event ${e}: ${t}`)}}log(e,t,i){const s=["debug","info","warn","error"],n=this.configuration.logLevel||"info";if(s.indexOf(e)>=s.indexOf(n))switch(e){case"debug":this.loggingService.debug(`[Sequencing] ${t}${i?" - "+JSON.stringify(i):""}`);break;case"info":this.loggingService.info(`[Sequencing] ${t}${i?" - "+JSON.stringify(i):""}`);break;case"warn":this.loggingService.warn(`[Sequencing] ${t}${i?" - "+JSON.stringify(i):""}`);break;case"error":this.loggingService.error(`[Sequencing] ${t}${i?" - "+JSON.stringify(i):""}`)}}}return class extends z{constructor(e){e&&void 0===e.mastery_override&&(e.mastery_override=!1),super(j,e),this._version="1.0",this._globalObjectives=[],this._sequencingService=null,this._extractedScoItemIds=[],this.cmi=new De,this.adl=new xe,this._sequencing=new st,this.adl.sequencing=this._sequencing,e?.sequencing&&this.configureSequencing(e.sequencing),this.initializeSequencingService(e),this.Initialize=this.lmsInitialize,this.Terminate=this.lmsFinish,this.GetValue=this.lmsGetValue,this.SetValue=this.lmsSetValue,this.Commit=this.lmsCommit,this.GetLastError=this.lmsGetLastError,this.GetErrorString=this.lmsGetErrorString,this.GetDiagnostic=this.lmsGetDiagnostic}reset(e){this.commonReset(e),this.cmi?.reset(),this.adl?.reset(),this._sequencing?.reset()}get version(){return this._version}get globalObjectives(){return this._globalObjectives}lmsInitialize(){this.cmi.initialize();const result=this.initialize("Initialize","LMS was already initialized!","LMS is already finished!");return result===e&&this._sequencingService&&this._sequencingService.initialize(),result===e&&this.settings.sequencingStatePersistence&&this.loadSequencingState().catch(()=>{this.apiLog("lmsInitialize","Failed to auto-load sequencing state",S.WARN)}),result}lmsFinish(){return(async()=>{await this.internalFinish()})(),e}async internalFinish(){this._sequencingService&&this._sequencingService.terminate();const result=await this.terminate("Terminate",!0);if(result===e){let e=!1;if(this._sequencingService&&"_none_"!==this.adl.nav.request)try{let t="",request=this.adl.nav.request;const i=RegExp(ie),s=request.match(i);s&&(s.groups?.choice_target?(t=s.groups?.choice_target,request="choice"):s.groups?.jump_target&&(t=s.groups?.jump_target,request="jump")),e=this._sequencingService.processNavigationRequest(request,t)}catch(t){e=!1}if(!e)if("_none_"!==this.adl.nav.request){const e={continue:"SequenceNext",previous:"SequencePrevious",choice:"SequenceChoice",jump:"SequenceJump",exit:"SequenceExit",exitAll:"SequenceExitAll",abandon:"SequenceAbandon",abandonAll:"SequenceAbandonAll"};let request=this.adl.nav.request;const t=RegExp(ie),i=request.match(t);let s="";i&&(i.groups?.choice_target?(s=i.groups?.choice_target,request="choice"):i.groups?.jump_target&&(s=i.groups?.jump_target,request="jump"));const n=e[request];n&&this.processListeners(n,"adl.nav.request",s)}else this.settings.autoProgress&&this.processListeners("SequenceNext",void 0,"next")}return result}lmsGetValue(e){const t="^adl\\.nav\\.request_valid\\.(choice|jump)\\.{target=\\S{0,}([a-zA-Z0-9-_]+)}$";if(c(e,t)){const i=e.match(t);if(i){const request=i[1],e=i[2]?.replace(/{target=/g,"").replace(/}/g,"")||"";if("choice"===request||"jump"===request)return this.settings.scoItemIdValidator?this.settings.scoItemIdValidator(e)+"":this._extractedScoItemIds.length>0?this._extractedScoItemIds.includes(e)+"":this.settings?.scoItemIds?.includes(e)+""}}return this.getValue("GetValue",!0,e)}lmsSetValue(t,i){let s=null;try{s=this.getCMIValue(t)}catch(e){s=null}const result=this.setValue("SetValue","Commit",!0,t,i);if(result===e&&this._sequencingService)try{this._sequencingService.triggerRollupOnCMIChange(t,s,i)}catch(e){console.warn(`Sequencing rollup failed for ${t}: ${e}`)}return result===e&&"setValue"===this.settings.sequencingStatePersistence?.autoSaveOn&&["cmi.completion_status","cmi.success_status","cmi.score.scaled","cmi.objectives","adl.nav.request"].some(e=>t.startsWith(e))&&this.saveSequencingState().catch(()=>{this.apiLog("lmsSetValue","Failed to auto-save sequencing state",S.WARN)}),result}lmsCommit(){return this.settings.asyncCommit?this.scheduleCommit(500,"Commit"):(async()=>{await this.commit("Commit",!1)===e&&"commit"===this.settings.sequencingStatePersistence?.autoSaveOn&&await this.saveSequencingState().catch(()=>{this.apiLog("lmsCommit","Failed to auto-save sequencing state",S.WARN)})})(),e}lmsGetLastError(){return this.getLastError("GetLastError")}lmsGetErrorString(e){return this.getErrorString("GetErrorString",e)}lmsGetDiagnostic(e){return this.getDiagnostic("GetDiagnostic",e)}setCMIValue(e,t){if(c(e,"cmi\\.objectives\\.\\d+")){const i=+e.split(".")[2],s="cmi.objectives."+i;let n;if(c(e,"cmi\\.objectives\\.\\d+\\.id"))n=t;else{const e=this.cmi.objectives.findObjectiveByIndex(i);n=e?e.id:void 0}if(n&&this.settings.globalObjectiveIds?.includes(n)){let i=this._globalObjectives.findIndex(e=>e.id===n);if(-1===i){i=this._globalObjectives.length;const e=new we;e.id=n,this._globalObjectives.push(e)}const r=e.replace(s,"_globalObjectives."+i);this._commonSetCMIValue("SetGlobalObjectiveValue",!0,r,t)}}return this._commonSetCMIValue("SetValue",!0,e,t)}getChildElement(e,t,i){if(c(e,"cmi\\.objectives\\.\\d+"))return new we;if(i){if(c(e,"cmi\\.interactions\\.\\d+\\.correct_responses\\.\\d+"))return this.createCorrectResponsesObject(e,t);if(c(e,"cmi\\.interactions\\.\\d+\\.objectives\\.\\d+"))return new ue}else if(c(e,"cmi\\.interactions\\.\\d+"))return new le;return c(e,"cmi\\.comments_from_learner\\.\\d+")?new be:c(e,"cmi\\.comments_from_lms\\.\\d+")?new be(!0):c(e,"adl\\.data\\.\\d+")?new ze:null}createCorrectResponsesObject(e,t){const i=e.split("."),s=this.cmi.interactions.childArray[+i[2]];if(this.isInitialized()){if(void 0===s||!s.type)return this.throwSCORMError(e,j.DEPENDENCY_NOT_ESTABLISHED,e),null;{this.checkDuplicateChoiceResponse(e,s,t);const i=ae[s.type];if(!i)return this.throwSCORMError(e,j.GENERAL_SET_FAILURE,"Incorrect Response Type: "+s.type),null;this.checkValidResponseType(e,i,t,s.type)}}return"0"===this.lastErrorCode?new ge(s):null}checkValidResponseType(e,t,i,s){let n=[];t?.delimiter?n=(i+"").split(t.delimiter):n[0]=i,n.length>0&&t.max>=n.length?this.checkCorrectResponseValue(e,s,n,i):n.length>t.max&&this.throwSCORMError(e,j.GENERAL_SET_FAILURE,"Data Model Element Pattern Too Long: "+i)}checkDuplicateChoiceResponse(e,t,i){const s=t.correct_responses._count;if("choice"===t.type)for(let n=0;s>n&&"0"===this.lastErrorCode;n++)t.correct_responses.childArray[n].pattern===i&&this.throwSCORMError(e,j.GENERAL_SET_FAILURE,""+i)}validateCorrectResponse(e,t){const i=e.split("."),s=+i[4],n=this.cmi.interactions.childArray[+i[2]],r=n.correct_responses._count;this.checkDuplicateChoiceResponse(e,n,t);const o=ae[n.type];!o||void 0!==o.limit&&r>o.limit?this.throwSCORMError(e,j.GENERAL_SET_FAILURE,`Data Model Element Collection Limit Reached: ${e} - ${t}`):(this.checkValidResponseType(e,o,t,n.type),"0"===this.lastErrorCode&&(!o.duplicate||!this.checkDuplicatedPattern(n.correct_responses,s,t))||"0"===this.lastErrorCode&&""===t||"0"===this.lastErrorCode&&this.throwSCORMError(e,j.GENERAL_SET_FAILURE,`Data Model Element Pattern Already Exists: ${e} - ${t}`))}getCMIValue(e){return this._commonGetCMIValue("GetValue",!0,e)}getLmsErrorMessageDetails(e,t){let s="",n="";const r=i.error_descriptions[e+=""];return r&&(s=r.basicMessage,n=r.detailMessage),t?n:s}checkDuplicatedPattern(e,t,i){let s=!1;const n=e._count;for(let r=0;n>r&&!s;r++)r!==t&&e.childArray[r]===i&&(s=!0);return s}checkCorrectResponseValue(e,t,i,s){const n=ae[t];if(!n)return void this.throwSCORMError(e,j.TYPE_MISMATCH,"Incorrect Response Type: "+t);const r=RegExp(n.format);for(let o=0;i.length>o&&"0"===this.lastErrorCode;o++)if(t.match("^(fill-in|long-fill-in|matching|performance|sequencing)$")&&(i[o]=this.removeCorrectResponsePrefixes(e,i[o])),n?.delimiter2){const a=i[o].split(n.delimiter2);2===a.length&&a[0].match(r)&&n.format2&&a[1].match(RegExp(n.format2))||this.throwSCORMError(e,j.TYPE_MISMATCH,`${t}: ${s}`)}else{const a=i[o].match(r);if(!a&&""!==s||!a&&"true-false"===t)this.throwSCORMError(e,j.TYPE_MISMATCH,`${t}: ${s}`);else if("numeric"===t&&i.length>1)+i[0]>+i[1]&&this.throwSCORMError(e,j.TYPE_MISMATCH,`${t}: ${s}`);else if(""!==i[o]&&n.unique)for(let n=0;o>n&&"0"===this.lastErrorCode;n++)i[o]===i[n]&&this.throwSCORMError(e,j.TYPE_MISMATCH,`${t}: ${s}`)}}removeCorrectResponsePrefixes(e,t){let i=!1,s=!1,n=!1;const r=RegExp("^({(lang|case_matters|order_matters)=([^}]+)})");let o=t.match(r),a=null;for(;o;){switch(o[2]){case"lang":if(a=t.match("^(({lang=([a-zA-Z]{2,3}|i|x)?(-[a-zA-Z0-9-]{2,8})?}))(.*?)$"),a){const i=a[3];void 0!==i&&i.length>0&&(Ke.includes(i.toLowerCase())||this.throwSCORMError(e,j.TYPE_MISMATCH,""+t))}n=!0;break;case"case_matters":n||i||s||"true"!==o[3]&&"false"!==o[3]&&this.throwSCORMError(e,j.TYPE_MISMATCH,""+t),s=!0;break;case"order_matters":s||n||i||"true"!==o[3]&&"false"!==o[3]&&this.throwSCORMError(e,j.TYPE_MISMATCH,""+t),i=!0}o=(t=t.substring(o[1]?.length||0)).match(r)}return t}replaceWithAnotherScormAPI(e){this.cmi=e.cmi,this.adl=e.adl}renderCommitCMI(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=this.renderCMIToJSONObject();(e||t)&&(i.cmi.total_time=this.cmi.getCurrentTotalTime());const result=[],s=a(i);switch(this.settings.dataCommitFormat){case"flattened":return a(i);case"params":for(const e in s)({}).hasOwnProperty.call(s,e)&&result.push(`${e}=${s[e]}`);return result;default:return i}}renderCommitObject(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=this.renderCommitCMI(e,t),s=e||t?this.cmi.getCurrentTotalTime():"",n=r(s,X);let o=f,a=_;this.cmi.completion_status&&("completed"===this.cmi.completion_status?o=p:"incomplete"===this.cmi.completion_status&&(o=v)),this.cmi.success_status&&("passed"===this.cmi.success_status?a=m:"failed"===this.cmi.success_status&&(a=g));const c=this.cmi?.score?.getScoreObject()||{},l={completionStatus:o,successStatus:a,totalTimeSeconds:n,runtimeData:i};return c&&(l.score=c),l}async storeData(t){t&&"normal"===this.cmi.mode&&"credit"===this.cmi.credit&&(this.cmi.completion_threshold&&this.cmi.progress_measure&&(this.cmi.completion_status=this.cmi.completion_threshold>this.cmi.progress_measure?"incomplete":"completed"),this.cmi.scaled_passing_score&&this.cmi.score.scaled&&(this.cmi.success_status=this.cmi.scaled_passing_score>this.cmi.score.scaled?"failed":"passed"));let i=!1;this.adl.nav.request!==this.startingData?.adl?.nav?.request&&"_none_"!==this.adl.nav.request&&(i=!0);const s=this.getCommitObject(t);if("string"==typeof this.settings.lmsCommitUrl){const result=await this.processHttpRequest(this.settings.lmsCommitUrl,s,t);return i&&void 0!==result.navRequest&&""!==result.navRequest&&"string"==typeof result.navRequest?Function(`"use strict";(() => { ${result.navRequest} })()`)():result?.navRequest&&!i&&"object"==typeof result.navRequest&&Object.hasOwnProperty.call(result.navRequest,"name")&&this.processListeners(result.navRequest.name,result.navRequest.data),result}return{result:e,errorCode:0}}configureSequencing(e){e.activityTree&&this.configureActivityTree(e.activityTree),e.sequencingRules&&this.configureSequencingRules(e.sequencingRules),e.sequencingControls&&this.configureSequencingControls(e.sequencingControls),e.rollupRules&&this.configureRollupRules(e.rollupRules)}configureActivityTree(e){const t=this.createActivity(e);this._sequencing.activityTree.root=t,this._extractedScoItemIds=this.extractActivityIds(t)}extractActivityIds(e){const t=[e.id];for(const i of e.children)t.push(...this.extractActivityIds(i));return t}createActivity(e){const t=new tt(e.id,e.title);if(void 0!==e.isVisible&&(t.isVisible=e.isVisible),void 0!==e.isActive&&(t.isActive=e.isActive),void 0!==e.isSuspended&&(t.isSuspended=e.isSuspended),void 0!==e.isCompleted&&(t.isCompleted=e.isCompleted),e.children)for(const i of e.children){const e=this.createActivity(i);t.addChild(e)}if(e.sequencingControls){const i=t.sequencingControls,s=e.sequencingControls;void 0!==s.enabled&&(i.enabled=s.enabled),void 0!==s.choiceExit&&(i.choiceExit=s.choiceExit),void 0!==s.flow&&(i.flow=s.flow),void 0!==s.forwardOnly&&(i.forwardOnly=s.forwardOnly),void 0!==s.useCurrentAttemptObjectiveInfo&&(i.useCurrentAttemptObjectiveInfo=s.useCurrentAttemptObjectiveInfo),void 0!==s.useCurrentAttemptProgressInfo&&(i.useCurrentAttemptProgressInfo=s.useCurrentAttemptProgressInfo),void 0!==s.preventActivation&&(i.preventActivation=s.preventActivation),void 0!==s.constrainChoice&&(i.constrainChoice=s.constrainChoice),void 0!==s.rollupObjectiveSatisfied&&(i.rollupObjectiveSatisfied=s.rollupObjectiveSatisfied),void 0!==s.rollupProgressCompletion&&(i.rollupProgressCompletion=s.rollupProgressCompletion),void 0!==s.objectiveMeasureWeight&&(i.objectiveMeasureWeight=s.objectiveMeasureWeight)}if(e.sequencingRules){const i=e.sequencingRules;if(i.preConditionRules)for(const e of i.preConditionRules){const i=this.createSequencingRule(e);t.sequencingRules.addPreConditionRule(i)}if(i.exitConditionRules)for(const e of i.exitConditionRules){const i=this.createSequencingRule(e);t.sequencingRules.addExitConditionRule(i)}if(i.postConditionRules)for(const e of i.postConditionRules){const i=this.createSequencingRule(e);t.sequencingRules.addPostConditionRule(i)}}if(e.rollupRules&&e.rollupRules.rules)for(const i of e.rollupRules.rules){const e=this.createRollupRule(i);t.rollupRules.addRule(e)}return t}configureSequencingRules(e){const t=this._sequencing.sequencingRules;if(e.preConditionRules)for(const i of e.preConditionRules){const e=this.createSequencingRule(i);t.addPreConditionRule(e)}if(e.exitConditionRules)for(const i of e.exitConditionRules){const e=this.createSequencingRule(i);t.addExitConditionRule(e)}if(e.postConditionRules)for(const i of e.postConditionRules){const e=this.createSequencingRule(i);t.addPostConditionRule(e)}}createSequencingRule(e){const t=new Ve(e.action,e.conditionCombination);for(const i of e.conditions){const e=new He(i.condition,i.operator,new Map(Object.entries(i.parameters||{})));t.addCondition(e)}return t}configureSequencingControls(e){const t=this._sequencing.sequencingControls;void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.choiceExit&&(t.choiceExit=e.choiceExit),void 0!==e.flow&&(t.flow=e.flow),void 0!==e.forwardOnly&&(t.forwardOnly=e.forwardOnly),void 0!==e.useCurrentAttemptObjectiveInfo&&(t.useCurrentAttemptObjectiveInfo=e.useCurrentAttemptObjectiveInfo),void 0!==e.useCurrentAttemptProgressInfo&&(t.useCurrentAttemptProgressInfo=e.useCurrentAttemptProgressInfo),void 0!==e.preventActivation&&(t.preventActivation=e.preventActivation),void 0!==e.constrainChoice&&(t.constrainChoice=e.constrainChoice),void 0!==e.rollupObjectiveSatisfied&&(t.rollupObjectiveSatisfied=e.rollupObjectiveSatisfied),void 0!==e.rollupProgressCompletion&&(t.rollupProgressCompletion=e.rollupProgressCompletion),void 0!==e.objectiveMeasureWeight&&(t.objectiveMeasureWeight=e.objectiveMeasureWeight)}configureRollupRules(e){const t=this._sequencing.rollupRules;if(e.rules)for(const i of e.rules){const e=this.createRollupRule(i);t.addRule(e)}}createRollupRule(e){const t=new We(e.action,e.consideration,e.minimumCount,e.minimumPercent);for(const i of e.conditions){const e=new Je(i.condition,new Map(Object.entries(i.parameters||{})));t.addCondition(e)}return t}initializeSequencingService(e){try{this._sequencingService=new _t(this._sequencing,this.cmi,this.adl,this.eventService||this,this.loggingService||console,{autoRollupOnCMIChange:e?.sequencing?.autoRollupOnCMIChange??!0,autoProgressOnCompletion:e?.sequencing?.autoProgressOnCompletion??!1,validateNavigationRequests:e?.sequencing?.validateNavigationRequests??!0,enableEventSystem:e?.sequencing?.enableEventSystem??!0,logLevel:e?.sequencing?.logLevel??"info"}),e?.sequencing?.eventListeners&&this._sequencingService.setEventListeners(e.sequencing.eventListeners)}catch(e){console.warn("Failed to initialize sequencing service:",e),this._sequencingService=null}}getSequencingService(){return this._sequencingService}setSequencingEventListeners(e){this._sequencingService&&this._sequencingService.setEventListeners(e)}updateSequencingConfiguration(e){this._sequencingService&&this._sequencingService.updateConfiguration(e)}getSequencingState(){return this._sequencingService?this._sequencingService.getSequencingState():{isInitialized:!1,isActive:!1,currentActivity:null,rootActivity:this._sequencing.getRootActivity(),lastSequencingResult:null}}processNavigationRequest(request,e){return!!this._sequencingService&&this._sequencingService.processNavigationRequest(request,e)}async saveSequencingState(e){if(!this.settings.sequencingStatePersistence)return this.apiLog("saveSequencingState","No persistence configuration provided",S.WARN),!1;try{const t=this.serializeSequencingState(),i={learnerId:this.cmi.learner_id||"unknown",courseId:this.settings.courseId||"unknown",attemptNumber:1,lastUpdated:(new Date).toISOString(),version:this.settings.sequencingStatePersistence.stateVersion||"1.0",...e},s=this.settings.sequencingStatePersistence;let n=t;if(!1!==s.compress&&(n=this.compressStateData(t)),s.maxStateSize&&n.length>s.maxStateSize)throw Error(`State size ${n.length} exceeds limit ${s.maxStateSize}`);const r=await s.persistence.saveState(n,i);return s.debugPersistence&&this.apiLog("saveSequencingState",`State save ${r?"succeeded":"failed"}: size=${n.length}`,r?S.INFO:S.WARN),r}catch(e){return this.apiLog("saveSequencingState","Error saving sequencing state: "+(e instanceof Error?e.message:e+""),S.ERROR),!1}}async loadSequencingState(e){if(!this.settings.sequencingStatePersistence)return this.apiLog("loadSequencingState","No persistence configuration provided",S.WARN),!1;try{const t={learnerId:this.cmi.learner_id||"unknown",courseId:this.settings.courseId||"unknown",attemptNumber:1,version:this.settings.sequencingStatePersistence.stateVersion||"1.0",...e},i=this.settings.sequencingStatePersistence,s=await i.persistence.loadState(t);if(!s)return i.debugPersistence&&this.apiLog("loadSequencingState","No sequencing state found to load",S.INFO),!1;let n=s;!1!==i.compress&&(n=this.decompressStateData(s));const r=this.deserializeSequencingState(n);return i.debugPersistence&&this.apiLog("loadSequencingState",`State load ${r?"succeeded":"failed"}: size=${s.length}`,r?S.INFO:S.WARN),r}catch(e){return this.apiLog("loadSequencingState","Error loading sequencing state: "+(e instanceof Error?e.message:e+""),S.ERROR),!1}}serializeSequencingState(){const e={version:this.settings.sequencingStatePersistence?.stateVersion||"1.0",timestamp:(new Date).toISOString(),sequencing:null,currentActivityId:null,globalObjectives:this._globalObjectives.map(e=>e.toJSON()),adlNavState:{request:this.adl.nav.request,request_valid:this.adl.nav.request_valid},contentDelivered:!1};if(this._sequencingService){const t=this._sequencingService.getOverallSequencingProcess();if(t){const i=t.getSequencingState();e.sequencing=i,e.contentDelivered=t.hasContentBeenDelivered()}const i=this._sequencing.getCurrentActivity();i&&(e.currentActivityId=i.id)}return JSON.stringify(e)}deserializeSequencingState(e){try{const t=JSON.parse(e),i=this.settings.sequencingStatePersistence?.stateVersion||"1.0";if(t.version!==i&&this.apiLog("deserializeSequencingState",`State version mismatch: ${t.version} vs expected ${i}`,S.WARN),t.sequencing&&this._sequencingService){const e=this._sequencingService.getOverallSequencingProcess();e&&(e.restoreSequencingState(t.sequencing),t.contentDelivered&&this.apiLog("deserializeSequencingState","Content delivery state restored",S.DEBUG))}return t.globalObjectives&&Array.isArray(t.globalObjectives)&&(this._globalObjectives=t.globalObjectives.map(e=>{const t=new we;return t.fromJSON?t.fromJSON(e):Object.assign(t,e),t})),t.adlNavState&&(this.adl.nav.request=t.adlNavState.request||"_none_",this.adl.nav.request_valid=t.adlNavState.request_valid||{}),!0}catch(e){return this.apiLog("deserializeSequencingState","Error deserializing sequencing state: "+(e instanceof Error?e.message:e+""),S.ERROR),!1}}compressStateData(e){return"undefined"!=typeof btoa?btoa(encodeURIComponent(e)):e}decompressStateData(e){if("undefined"!=typeof atob)try{return decodeURIComponent(atob(e))}catch{return e}return e}}}();
//# sourceMappingURL=scorm2004.min.js.map
