!function(t){"use strict";class e{constructor(t,e){this._targetOrigin="*",this._api=t,e&&(this._targetOrigin=e),window.addEventListener("message",this._handleMessage.bind(this)),this._setupEventForwarding()}_handleMessage(t){const e=t.data;e&&e.messageId&&e.method&&this._processMessage(e,t.source,t.origin)}_processMessage(t,e,s){const{messageId:r,method:i,params:n,sab:a}=t;let o,h;try{if("function"!=typeof this._api[i])throw Error(`Method ${i} not found on API`);o=this._api[i](...n)}catch(t){h=t instanceof Error?{message:t.message,stack:t.stack}:{message:t+""}}e.postMessage({messageId:r,result:o,error:h,sab:a},this._targetOrigin,a?[a]:void 0)}_setupEventForwarding(){var t=this;this._api.on("*",(function(e){for(var s=arguments.length,r=Array(s>1?s-1:0),i=1;s>i;i++)r[i-1]=arguments[i];Array.from(document.querySelectorAll("iframe")).forEach((s=>{s.contentWindow&&s.contentWindow.postMessage({event:e,args:r},t._targetOrigin)}))}))}}class s{constructor(t){this._targetOrigin="*",this._pendingRequests=new Map,this._eventListeners=new Map,this._messageIdCounter=0,this._childFrames=new Set,this._isInitialized=!1,this._lastError="0",this._cache=new Map,this._sabBuffers=new Map,t&&(this._targetOrigin=t),window.addEventListener("message",this._handleMessage.bind(this))}_syncCall(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;try{const r=new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT),i=new Int32Array(r),n=`${Date.now()}-sync-${this._messageIdCounter++}`;this._sabBuffers.set(n,r),window.parent.postMessage({messageId:n,method:t,params:e,sab:r},this._targetOrigin,[r]);const a=Atomics.wait(i,0,0,s);this._sabBuffers.delete(n);const o=this._pendingRequests.get(n)||{};if(this._pendingRequests.delete(n),"timed-out"===a)throw Error(`SCORM ${t} timeout after ${s}ms`);if(o.error)throw o.error;return o.result}catch(t){throw t}}_handleMessage(t){const e=t.data,s=t.source,r=s!==window.parent&&s!==window;if(!e.messageId||void 0===e.result&&void 0===e.error||r||this._handleMethodResponse(e),e.messageId&&e.method&&r){this._childFrames.add(s);const{messageId:t,method:r,params:i}=e,n="forwarded-"+t;this._pendingRequests.set(n,{resolve:e=>{s.postMessage({messageId:t,result:e},this._targetOrigin)},reject:e=>{s.postMessage({messageId:t,error:e},this._targetOrigin)},source:s}),window.parent.postMessage({messageId:n,method:r,params:i},this._targetOrigin),setTimeout((()=>{if(this._pendingRequests.has(n)){const e=this._pendingRequests.get(n);this._pendingRequests.delete(n),e?.source&&e.source.postMessage({messageId:t,error:{message:"Timeout waiting for response to method "+r}},this._targetOrigin)}}),5e3)}e.event&&!r&&(this._handleEvent(e.event,...e.args||[]),this._forwardEventToChildFrames(e.event,e.args||[]))}_handleMethodResponse(t){const{messageId:e,result:s,error:r}=t;if(t.sab){const e=new Int32Array(t.sab);Atomics.store(e,0,1),Atomics.notify(e,0)}const i=this._pendingRequests.get(e);if(i){const{resolve:t,reject:n}=i;r?n(r):t(s),this._pendingRequests.delete(e)}}_handleEvent(t){for(var e=arguments.length,s=Array(e>1?e-1:0),r=1;e>r;r++)s[r-1]=arguments[r];const i=this._eventListeners.get(t);i&&i.forEach((e=>{try{e(...s)}catch(e){console.error(`Error in event listener for ${t}:`,e)}}));const n=this._eventListeners.get("*");n&&n.forEach((e=>{try{e(t,...s)}catch(e){console.error(`Error in "*" event listener for ${t}:`,e)}}))}_forwardEventToChildFrames(t,e){this._childFrames.forEach((s=>{try{s.postMessage({event:t,args:e},this._targetOrigin)}catch(t){console.error("Error forwarding event to child frame:",t)}}))}_sendMessage(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return"undefined"==typeof window||void 0===window.parent||"function"!=typeof window.parent.postMessage?Promise.resolve(""):new Promise(((s,r)=>{const i=`${Date.now()}-${this._messageIdCounter++}`;this._pendingRequests.set(i,{resolve:s,reject:r});try{window.parent.postMessage({messageId:i,method:t,params:e},this._targetOrigin),setTimeout((()=>{this._pendingRequests.has(i)&&(this._pendingRequests.delete(i),r(Error("Timeout waiting for response to method "+t)))}),5e3)}catch(t){this._pendingRequests.delete(i),r(t)}}))}async initialize(){const t=await this._sendMessage("lmsInitialize");return this._isInitialized="true"===t,this._isInitialized}lmsInitialize(){try{return this._syncCall("lmsInitialize",[])+""}catch(t){return this._lastError="101","false"}}async Initialize(){return this.initialize()}LMSInitialize(){try{return this._syncCall("LMSInitialize",[])+""}catch(t){return this._lastError="101","false"}}async terminate(){const t="true"===await this._sendMessage("lmsFinish");return t&&(this._isInitialized=!1),t}lmsFinish(){try{return this._syncCall("lmsFinish",[])+""}catch(t){return this._lastError="101","false"}}async Terminate(){return this.terminate()}LMSFinish(){try{return this._syncCall("LMSFinish",[])+""}catch(t){return this._lastError="101","false"}}async getValue(t){try{const e=await this._sendMessage("lmsGetValue",[t])+"";return this._cache.set(t,e),e}catch(e){return this._lastError="101",console.error(`Error in getValue(${t}):`,e),""}}lmsGetValue(t){try{return this._syncCall("lmsGetValue",[t])+""}catch(t){return this._lastError="101",""}}async GetValue(t){return this.getValue(t)}LMSGetValue(t){try{return this._syncCall("LMSGetValue",[t])+""}catch(t){return this._lastError="101",""}}async setValue(t,e){try{const s="true"===await this._sendMessage("lmsSetValue",[t,e]);return s&&this._cache.set(t,e+""),s}catch(s){return this._lastError="101",console.error(`Error in setValue(${t}, ${e}):`,s),!1}}lmsSetValue(t,e){try{return this._syncCall("lmsSetValue",[t,e])+""}catch(t){return this._lastError="101","false"}}async SetValue(t,e){return this.setValue(t,e)}LMSSetValue(t,e){try{return this._syncCall("LMSSetValue",[t,e])+""}catch(t){return this._lastError="101","false"}}async commit(){try{return"true"===await this._sendMessage("lmsCommit")}catch(t){return this._lastError="101",console.error("Error in commit:",t),!1}}lmsCommit(){try{return this._syncCall("lmsCommit",[])+""}catch(t){return this._lastError="101","false"}}async Commit(){return this.commit()}LMSCommit(){try{return this._syncCall("LMSCommit",[])+""}catch(t){return this._lastError="101","false"}}async getLastError(){try{const t=await this._sendMessage("lmsGetLastError");return this._lastError=t+"",this._lastError}catch(t){return console.error("Error in getLastError:",t),"101"}}lmsGetLastError(){try{return this._syncCall("lmsGetLastError",[])+""}catch(t){return"101"}}async GetLastError(){return this.getLastError()}LMSGetLastError(){try{return this._syncCall("LMSGetLastError",[])+""}catch(t){return"101"}}async getErrorString(t){try{const e=await this._sendMessage("lmsGetErrorString",[t])+"";return this._cache.set("error_"+t,e),e}catch(e){return console.error(`Error in getErrorString(${t}):`,e),""}}lmsGetErrorString(t){try{return this._syncCall("lmsGetErrorString",[t])+""}catch(t){return"No error"}}async GetErrorString(t){return this.getErrorString(t)}LMSGetErrorString(t){try{return this._syncCall("LMSGetErrorString",[t])+""}catch(t){return"No error"}}async getDiagnostic(t){try{const e=await this._sendMessage("lmsGetDiagnostic",[t])+"";return this._cache.set("diagnostic_"+t,e),e}catch(e){return console.error(`Error in getDiagnostic(${t}):`,e),""}}lmsGetDiagnostic(t){try{return this._syncCall("lmsGetDiagnostic",[t])+""}catch(t){return"No diagnostic information available"}}async GetDiagnostic(t){return this.getDiagnostic(t)}LMSGetDiagnostic(t){try{return this._syncCall("LMSGetDiagnostic",[t])+""}catch(t){return"No diagnostic information available"}}async isInitialized(){try{const t=await this._sendMessage("isInitialized");return this._isInitialized=!!t,this._isInitialized}catch(t){return console.error("Error in isInitialized:",t),this._isInitialized}}getIsInitialized(){return this._isInitialized}on(t,e){this._eventListeners.has(t)||this._eventListeners.set(t,new Set);const s=this._eventListeners.get(t);s&&s.add(e)}off(t,e){const s=this._eventListeners.get(t);s&&(s.delete(e),0===s.size&&this._eventListeners.delete(t))}}t.CrossFrameAPI=s,t.CrossFrameLMS=e,t.createCrossFrameClient=function(t){return new s(t)},t.createCrossFrameServer=function(t,s){return new e(t,s)}}(this["cross-frame-facade"]=this["cross-frame-facade"]||{});
//# sourceMappingURL=cross-frame-facade.min.js.map
