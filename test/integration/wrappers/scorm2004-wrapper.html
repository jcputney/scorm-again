<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCORM 2004 Wrapper</title>
  <script src="/dist/scorm2004.js"></script>
  <script>
    const sequencingDefaults = {
      hideLmsUi: ["exitAll", "abandonAll"],
      auxiliaryResources: [
        {resourceId: "urn:scorm-again:help", purpose: "help"},
        {resourceId: "urn:scorm-again:glossary", purpose: "glossary"},
      ],
    };

    const navRequestMap = {
      continue: "_continue",
      previous: "_previous",
      exit: "_exit",
      exitAll: "_exitAll",
      abandon: "_abandon",
      abandonAll: "_abandonAll",
      suspendAll: "_suspendAll",
    };

    const navMap = new Map();
    let lastNavigationPayload = {
      hideLmsUi: sequencingDefaults.hideLmsUi,
      auxiliaryResources: sequencingDefaults.auxiliaryResources,
    };

    // Initialize the SCORM 2004 API
    window.API_1484_11 = new Scorm2004API({
      autocommit: true,
      logLevel: 1,
      mastery_override: false,
      sequencing: sequencingDefaults,
    });

    window.API_1484_11.loadFromJSON({
      cmi: {
        learner_id: "123456",
        learner_name: "John Doe",
        completion_status: "not attempted",
        entry: "ab-initio",
        credit: "credit",
        exit: "time-out",
        score: {
          raw: 0,
          min: 0,
          max: 100,
        },
        time_limit_action: "exit,message",
        max_time_allowed: "PT1H",
        objectives: [
          {
            id: "obj_playing",
            score: {
              raw: 0,
              min: 0,
              max: 100,
            },
          },
        ],
      },
    });

    function refreshNavMap() {
      navMap.clear();
      document.querySelectorAll('[data-directive]').forEach((button) => {
        const directive = button.getAttribute('data-directive');
        if (directive) {
          navMap.set(directive, button);
        }
      });
    }

    function bindNavigationHandlers() {
      navMap.forEach((button) => {
        button.addEventListener('click', requestNavigation);
      });
    }

    function requestNavigation(event) {
      const button = event.currentTarget;
      const directive = button && typeof button.getAttribute === 'function' ? button.getAttribute('data-directive') : null;
      if (!directive) return;
      const navRequest = navRequestMap[directive];
      if (!navRequest) return;
      window.API_1484_11.SetValue("adl.nav.request", navRequest);
      window.API_1484_11.Commit("");
    }

    function computeAuxiliaryResources(payload) {
      const merged = new Map();
      const addAll = (resources) => {
        if (!Array.isArray(resources)) {
          return;
        }
        for (const resource of resources) {
          if (!resource) continue;
          const resourceId = typeof resource.resourceId === 'string' ? resource.resourceId.trim() : '';
          const purpose = typeof resource.purpose === 'string' ? resource.purpose.trim() : '';
          if (!resourceId || merged.has(resourceId)) {
            continue;
          }
          merged.set(resourceId, {resourceId, purpose});
        }
      };

      addAll(sequencingDefaults.auxiliaryResources);
      addAll(payload?.auxiliaryResources);

      return Array.from(merged.values());
    }

    function isSequencingAvailable() {
      // Check if sequencing is available by checking if sequencing service exists
      // and if there's an activity tree configured
      if (!window.API_1484_11) {
        return false;
      }
      const sequencingService = window.API_1484_11.getSequencingService();
      if (!sequencingService) {
        return false;
      }
      // Check if activity tree has a root (sequencing is configured)
      const sequencingState = window.API_1484_11.getSequencingState();
      // Sequencing is available if there's a root activity (hasActivityTree check)
      return sequencingState && sequencingState.rootActivity !== null;
    }

    function applyNavigationState(update = {}) {
      lastNavigationPayload = {
        ...lastNavigationPayload,
        ...update,
        hideLmsUi: update.hideLmsUi ?? lastNavigationPayload.hideLmsUi,
        auxiliaryResources: update.auxiliaryResources ?? lastNavigationPayload.auxiliaryResources,
      };
      const payload = lastNavigationPayload;

      // Check if sequencing is available - if not, hide all navigation buttons
      const sequencingAvailable = isSequencingAvailable();

      const hidden = new Set(sequencingDefaults.hideLmsUi ?? []);
      if (Array.isArray(payload.hideLmsUi)) {
        for (const directive of payload.hideLmsUi) {
          if (typeof directive === 'string') {
            hidden.add(directive);
          }
        }
      }

      // If sequencing is not available, hide all navigation buttons
      if (!sequencingAvailable) {
        navMap.forEach((button) => {
          button.classList.add('is-hidden');
          button.hidden = true;
          button.setAttribute('aria-hidden', 'true');
          button.tabIndex = -1;
          button.disabled = true;
        });
      } else {
        // Sequencing is available - apply normal visibility rules
        navMap.forEach((button, directive) => {
          const shouldHide = hidden.has(directive);
          button.classList.toggle('is-hidden', shouldHide);
          button.hidden = shouldHide;
          button.setAttribute('aria-hidden', shouldHide ? 'true' : 'false');
          button.tabIndex = shouldHide ? -1 : 0;
        });

        const continueButton = navMap.get('continue');
        if (continueButton) {
          const canContinue = payload.continue;
          const shouldDisable = canContinue === false || canContinue === 'false';
          continueButton.disabled = shouldDisable;
        }

        const previousButton = navMap.get('previous');
        if (previousButton) {
          const canPrevious = payload.previous;
          const shouldDisable = canPrevious === false || canPrevious === 'false';
          previousButton.disabled = shouldDisable;
        }
      }

      const hideList = document.getElementById('hide-directives');
      if (hideList) {
        hideList.textContent = hidden.size ? Array.from(hidden).join(', ') : 'none';
      }

      const auxiliaryResources = computeAuxiliaryResources(payload);
      const auxList = document.getElementById('aux-resources');
      if (auxList) {
        auxList.innerHTML = '';
        if (auxiliaryResources.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'None';
          auxList.appendChild(li);
        } else {
          auxiliaryResources.forEach(({resourceId, purpose}) => {
            const li = document.createElement('li');
            const label = purpose ? `${purpose}` : 'resource';
            li.textContent = `${label}: ${resourceId}`;
            auxList.appendChild(li);
          });
        }
      }
    }

    // Resource map: maps activity identifierref to resource URLs
    // In a real LMS, this would be built from the manifest
    const resourceMap = new Map();

    // Function to build resource URL from activity
    // In a real LMS, this would look up the resource in the manifest
    function getResourceUrl(activity) {
      if (!activity) return null;

      // Try to get identifierref from activity metadata or settings
      // For test modules, we'll construct URLs based on common patterns
      const activityId = activity.id || '';
      const identifierref = activity.identifierref || activity.resourceId || null;
      const parameters = activity.parameters || '';

      // If we have a resource map entry, use it
      if (identifierref && resourceMap.has(identifierref)) {
        const baseUrl = resourceMap.get(identifierref);
        return parameters ? baseUrl + parameters : baseUrl;
      }

      // For test modules, construct URL based on activity ID patterns
      // This is a fallback for test environments
      if (activityId.includes('playing')) {
        return '/test/integration/modules/' + getModuleBasePath() + '/shared/launchpage.html?content=playing';
      } else if (activityId.includes('etiquette') || activityId.includes('etuqiette')) {
        return '/test/integration/modules/' + getModuleBasePath() + '/shared/launchpage.html?content=etiquette';
      } else if (activityId.includes('handicapping')) {
        return '/test/integration/modules/' + getModuleBasePath() + '/shared/launchpage.html?content=handicapping';
      } else if (activityId.includes('havingfun')) {
        return '/test/integration/modules/' + getModuleBasePath() + '/shared/launchpage.html?content=havingfun';
      } else if (activityId.includes('test') || activityId.includes('assessment')) {
        const testNum = activityId.match(/\d+/);
        const contentParam = testNum ? '?content=assessment' + testNum[0] : '?content=assessment';
        return '/test/integration/modules/' + getModuleBasePath() + '/shared/launchpage.html' + (parameters || contentParam);
      }

      return null;
    }

    // Extract module base path from current module URL
    function getModuleBasePath() {
      const modulePath = getModulePath();
      if (!modulePath) return '';
      // Extract path up to the module directory
      // e.g., /test/integration/modules/SequencingForcedSequential_SCORM20043rdEdition/shared/launchpage.html
      // -> SequencingForcedSequential_SCORM20043rdEdition
      const match = modulePath.match(/\/modules\/([^\/]+)/);
      return match ? match[1] : '';
    }

    window.API_1484_11.setSequencingEventListeners({
      onNavigationValidityUpdate: applyNavigationState,
      onActivityDelivery: (activity) => {
        applyNavigationState({
          hideLmsUi: activity?.hideLmsUi,
          auxiliaryResources: activity?.auxiliaryResources,
        });

        // Load new SCO content when activity is delivered
        // This is what a real LMS would do
        if (activity && activity.id) {
          const resourceUrl = getResourceUrl(activity);
          if (resourceUrl) {
            // Reset the API before loading new SCO
            // This resets SCO-specific data while preserving global objectives
            // The reset() method is designed for transitioning between SCOs
            if (window.API_1484_11 && typeof window.API_1484_11.reset === 'function') {
              window.API_1484_11.reset();
            }
            
            const moduleFrame = document.getElementById('moduleFrame');
            if (moduleFrame) {
              // Load the new SCO content
              moduleFrame.src = resourceUrl;
            }
          }
        }
      },
    });

    window.addEventListener('DOMContentLoaded', () => {
      refreshNavMap();
      bindNavigationHandlers();

      // Apply initial navigation state after API is ready
      // For non-sequenced modules, this will hide navigation buttons
      setTimeout(() => {
        applyNavigationState();
      }, 100);

      const modulePath = getModulePath();
      if (modulePath) {
        loadModule(modulePath);
      } else {
        document.getElementById('error').textContent = 'No module specified. Use ?module=path/to/module.html';
      }
    });

    function loadModule(modulePath) {
      document.getElementById('moduleFrame').src = modulePath;
    }

    function getModulePath() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('module') || '';
    }
  </script>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    header {
      padding: 12px 16px;
      background: #0b3d91;
      color: #fff;
    }

    #lmsUi {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: #f2f6ff;
      border-bottom: 1px solid #d4defd;
      align-items: center;
    }

    #lmsUi button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #0b3d91;
      background: #fff;
      color: #0b3d91;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    #lmsUi button:disabled {
      border-color: #9fb4d9;
      color: #9fb4d9;
      cursor: not-allowed;
    }

    #lmsUi button:not(:disabled):hover {
      background: #0b3d91;
      color: #fff;
    }

    #lmsUi button.is-hidden {
      display: none;
    }

    #hide-directives {
      margin-left: auto;
      font-size: 12px;
      color: #0b3d91;
    }

    #auxiliary-resources {
      padding: 12px 16px;
      background: #f8faff;
      border-bottom: 1px solid #d4defd;
    }

    #auxiliary-resources h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #0b3d91;
    }

    #aux-resources {
      margin: 0;
      padding-left: 20px;
      color: #0b3d91;
    }

    #moduleFrame {
      width: 100%;
      flex: 1;
      border: none;
      padding: 0;
      margin: 0;
    }

    #error {
      padding: 12px 16px 24px;
      color: #a94442;
      font-weight: 600;
      background: #f9dede;
      border-top: 1px solid #f2bcbc;
    }
  </style>
</head>
<body>
<header>
  <h1>SCORM 2004 Wrapper</h1>
</header>
<div id="lmsUi">
  <button type="button" data-directive="continue">Continue</button>
  <button type="button" data-directive="previous">Previous</button>
  <button type="button" data-directive="exit">Exit</button>
  <button type="button" data-directive="exitAll" aria-hidden="true" hidden>Exit All</button>
  <button type="button" data-directive="abandon">Abandon</button>
  <button type="button" data-directive="abandonAll" aria-hidden="true" hidden>Abandon All</button>
  <button type="button" data-directive="suspendAll">Suspend All</button>
  <span id="hide-directives" aria-live="polite">exitAll, abandonAll</span>
</div>
<section id="auxiliary-resources">
  <h2>Auxiliary Resources</h2>
  <ul id="aux-resources" aria-live="polite">
    <li>help: urn:scorm-again:help</li>
    <li>glossary: urn:scorm-again:glossary</li>
  </ul>
</section>
<iframe id="moduleFrame" title="SCORM Module"></iframe>
<div id="error"></div>
</body>
</html>
